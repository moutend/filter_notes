<!doctype html><html><head><meta charset='utf-8'>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.4.1/github-markdown.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/styles/default.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.8.3/katex.min.css">
<link rel="stylesheet" href="https://gitcdn.xyz/repo/goessner/mdmath/master/css/texmath.css">
<link rel="stylesheet" href="https://gitcdn.xyz/repo/goessner/mdmath/master/css/vscode-texmath.css">

</head><body class="markdown-body">
<style>
body {
  max-width: 704px;
  margin: auto;
  padding: 32px 8px;
}

code {
  overflow-x: scroll;
  overflow-y: hidden;
  white-space: pre;
}

.katex {
  font-size: 1.3em !important;
}
</style>
<h1 data-line="18" class="code-line" id="dr-110%E9%A2%A8%E3%81%AE%E3%82%B7%E3%83%B3%E3%83%90%E3%83%AB">DR-110風のシンバル</h1>
<p data-line="19" class="code-line"><a href="https://www.youtube.com/watch?v=-ap0ucC6QBU">DR-110</a>のシンバルに似た音を作ります。</p>
<p data-line="21" class="code-line">次のリンクから完成したコードを読むことができます。</p>
<ul>
<li data-line="23" class="code-line"><a href="https://github.com/ryukau/filter_notes/tree/master/docs/demo/dr110_cymbal">コードを見る (github.com)</a></li>
</ul>
<p data-line="25" class="code-line">コードを実行するには<a href="https://www.python.org/">Python3</a>と以下のライブラリが必要です。</p>
<ul>
<li data-line="27" class="code-line"><a href="https://www.scipy.org/">SciPy</a></li>
<li data-line="28" class="code-line"><a href="http://www.numpy.org/">NumPy</a></li>
<li data-line="29" class="code-line"><a href="https://matplotlib.org/">Matplotlib</a></li>
<li data-line="30" class="code-line"><a href="https://hgomersall.github.io/pyFFTW/">pyFFTW</a></li>
<li data-line="31" class="code-line"><a href="http://pysoundfile.readthedocs.io/en/0.9.0/">PySoundFile</a></li>
</ul>
<h2 data-line="33" class="code-line" id="%E5%9B%9E%E8%B7%AF%E5%9B%B3%E3%81%AE%E5%85%A5%E6%89%8B">回路図の入手</h2>
<p data-line="34" class="code-line"><a href="http://www.theninhotline.net/dr110/">The Boss DR-110 Dr Rhythm Graphic Information Homepage</a> の Schematics から回路図をダウンロードできます。</p>
<p data-line="36" class="code-line"><a href="http://www.sdiy.org/richardc64/new_drums/dr110/dr110a1.html">richardc64のDR-110のページ</a>に回路図の解説があります。</p>
<h2 data-line="38" class="code-line" id="%E4%BF%A1%E5%8F%B7%E3%81%AE%E6%B5%81%E3%82%8C">信号の流れ</h2>
<p data-line="39" class="code-line">DR-110のシンバルはオシレータから出た信号を High Metal と Low Metal の2つに分けて、それぞれでフィルタとエンベロープをかけてから足し合わせることで合成されます。High Metal と Low Metal という呼び方は<a href="http://www.sdiy.org/richardc64/new_drums/dr110/dr110a1.html">richardc64のDR-110のページ</a>にならっています。</p>
<p data-line="41" class="code-line">今回実装したプログラムの信号の流れです。</p>
<figure>
<img src="img/dr110_cymbal/DR-110.svg" alt="Image of signal flow of DR-110 cymbal." style="width: 720px; padding-bottom: 12px;"/>
</figure>
<h2 data-line="47" class="code-line" id="%E3%82%AA%E3%82%B7%E3%83%AC%E3%83%BC%E3%82%BF">オシレータ</h2>
<p data-line="48" class="code-line">4つの矩形波と1つのノイズを足し合わせます。音量の比率は、矩形波がそれぞれ1、ノイズは0.3です。回路図では矩形波の周波数に317、465、820、1150[Hz]が使われています。</p>
<figure>
<img src="img/dr110_cymbal/DR-110_osc.svg" alt="Image of signal flow of DR-110 cymbal oscillator." style="width: 360px; padding-bottom: 12px;"/>
</figure>
<p data-line="54" class="code-line">そのまま実装すると味気ない音になるので、オシレータの位相を進める時にノイズを加えて周波数を揺らしています。音量の比率も少しだけランダマイズしています。</p>
<pre><code data-line="56" class="code-line language-python"><div><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> soundfile
<span class="hljs-keyword">import</span> scipy.signal <span class="hljs-keyword">as</span> signal

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">normalize</span><span class="hljs-params">(data, peak=<span class="hljs-number">1.0</span>)</span>:</span>
    <span class="hljs-keyword">return</span> peak * data / np.abs(np.max(data))


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">pulse</span><span class="hljs-params">(time, frequency)</span>:</span>
    noise = np.power(<span class="hljs-number">10</span>, -(np.random.uniform(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>, len(time)) + <span class="hljs-number">5</span>))
    <span class="hljs-keyword">return</span> signal.square(<span class="hljs-number">2</span> * np.pi * frequency * (time + noise))


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">noise</span><span class="hljs-params">(size)</span>:</span>
    <span class="hljs-keyword">return</span> np.random.uniform(<span class="hljs-number">-1</span>, <span class="hljs-number">1</span>, size)


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">randomAmp</span><span class="hljs-params">(low, high)</span>:</span>
    lowLog = np.log(low)
    diffLog = np.log(high) - lowLog
    <span class="hljs-keyword">return</span> np.exp(lowLog + diffLog * np.random.random())


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">cymbalSource</span><span class="hljs-params">(time, pulseFreq=[<span class="hljs-number">317</span>, <span class="hljs-number">465</span>, <span class="hljs-number">820</span>, <span class="hljs-number">1150</span>])</span>:</span>
    sig = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> freq <span class="hljs-keyword">in</span> pulseFreq:
        sig += randomAmp(<span class="hljs-number">0.999</span>, <span class="hljs-number">1</span>) * pulse(time, freq)
    <span class="hljs-keyword">return</span> sig + noise(len(time)) / <span class="hljs-number">3.3</span>


samplerate = <span class="hljs-number">44100</span>
duration = <span class="hljs-number">2.0</span>

time = np.linspace(<span class="hljs-number">0</span>, duration, int(samplerate * duration), endpoint=<span class="hljs-keyword">False</span>)
sig = normalize(cymbalSource(time))

soundfile.write(<span class="hljs-string">"cymbal_source.wav"</span>, sig, samplerate)
</div></code></pre>
<h2 data-line="96" class="code-line" id="%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF">フィルタ</h2>
<p data-line="97" class="code-line"><a href="https://ccrma.stanford.edu/~jos/filters/Transfer_Function.html">伝達関数</a>を使ってDR-110の回路図から離散フィルタを設計します。</p>
<h3 data-line="99" class="code-line" id="%E3%83%90%E3%83%B3%E3%83%89%E3%83%91%E3%82%B9%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF">バンドパスフィルタ</h3>
<p data-line="100" class="code-line">オシレータセクションで使われているバンドパスフィルタです。BP0とBP1という名前はこの文章で区別するためにつけました。</p>
<figure>
<img src="img/dr110_cymbal/osc_crop.png" alt="Image of oscillator section of DR-110 schematic." style="width: 480px; padding-bottom: 12px;"/>
</figure>
<p data-line="106" class="code-line">単位の無い<a href="https://en.wikipedia.org/wiki/Capacitor">キャパシタ</a>の値は、上位2桁が有効数字、下位1桁が10の指数で、単位は[<a href="https://en.wikipedia.org/wiki/Pico-">p</a><a href="https://en.wikipedia.org/wiki/Farad">F</a>]です。</p>
<ul>
<li data-line="108" class="code-line">102 なら (10) * 10^(2) pF</li>
<li data-line="109" class="code-line">333 なら (33) * 10^(3) pF</li>
</ul>
<p data-line="111" class="code-line">バンドパスフィルタの部分だけを抜き出した図です。このフィルタは2つのネットワークが組み合わさっています。</p>
<figure>
<img src="img/dr110_cymbal/dr110_bp0.svg" alt="Image of DR-110 band-pass filter schematic." style="width: 480px; padding-bottom: 12px;"/>
</figure>
<p data-line="117" class="code-line">伝達関数 <eq><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>H</mi></mrow><annotation encoding="application/x-tex">H</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base"><span class="mord mathit" style="margin-right:0.08125em;">H</span></span></span></span></eq> です。 <eq><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>G</mi></mrow><annotation encoding="application/x-tex">G</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base"><span class="mord mathit">G</span></span></span></span></eq> は抵抗の値で単位は <a href="https://en.wikipedia.org/wiki/Siemens_(unit)">[℧] (mho) あるいは [S] (siemens)</a> 、 <eq><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>C</mi></mrow><annotation encoding="application/x-tex">C</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base"><span class="mord mathit" style="margin-right:0.07153em;">C</span></span></span></span></eq> はキャパシタの値で単位は <a href="https://en.wikipedia.org/wiki/Farad">[F] (ファラド)</a> です。</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mtable><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>H</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mo>−</mo><mfrac><mrow><msub><mi>y</mi><mi>a</mi></msub></mrow><mrow><msub><mi>y</mi><mi>b</mi></msub></mrow></mfrac></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><msub><mi>y</mi><mi>a</mi></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mo>−</mo><mfrac><mrow><mi>G</mi><mi>s</mi></mrow><mrow><mi>s</mi><mo>+</mo><mi>G</mi><mi mathvariant="normal">/</mi><mi>C</mi></mrow></mfrac></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><msub><mi>y</mi><mi>b</mi></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mo>−</mo><mi>k</mi><mfrac><mrow><msup><mi>s</mi><mn>2</mn></msup><mo>+</mo><msub><mi>b</mi><mn>0</mn></msub><mi>s</mi><mo>+</mo><msub><mi>c</mi><mn>0</mn></msub></mrow><mrow><mi>s</mi><mo>+</mo><msub><mi>a</mi><mn>0</mn></msub></mrow></mfrac></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><msub><mi>a</mi><mn>0</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><mrow><msub><mi>G</mi><mn>2</mn></msub></mrow><mrow><msub><mi>C</mi><mn>1</mn></msub><mo>+</mo><msub><mi>C</mi><mn>2</mn></msub></mrow></mfrac><mo separator="true">,</mo><mspace width="1em"></mspace><msub><mi>b</mi><mn>0</mn></msub><mo>=</mo><mfrac><mrow><msub><mi>G</mi><mn>1</mn></msub><mo>(</mo><msub><mi>C</mi><mn>1</mn></msub><mo>+</mo><msub><mi>C</mi><mn>2</mn></msub><mo>)</mo></mrow><mrow><msub><mi>C</mi><mn>1</mn></msub><msub><mi>C</mi><mn>2</mn></msub></mrow></mfrac><mo separator="true">,</mo><mspace width="1em"></mspace><msub><mi>c</mi><mn>0</mn></msub><mo>=</mo><mfrac><mrow><msub><mi>G</mi><mn>1</mn></msub><msub><mi>G</mi><mn>2</mn></msub></mrow><mrow><msub><mi>C</mi><mn>1</mn></msub><msub><mi>C</mi><mn>2</mn></msub></mrow></mfrac><mo separator="true">,</mo><mspace width="1em"></mspace><mi>k</mi><mo>=</mo><mfrac><mrow><msub><mi>C</mi><mn>1</mn></msub><msub><mi>C</mi><mn>2</mn></msub></mrow><mrow><msub><mi>C</mi><mn>1</mn></msub><mo>+</mo><msub><mi>C</mi><mn>2</mn></msub></mrow></mfrac></mrow></mstyle></mtd></mtr></mtable></mrow><annotation encoding="application/x-tex">
\begin{aligned}
H &amp;= -\frac{y_a}{y_b}\\

y_a &amp;= - \frac{Gs}{s + G / C}\\
y_b &amp;= - k \frac{s^2 + b_0 s + c_0}{s + a_0}\\

a_0 &amp;= \frac{G_2}{C_1 + C_2},\quad
b_0 = \frac{G_1 (C_1 + C_2)}{C_1 C_2},\quad
c_0 = \frac{G_1 G_2}{C_1 C_2},\quad
k =  \frac{C_1 C_2}{C_1 + C_2}\\
\end{aligned}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:5.287219em;"></span><span class="strut bottom" style="height:10.074438em;vertical-align:-4.787219em;"></span><span class="base"><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:5.287219em;"><span style="top:-7.670767000000001em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"><span class="mord mathit" style="margin-right:0.08125em;">H</span></span></span><span style="top:-5.129997em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span></span></span><span style="top:-2.4028890000000005em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight">b</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span></span></span><span style="top:0.16011100000000011em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"><span class="mord"><span class="mord mathit">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:4.787219em;"></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:5.287219em;"><span style="top:-7.670767000000001em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"><span class="mord"></span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mord">−</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.10756em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight">b</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span></span></span><span style="top:-3.15em;"><span class="pstrut" style="height:3em;"></span><span class="stretchy" style="height:0.2em;"><svg width='400em' height='0.2em' viewBox='0 0 400000 200' preserveAspectRatio='xMinYMin slice'><path d='M0 80H400000 v40H0z M0 80H400000 v40H0z'/></svg></span></span><span style="top:-3.6770000000000005em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8804400000000001em;"></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-5.129997em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"><span class="mord"></span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mord">−</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit">s</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mord mathit">G</span><span class="mord">/</span><span class="mord mathit" style="margin-right:0.07153em;">C</span></span></span><span style="top:-3.15em;"><span class="pstrut" style="height:3em;"></span><span class="stretchy" style="height:0.2em;"><svg width='400em' height='0.2em' viewBox='0 0 400000 200' preserveAspectRatio='xMinYMin slice'><path d='M0 80H400000 v40H0z M0 80H400000 v40H0z'/></svg></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit">G</span><span class="mord mathit">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-2.4028890000000005em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"><span class="mord"></span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mord">−</span><span class="mord mathit" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.491108em;"><span style="top:-2.3139999999999996em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit">s</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathit">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span></span></span><span style="top:-3.15em;"><span class="pstrut" style="height:3em;"></span><span class="stretchy" style="height:0.2em;"><svg width='400em' height='0.2em' viewBox='0 0 400000 200' preserveAspectRatio='xMinYMin slice'><path d='M0 80H400000 v40H0z M0 80H400000 v40H0z'/></svg></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathit">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathit">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mord mathit">s</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathit">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8360000000000001em;"></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:0.16011100000000011em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"><span class="mord"></span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.3139999999999996em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathit" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathit" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span></span></span><span style="top:-3.15em;"><span class="pstrut" style="height:3em;"></span><span class="stretchy" style="height:0.2em;"><svg width='400em' height='0.2em' viewBox='0 0 400000 200' preserveAspectRatio='xMinYMin slice'><path d='M0 80H400000 v40H0z M0 80H400000 v40H0z'/></svg></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathit">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8360000000000001em;"></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mpunct">,</span><span class="mord rule" style="margin-right:0.16666666666666666em;"></span><span class="mspace quad"></span><span class="mord"><span class="mord mathit">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.3139999999999996em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathit" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mord"><span class="mord mathit" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span></span></span><span style="top:-3.15em;"><span class="pstrut" style="height:3em;"></span><span class="stretchy" style="height:0.2em;"><svg width='400em' height='0.2em' viewBox='0 0 400000 200' preserveAspectRatio='xMinYMin slice'><path d='M0 80H400000 v40H0z M0 80H400000 v40H0z'/></svg></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathit">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathit" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathit" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8360000000000001em;"></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mpunct">,</span><span class="mord rule" style="margin-right:0.16666666666666666em;"></span><span class="mspace quad"></span><span class="mord"><span class="mord mathit">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.3139999999999996em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathit" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mord"><span class="mord mathit" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span></span></span><span style="top:-3.15em;"><span class="pstrut" style="height:3em;"></span><span class="stretchy" style="height:0.2em;"><svg width='400em' height='0.2em' viewBox='0 0 400000 200' preserveAspectRatio='xMinYMin slice'><path d='M0 80H400000 v40H0z M0 80H400000 v40H0z'/></svg></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathit">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mord"><span class="mord mathit">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8360000000000001em;"></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mpunct">,</span><span class="mord rule" style="margin-right:0.16666666666666666em;"></span><span class="mspace quad"></span><span class="mord mathit" style="margin-right:0.03148em;">k</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.3139999999999996em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathit" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathit" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span></span></span><span style="top:-3.15em;"><span class="pstrut" style="height:3em;"></span><span class="stretchy" style="height:0.2em;"><svg width='400em' height='0.2em' viewBox='0 0 400000 200' preserveAspectRatio='xMinYMin slice'><path d='M0 80H400000 v40H0z M0 80H400000 v40H0z'/></svg></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathit" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mord"><span class="mord mathit" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8360000000000001em;"></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:4.787219em;"></span></span></span></span></span></span></span></span></span></span></eqn></section><p data-line="133" class="code-line">伝達関数の式は以下を参考にしました。</p>
<ul>
<li data-line="135" class="code-line">電子回路、山本 外史、1994、第11刷、p.145</li>
<li data-line="136" class="code-line"><a href="http://www.ti.com/lit/an/sboa093a/sboa093a.pdf">&quot;Handbook of Operational Amplifier Active RC Networks&quot; - sboa093a.pdf</a>、p.14</li>
</ul>
<p data-line="138" class="code-line"><a href="http://maxima.sourceforge.net/">Maxima</a>で解きます。 例としてBP0の抵抗とキャパシタの値を使っています。</p>
<pre><code data-line="140" class="code-line language-maxima"><div>pico: <span class="hljs-number">10</span>**-<span class="hljs-number">12</span>;

G: <span class="hljs-number">1</span> / <span class="hljs-number">22000</span>;
C: <span class="hljs-number">10</span> * <span class="hljs-number">10</span>**<span class="hljs-number">2</span> * pico;

G_1: <span class="hljs-number">1</span> / <span class="hljs-number">82000</span>;
G_2: <span class="hljs-number">1</span> / <span class="hljs-number">560</span>;
C_1: <span class="hljs-number">33</span> * <span class="hljs-number">10</span>**<span class="hljs-number">2</span> * pico;
C_2: <span class="hljs-number">33</span> * <span class="hljs-number">10</span>**<span class="hljs-number">2</span> * pico;

a_0: G_2 / (C_1 + C_2);
b_0: G_1 * (C_1 + C_2) / (C_1 * C_2);
c_0: G_1 * G_2 / (C_1 * C_2);
k:  C_1 * C_2 /  (C_1 + C_2);
y_a: - G * s / (s + G / C);
y_b: - k * (s**<span class="hljs-number">2</span> + b_0 * s + c_0) / (s + a_0);

<span class="hljs-built_in">rat</span>(- y_a / y_b);
</div></code></pre>
<p data-line="161" class="code-line">出力です。</p>
<pre><code data-line="163" class="code-line language-maxima"><div><span class="hljs-comment">/* bp0 */</span>
-(<span class="hljs-number">94710000000</span>*s^<span class="hljs-number">2</span>+<span class="hljs-number">25625000000000000</span>*s)/(<span class="hljs-number">3437973</span>*s^<span class="hljs-number">3</span>+<span class="hljs-number">181681500000</span>*s^<span class="hljs-number">2</span>+<span class="hljs-number">8030000000000000</span>*s+<span class="hljs-number">312500000000000000000</span>)

<span class="hljs-comment">/* bp1 */</span>
-(<span class="hljs-number">268345000000</span>*s^<span class="hljs-number">2</span>+<span class="hljs-number">35234375000000000</span>*s)/(<span class="hljs-number">30108309</span>*s^<span class="hljs-number">3</span>+<span class="hljs-number">522707500000</span>*s^<span class="hljs-number">2</span>+<span class="hljs-number">15667187500000000</span>*s+<span class="hljs-number">195312500000000000000</span>)
</div></code></pre>
<p data-line="171" class="code-line">得られた値を <a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.signal.cont2discrete.html"><code>scipy.signal.cont2discrete</code></a> に渡すことで離散フィルタを設計できます。下のコードではMaximaで計算した値を <code>applyContinuousFilter</code> の <code>system</code> に渡しています。</p>
<pre><code data-line="173" class="code-line language-python"><div><span class="hljs-keyword">import</span> numpy
<span class="hljs-keyword">import</span> soundfile
<span class="hljs-keyword">import</span> scipy.signal <span class="hljs-keyword">as</span> signal


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">applyContinuousFilter</span><span class="hljs-params">(samplerate, source, system)</span>:</span>
    num, den, dt = signal.cont2discrete(system, <span class="hljs-number">1.0</span> / samplerate)
    <span class="hljs-keyword">return</span> signal.lfilter(num[<span class="hljs-number">0</span>], den, source)


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">highMetalFilter</span><span class="hljs-params">(samplerate, source)</span>:</span>
    <span class="hljs-keyword">return</span> applyContinuousFilter(samplerate, source, (
        [<span class="hljs-number">9.471e+10</span>, <span class="hljs-number">2.5625e+16</span>, <span class="hljs-number">0</span>],
        [<span class="hljs-number">3437973.0</span>, <span class="hljs-number">1.816815e+11</span>, <span class="hljs-number">8.03e+15</span>, <span class="hljs-number">3.125e+20</span>],
    ))


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">lowMetalFilter</span><span class="hljs-params">(samplerate, source)</span>:</span>
    <span class="hljs-keyword">return</span> applyContinuousFilter(samplerate, source, (
        [<span class="hljs-number">2.68345e+11</span>, <span class="hljs-number">3.5234375e+16</span>, <span class="hljs-number">0</span>],
        [<span class="hljs-number">30108309.0</span>, <span class="hljs-number">5.227075e+11</span>, <span class="hljs-number">1.56671875e+16</span>, <span class="hljs-number">1.953125e+20</span>],
    ))


samplerate = <span class="hljs-number">44100</span>

source = numpy.random.uniform(<span class="hljs-number">-0.1</span>, <span class="hljs-number">0.1</span>, samplerate * <span class="hljs-number">2</span>)
dest_high_metal = highMetalFilter(samplerate, source)
dest_low_metal = lowMetalFilter(samplerate, source)

soundfile.write(<span class="hljs-string">"source.wav"</span>, source, samplerate)
soundfile.write(<span class="hljs-string">"dest_high_metal.wav"</span>, dest_high_metal, samplerate)
soundfile.write(<span class="hljs-string">"dest_low_metal.wav"</span>, dest_low_metal, samplerate)
</div></code></pre>
<p data-line="209" class="code-line">BP0とBP1のボード線図です。</p>
<figure>
<img src="img/dr110_cymbal/dr110_bandpass_bode.png" alt="Image of Bode plot of DR-110 band-pass filter." style="width: 480px; padding-bottom: 12px;"/>
</figure>
<h3 data-line="215" class="code-line" id="%E3%83%8F%E3%82%A4%E3%83%91%E3%82%B9%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF">ハイパスフィルタ</h3>
<p data-line="216" class="code-line">回路図のいたるところに出てくる1次のハイパスフィルタです。</p>
<p data-line="218" class="code-line">下図はDR-110のシンバルのエンベロープに関する回路図です。網掛けの色ごとに別のハイパスフィルタを表しています。灰色の矢印は音の信号の流れを表しています。</p>
<figure>
<img src="img/dr110_cymbal/env_crop.png" alt="Image of envelope section of DR-110 schematic." style="width: 600px; padding-bottom: 12px;"/>
</figure>
<p data-line="224" class="code-line">ハイパスフィルタの部分だけを抜き出した図です。</p>
<figure>
<img src="img/dr110_cymbal/dr110_highpass.svg" alt="Image of DR-110 high-pass filter schematic." style="width: 320px; padding-bottom: 12px;"/>
</figure>
<p data-line="230" class="code-line">伝達関数 <eq><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>H</mi></mrow><annotation encoding="application/x-tex">H</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base"><span class="mord mathit" style="margin-right:0.08125em;">H</span></span></span></span></eq> です。 <eq><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base"><span class="mord mathit" style="margin-right:0.00773em;">R</span></span></span></span></eq> は抵抗の値で単位は[Ω]、<eq><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>C</mi></mrow><annotation encoding="application/x-tex">C</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base"><span class="mord mathit" style="margin-right:0.07153em;">C</span></span></span></span></eq>はキャパシタの値で単位は[F]です。</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>H</mi><mo>=</mo><mfrac><mrow><mi>R</mi><mi>C</mi></mrow><mrow><mi>R</mi><mi>C</mi><mi>s</mi><mo>+</mo><mn>1</mn></mrow></mfrac></mrow><annotation encoding="application/x-tex">
H = \frac{RC}{RCs + 1}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.36033em;"></span><span class="strut bottom" style="height:2.1296600000000003em;vertical-align:-0.7693300000000001em;"></span><span class="base"><span class="mord mathit" style="margin-right:0.08125em;">H</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit" style="margin-right:0.00773em;">R</span><span class="mord mathit" style="margin-right:0.07153em;">C</span><span class="mord mathit">s</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span></span></span><span style="top:-3.15em;"><span class="pstrut" style="height:3em;"></span><span class="stretchy" style="height:0.2em;"><svg width='400em' height='0.2em' viewBox='0 0 400000 200' preserveAspectRatio='xMinYMin slice'><path d='M0 80H400000 v40H0z M0 80H400000 v40H0z'/></svg></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit" style="margin-right:0.00773em;">R</span><span class="mord mathit" style="margin-right:0.07153em;">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693300000000001em;"></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></eqn></section><p data-line="236" class="code-line"><code>scipy.signal</code> を使った実装の例です。</p>
<pre><code data-line="238" class="code-line language-python"><div><span class="hljs-keyword">import</span> numpy
<span class="hljs-keyword">import</span> soundfile
<span class="hljs-keyword">import</span> scipy.signal <span class="hljs-keyword">as</span> signal

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">rcHighpass</span><span class="hljs-params">(samplerate, source, r, c)</span>:</span>
    rc = r * c
    num, den, dt = signal.cont2discrete(([rc, <span class="hljs-number">0</span>], [rc, <span class="hljs-number">1</span>]), <span class="hljs-number">1.0</span> / samplerate)
    <span class="hljs-keyword">return</span> signal.lfilter(num[<span class="hljs-number">0</span>], den, source)

samplerate = <span class="hljs-number">44100</span>
resistance = <span class="hljs-number">1e6</span>
capacitance = <span class="hljs-number">47e-9</span>

source = numpy.random.uniform(<span class="hljs-number">-0.1</span>, <span class="hljs-number">0.1</span>, samplerate * <span class="hljs-number">2</span>)
dest = rcHighpass(samplerate, source, resistance, capacitance)

soundfile.write(<span class="hljs-string">"source.wav"</span>, source, samplerate)
soundfile.write(<span class="hljs-string">"dest.wav"</span>, dest, samplerate)
</div></code></pre>
<h3 data-line="259" class="code-line" id="high-metal-%E3%81%A8-low-metal">High Metal と Low Metal</h3>
<p data-line="260" class="code-line">High Metalはハイハットで使われるフィルタネットワークです。</p>
<figure>
<img src="img/dr110_cymbal/DR-110_high_metal.svg" alt="Image of signal flow of DR-110 high metal section." style="width: 600px; padding-bottom: 12px;"/>
</figure>
<p data-line="266" class="code-line">Low Metalシンバルの音の低い部分の表現に使われるフィルタネットワークです。</p>
<figure>
<img src="img/dr110_cymbal/DR-110_low_metal.svg" alt="Image of signal flow of DR-110 low metal section." style="width: 520px; padding-bottom: 12px;"/>
</figure>
<p data-line="272" class="code-line">エンベロープの手前での周波数応答です。</p>
<figure>
<img src="img/dr110_cymbal/metal_filter.png" alt="Image of signal flow of DR-110 low metal section." style="width: 480px; padding-bottom: 12px;"/>
</figure>
<h2 data-line="278" class="code-line" id="%E3%82%A8%E3%83%B3%E3%83%99%E3%83%AD%E3%83%BC%E3%83%97">エンベロープ</h2>
<p data-line="279" class="code-line">DR-110の回路図から抜き出したシンバルのエンベロープの仕様です。</p>
<figure>
<img src="img/dr110_cymbal/env_time_crop.png" alt="Image of specification of DR-110 cymbal envelopes." style="width: 320px; padding-bottom: 12px;"/>
</figure>
<p data-line="285" class="code-line">ここではエンベロープに指数的減衰 (<a href="https://en.wikipedia.org/wiki/Exponential_decay">Exponential Decay</a>) を使います。</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>y</mi><mo>(</mo><mi>t</mi><mo>)</mo><mo>=</mo><mi>x</mi><mo>(</mo><mi>t</mi><mo>)</mo><msup><mi>e</mi><mrow><mi>a</mi><mi>t</mi></mrow></msup></mrow><annotation encoding="application/x-tex">
y(t) = x(t)e^{at}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.843556em;"></span><span class="strut bottom" style="height:1.093556em;vertical-align:-0.25em;"></span><span class="base"><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mopen">(</span><span class="mord mathit">t</span><span class="mclose">)</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mord mathit">x</span><span class="mopen">(</span><span class="mord mathit">t</span><span class="mclose">)</span><span class="mord"><span class="mord mathit">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.843556em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathit mtight">a</span><span class="mord mathit mtight">t</span></span></span></span></span></span></span></span></span></span></span></span></span></eqn></section><p data-line="291" class="code-line"><eq><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>a</mi><mo>&lt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">a &lt; 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.68354em;vertical-align:-0.0391em;"></span><span class="base"><span class="mord mathit">a</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mord">0</span></span></span></span></eq> のときに係数 <eq><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mi>e</mi><mrow><mi>a</mi><mi>t</mi></mrow></msup></mrow><annotation encoding="application/x-tex">e^{at}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.7935559999999999em;"></span><span class="strut bottom" style="height:0.7935559999999999em;vertical-align:0em;"></span><span class="base"><span class="mord"><span class="mord mathit">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7935559999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathit mtight">a</span><span class="mord mathit mtight">t</span></span></span></span></span></span></span></span></span></span></span></span></eq> が指数的減衰を表します。 <eq><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>x</mi><mo>(</mo><mi>t</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">x(t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base"><span class="mord mathit">x</span><span class="mopen">(</span><span class="mord mathit">t</span><span class="mclose">)</span></span></span></span></eq> は任意の入力信号です。</p>
<p data-line="293" class="code-line"><eq><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>t</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">t = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.64444em;vertical-align:0em;"></span><span class="base"><span class="mord mathit">t</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mord">0</span></span></span></span></eq> のときの初期値が <eq><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base"><span class="mord mathit" style="margin-right:0.05764em;">E</span></span></span></span></eq> かつ、 <eq><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>t</mi><mo>=</mo><mi>T</mi></mrow><annotation encoding="application/x-tex">t = T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base"><span class="mord mathit">t</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mord mathit" style="margin-right:0.13889em;">T</span></span></span></span></eq> のとき閾値 <eq><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">\epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.43056em;vertical-align:0em;"></span><span class="base"><span class="mord mathit">ϵ</span></span></span></span></eq> になるように <eq><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.43056em;vertical-align:0em;"></span><span class="base"><span class="mord mathit">a</span></span></span></span></eq> を決めます。 <eq><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><mn>0</mn><mn>0</mn><mn>0</mn></mrow><annotation encoding="application/x-tex">1000</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.64444em;vertical-align:0em;"></span><span class="base"><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span></span></span></span></eq> は <eq><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>T</mi></mrow><annotation encoding="application/x-tex">T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base"><span class="mord mathit" style="margin-right:0.13889em;">T</span></span></span></span></eq> の単位 [ms] のミリから来ています。</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mtable><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>ϵ</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>E</mi><msup><mi>e</mi><mrow><mi>a</mi><mi>T</mi><mi mathvariant="normal">/</mi><mn>1</mn><mn>0</mn><mn>0</mn><mn>0</mn></mrow></msup></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>log</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mfrac><mrow><mi>ϵ</mi></mrow><mrow><mi>E</mi></mrow></mfrac><mo fence="true">)</mo></mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>a</mi><mi>T</mi><mi mathvariant="normal">/</mi><mn>1</mn><mn>0</mn><mn>0</mn><mn>0</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mfrac><mrow><mn>1</mn><mn>0</mn><mn>0</mn><mn>0</mn></mrow><mrow><mi>T</mi></mrow></mfrac><mi>log</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mfrac><mrow><mi>ϵ</mi></mrow><mrow><mi>E</mi></mrow></mfrac><mo fence="true">)</mo></mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>a</mi></mrow></mstyle></mtd></mtr></mtable></mrow><annotation encoding="application/x-tex">
\begin{aligned}
\epsilon &amp;= E e^{aT / 1000}\\
\log \left( \frac{\epsilon}{E} \right) &amp;= aT / 1000\\
\frac{1000}{T} \log \left( \frac{\epsilon}{E} \right) &amp;= a
\end{aligned}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:3.27072em;"></span><span class="strut bottom" style="height:6.041440000000001em;vertical-align:-2.7707200000000007em;"></span><span class="base"><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.27072em;"><span style="top:-5.65416em;"><span class="pstrut" style="height:3.32144em;"></span><span class="mord"><span class="mord mathit">ϵ</span></span></span><span style="top:-3.84416em;"><span class="pstrut" style="height:3.32144em;"></span><span class="mord"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mord rule" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size2">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.10756em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit" style="margin-right:0.05764em;">E</span></span></span><span style="top:-3.15em;"><span class="pstrut" style="height:3em;"></span><span class="stretchy" style="height:0.2em;"><svg width='400em' height='0.2em' viewBox='0 0 400000 200' preserveAspectRatio='xMinYMin slice'><path d='M0 80H400000 v40H0z M0 80H400000 v40H0z'/></svg></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit">ϵ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size2">)</span></span></span></span></span><span style="top:-1.5367199999999994em;"><span class="pstrut" style="height:3.32144em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">T</span></span></span><span style="top:-3.15em;"><span class="pstrut" style="height:3em;"></span><span class="stretchy" style="height:0.2em;"><svg width='400em' height='0.2em' viewBox='0 0 400000 200' preserveAspectRatio='xMinYMin slice'><path d='M0 80H400000 v40H0z M0 80H400000 v40H0z'/></svg></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord rule" style="margin-right:0.16666666666666666em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mord rule" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size2">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.10756em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit" style="margin-right:0.05764em;">E</span></span></span><span style="top:-3.15em;"><span class="pstrut" style="height:3em;"></span><span class="stretchy" style="height:0.2em;"><svg width='400em' height='0.2em' viewBox='0 0 400000 200' preserveAspectRatio='xMinYMin slice'><path d='M0 80H400000 v40H0z M0 80H400000 v40H0z'/></svg></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathit">ϵ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size2">)</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.7707200000000007em;"></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.27072em;"><span style="top:-5.65416em;"><span class="pstrut" style="height:3.32144em;"></span><span class="mord"><span class="mord"></span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mord mathit" style="margin-right:0.05764em;">E</span><span class="mord"><span class="mord mathit">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathit mtight">a</span><span class="mord mathit mtight" style="margin-right:0.13889em;">T</span><span class="mord mtight">/</span><span class="mord mtight">1</span><span class="mord mtight">0</span><span class="mord mtight">0</span><span class="mord mtight">0</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.84416em;"><span class="pstrut" style="height:3.32144em;"></span><span class="mord"><span class="mord"></span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mord mathit">a</span><span class="mord mathit" style="margin-right:0.13889em;">T</span><span class="mord">/</span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span></span></span><span style="top:-1.5367199999999994em;"><span class="pstrut" style="height:3.32144em;"></span><span class="mord"><span class="mord"></span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mord mathit">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.7707200000000007em;"></span></span></span></span></span></span></span></span></span></span></eqn></section><p data-line="303" class="code-line">NumPyでの実装は次のようになります。 <code>threshold</code> の値は適当に決めています。</p>
<pre><code data-line="305" class="code-line language-python"><div><span class="hljs-keyword">import</span> numpy
<span class="hljs-keyword">import</span> soundfile

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">envelope</span><span class="hljs-params">(time, T, E, threshold=<span class="hljs-number">0.4</span>)</span>:</span>
    a = numpy.log(threshold / E) / T * <span class="hljs-number">1000</span>
    <span class="hljs-keyword">return</span> numpy.exp(a * time)

samplerate = <span class="hljs-number">44100</span>
duration = <span class="hljs-number">1</span>

num_sample = int(duration * samplerate)

time = numpy.linspace(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, num_sample)

source = numpy.random.uniform(<span class="hljs-number">-0.1</span>, <span class="hljs-number">0.1</span>, num_sample)
dest = source * envelope(time, <span class="hljs-number">700</span>, <span class="hljs-number">6</span>)

soundfile.write(<span class="hljs-string">"source.wav"</span>, source, samplerate)
soundfile.write(<span class="hljs-string">"dest.wav"</span>, dest, samplerate)
</div></code></pre>
<h2 data-line="327" class="code-line" id="%E3%83%9F%E3%83%83%E3%82%AF%E3%82%B9">ミックス</h2>
<p data-line="328" class="code-line">DR-110ではクローズドハイハット (CH) 、オープンハイハット (OH) 、シンバル (CY) の3つの音が使えます。この3つの音の違いはエンベロープとミックスです。</p>
<p data-line="330" class="code-line">ハイハットの合成には High Metal からの出力だけを使います。エンベロープの Check Point はクローズドが6、オープンは5です。</p>
<p data-line="332" class="code-line">シンバルの合成には High Metal と Low Metal の出力を使います。High Metal は Check Point 7, 8 のエンベロープを 10:1 の比率で足し合わせます。 Low metal のエンベロープは Check Point 9です。High MetalとLow Metalは約2:1の比率で足し合わせます。</p>
<p data-line="334" class="code-line">以下は完成したコードのミックスの部分へのリンクです。</p>
<ul>
<li data-line="336" class="code-line"><a href="https://github.com/ryukau/filter_notes/blob/de23e42693f5c95e0c2bb32a0796e3a270ef3ec4/docs/demo/dr110_cymbal/dr110_cymbal.py#L86">ミックスを行う関数 metalMix (github.com)</a></li>
</ul>
<h2 data-line="338" class="code-line" id="%E7%B5%90%E6%9E%9C">結果</h2>
<p data-line="339" class="code-line">オシレータの音です。</p>
<p data-line="341" class="code-line"><label>Oscillator output</label>
<audio controls>
<source src="snd/dr110_cymbal/dr110_osc.wav" type="audio/wav">
Audio of simulated DR-110 cymbal oscillator.
</audio></p>
<p data-line="347" class="code-line">フィルタを通した音です。</p>
<p data-line="349" class="code-line"><label>High Metal</label>
<audio controls>
<source src="snd/dr110_cymbal/dr110_high_metal.wav" type="audio/wav">
Audio of simulated DR-110 high metal.
</audio></p>
<p data-line="355" class="code-line"><label>Low Metal</label>
<audio controls>
<source src="snd/dr110_cymbal/dr110_low_metal.wav" type="audio/wav">
Audio of simulated DR-110 low metal.
</audio></p>
<p data-line="361" class="code-line">ミックスした音です。</p>
<p data-line="363" class="code-line"><label>CY</label>
<audio controls>
<source src="snd/dr110_cymbal/dr110_cy_mixed.wav" type="audio/wav">
Audio of simulated DR-110 cymbal sound.
</audio></p>
<p data-line="369" class="code-line"><label>CH</label>
<audio controls>
<source src="snd/dr110_cymbal/dr110_ch_mixed.wav" type="audio/wav">
Audio of simulated DR-110 closed hihat sound.
</audio></p>
<p data-line="375" class="code-line"><label>OH</label>
<audio controls>
<source src="snd/dr110_cymbal/dr110_oh_mixed.wav" type="audio/wav">
Audio of simulated DR-110 open hihat sound.
</audio></p>
<p data-line="381" class="code-line">オリジナルのDR-110の音です。</p>
<p data-line="383" class="code-line"><label>CY</label>
<audio controls>
<source src="snd/dr110_cymbal/dr110_cy_original.wav" type="audio/wav">
Audio of DR-110 cymbal sound.
</audio></p>
<p data-line="389" class="code-line"><label>CH</label>
<audio controls>
<source src="snd/dr110_cymbal/dr110_ch_original.wav" type="audio/wav">
Audio of DR-110 closed hihat sound.
</audio></p>
<p data-line="395" class="code-line"><label>OH</label>
<audio controls>
<source src="snd/dr110_cymbal/dr110_oh_original.wav" type="audio/wav">
Audio of DR-110 open hihat sound.
</audio></p>
<p data-line="401" class="code-line">作った音はノイズが足りていないように聞こえたので、オシレータのノイズの音量を0.3から6に変えてレンダリングした音です。</p>
<p data-line="403" class="code-line"><label>CY</label>
<audio controls>
<source src="snd/dr110_cymbal/dr110_cy_noisy.wav" type="audio/wav">
Audio of simulated DR-110 cymbal sound.
</audio></p>
<p data-line="409" class="code-line"><label>CH</label>
<audio controls>
<source src="snd/dr110_cymbal/dr110_ch_noisy.wav" type="audio/wav">
Audio of simulated DR-110 closed hihat sound.
</audio></p>
<p data-line="415" class="code-line"><label>OH</label>
<audio controls>
<source src="snd/dr110_cymbal/dr110_oh_noisy.wav" type="audio/wav">
Audio of simulated DR-110 open hihat sound.
</audio></p>
<h2 data-line="421" class="code-line" id="%E3%81%9D%E3%81%AE%E4%BB%96">その他</h2>
<p data-line="422" class="code-line">アタックが弱いです。エンベロープが単純な指数的減衰ではないのかもしれません。</p>
<p data-line="424" class="code-line">シンバルのミックスの後に続く回路を無視しています。実機ではBalanceで大きく音が変わります。</p>
<p data-line="426" class="code-line">トランジスタの回路がよく分からなかったのでハイパスフィルタを適当に試行錯誤して設計しました。</p>
<p data-line="428" class="code-line">エンベロープを打ち切る電圧がわかっていません。</p>
<p data-line="430" class="code-line">バンドパスフィルタを伝達関数から離散フィルタにするとき、ソルバが次のようなWarningを出します。</p>
<pre><code data-line="432" class="code-line"><code><div>/__somewhere__/scipy/linalg/basic.py:40: RuntimeWarning: scipy.linalg.solve
Ill-conditioned matrix detected. Result is not guaranteed to be accurate.
Reciprocal condition number/precision: 1.5222285969682624e-17 / 1.1102230246251565e-16
  RuntimeWarning)
</div></code></code></pre>
<h2 data-line="439" class="code-line" id="%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE">参考文献</h2>
<ul>
<li data-line="440" class="code-line">電子回路、山本 外史、1994、第11刷、p.145、ISBN4-254-22111-8</li>
<li data-line="441" class="code-line"><a href="http://www.ti.com/lit/an/sboa093a/sboa093a.pdf">&quot;Handbook of Operational Amplifier Active RC Networks&quot; - sboa093a.pdf</a>、p.14</li>
<li data-line="442" class="code-line"><a href="https://electronics.stackexchange.com/questions/125123/what-is-the-transfer-function-for-a-first-order-active-high-pass-filter">What is the transfer function for a first order active high-pass filter - Electrical Engineering Stack Exchange</a></li>
<li data-line="443" class="code-line"><a href="https://www.electronics-tutorials.ws/amplifier/input-impedance-of-an-amplifier.html">Input Impedance of an Amplifier and How to Calculate it</a></li>
<li data-line="444" class="code-line"><a href="http://www.ti.com/lit/an/sloa060/sloa060.pdf">&quot;Sine Wave Oscillator&quot; - sloa060.pdf</a></li>
</ul>

</body></html>
