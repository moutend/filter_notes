<!DOCTYPE html>
<html>

<head>
  <meta charset=utf-8>
  <title>
    ptr_maxima
  </title>

  <!-- highlight.js -->
  <link rel="stylesheet" href="../script/highlight/idea.css">
  <script src="../script/highlight/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

  <!-- KaTeX -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.css"
    integrity="sha384-yFRtMMDnQtDRO8rLpMIKrtPCD5jdktao2TV19YiZYWMDkUR5GQZR/NOVTdquEx1j" crossorigin="anonymous">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.js"
    integrity="sha384-9Nhn55MVVN0/4OFx7EE5kpFBPsEMZxKTCnA+4fqDmg12eCTqGi6+BB2LjY8brQxJ"
    crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/contrib/auto-render.min.js"
    integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>


  <style>
    body {
      max-width: 704px;
      margin: auto;
      padding: 32px 8px;
    }

    img {
      max-width: 100%;
    }

    video {
      max-width: 100%;
    }

    kbd {
      border-style: solid;
      border-width: 1px 2px 2px 1px;
      border-radius: 2px;
      padding: 2px;
      margin: 2px;
    }

    a {
      text-decoration: none;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
      color: #004444;
      border-left: solid 8px #eeeeee;
      padding-left: 8px;
    }

    table {
      border-spacing: 0px;
      border-collapse: separate;
      border: 1px solid #dddddd;
    }

    tr.header {
      border: 1px solid black;
    }

    tr.odd {
      background: #eeeeee;
    }

    tr.even {
      background: #ffffff;
    }

    th {
      height: 2em;
      font-weight: normal;
      color: #004444;
      padding-left: 0.35em;
      padding-right: 0.35em;
      border-bottom: 3px solid #dddddd;
      border-left: 1px solid #dddddd;
    }

    td {
      height: 1.5em;
      padding-left: 0.35em;
      padding-right: 0.35em;
      border-bottom: 1px solid #dddddd;
      border-left: 1px solid #dddddd;
    }

    audio {
      vertical-align: middle;
    }

    label {
      vertical-align: middle;
    }

    code {
      color: #004444;
    }

    pre code {
      border: 4px solid #eeeeee;
    }

    li {
      margin: 8px;
    }

    header {
      border-bottom: 1px gray solid;
      padding: 0.5em;
      margin-bottom: 1em;
    }

    footer {
      border-top: 1px gray solid;
      padding: 0.5em;
      margin-top: 1em;
    }

    canvas {
      /* image-rendering: pixelated; */
      display: inline-block;
      border-style: solid;
      border-width: 1px;
      border-color: #627f84;
    }

    .controlBlock {
      display: inline-block;
      width: 450px;
      text-align: left;
      vertical-align: top;
      margin-left: 4px;
    }

    input[type="button"] {
      background-color: #ffffff;
      border: 2px solid #aaaaaa;
      font-size: 16px;
      height: 32px;
    }

    input[type="button"]:hover {
      background-color: #ffffff;
      border: 2px solid #aaccff;
    }

    div.numberInput {
      display: block;
      white-space: nowrap;
    }

    div.numberInput:hover {
      background-color: #e0ecff;
    }

    .numberInputLabel {
      /* max 12 letter  */
      display: inline-block;
      margin: 0 8px 0 8px;
      text-align: left;
      vertical-align: middle;
      width: 100px;

      font-size: 10pt;
      font-family: 'Courier New', Courier, monospace;
    }

    .numberInputNumber {
      display: inline-block;
      vertical-align: middle;
      width: 120px;
    }

    .numberInputRange {
      display: inline-block;
      vertical-align: middle;
      width: 160px;
    }

    .pullDownMenu {
      display: inline-block;
      text-align: center;
    }

    .pullDownMenu:hover {
      background-color: #e0ecff;
    }

    select {
      background-color: #ffffff;
      border: 2px solid #aaaaaa;
      height: 24px;
      vertical-align: middle;
      font-size: 12px;
    }

    select:hover {
      background-color: #ffffff;
      border: 2px solid #aaccff;
    }
  </style>
</head>

<body>
  <header>
    <p>
      Update:
      2019-09-11
    </p>
  </header>

  <h1 id="ptr-の式を求める-maxima-のコード">PTR の式を求める Maxima のコード</h1>
<ul>
<li><span class="math inline">\(f_0\)</span> : 基本周波数。</li>
<li><span class="math inline">\(f_s\)</span> : サンプリング周波数。</li>
<li><span class="math inline">\(T = f_0/f_s\)</span></li>
<li><span class="math inline">\(\phi = n T \bmod 1\)</span></li>
<li><span class="math inline">\(n = \phi / T\)</span></li>
</ul>
<p>数式上は <span class="math inline">\(\phi\)</span> と <span class="math inline">\(n\)</span> が循環参照になっていますが、実装では <span class="math inline">\(\phi\)</span> から <span class="math inline">\(n\)</span> を計算できます。</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">class</span> PTROscillator:</a>
<a class="sourceLine" id="cb1-2" title="2">    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, samplerate, frequency):</a>
<a class="sourceLine" id="cb1-3" title="3">        <span class="va">self</span>.phi <span class="op">=</span> <span class="fl">0.0</span></a>
<a class="sourceLine" id="cb1-4" title="4">        <span class="va">self</span>.T <span class="op">=</span> frequency <span class="op">/</span> samplerate</a>
<a class="sourceLine" id="cb1-5" title="5">        <span class="va">self</span>.h <span class="op">=</span> <span class="fl">1.0</span></a>
<a class="sourceLine" id="cb1-6" title="6"></a>
<a class="sourceLine" id="cb1-7" title="7">    <span class="kw">def</span> process(<span class="va">self</span>):</a>
<a class="sourceLine" id="cb1-8" title="8">        <span class="va">self</span>.phi <span class="op">+=</span> <span class="va">self</span>.T</a>
<a class="sourceLine" id="cb1-9" title="9">        <span class="cf">if</span> <span class="va">self</span>.phi <span class="op">&gt;=</span> <span class="fl">1.0</span>:</a>
<a class="sourceLine" id="cb1-10" title="10">            <span class="va">self</span>.phi <span class="op">-=</span> <span class="fl">1.0</span></a>
<a class="sourceLine" id="cb1-11" title="11">        <span class="cf">return</span> <span class="va">self</span>.PTRSaw3(<span class="va">self</span>.phi, <span class="va">self</span>.T, <span class="va">self</span>.h)</a>
<a class="sourceLine" id="cb1-12" title="12"></a>
<a class="sourceLine" id="cb1-13" title="13">    <span class="kw">def</span> PTRSaw3(<span class="va">self</span>, phi, T, h):</a>
<a class="sourceLine" id="cb1-14" title="14">        n <span class="op">=</span> phi <span class="op">/</span> T</a>
<a class="sourceLine" id="cb1-15" title="15">        <span class="cf">if</span> n <span class="op">&gt;=</span> <span class="fl">3.0</span>:</a>
<a class="sourceLine" id="cb1-16" title="16">            <span class="cf">return</span> <span class="dv">2</span><span class="op">*</span>T<span class="op">*</span>n<span class="dv">-3</span><span class="op">*</span>T<span class="dv">-1</span></a>
<a class="sourceLine" id="cb1-17" title="17">        <span class="cf">if</span> <span class="fl">0.0</span> <span class="op">&lt;=</span> n <span class="kw">and</span> n <span class="op">&lt;</span> <span class="fl">1.0</span>:</a>
<a class="sourceLine" id="cb1-18" title="18">            <span class="cf">return</span> <span class="op">-</span>(h<span class="op">*</span>n<span class="op">**</span><span class="dv">3</span>)<span class="op">/</span><span class="dv">3</span><span class="op">+</span><span class="dv">2</span><span class="op">*</span>T<span class="op">*</span>n<span class="op">+</span><span class="dv">2</span><span class="op">*</span>h<span class="dv">-3</span><span class="op">*</span>T<span class="dv">-1</span></a>
<a class="sourceLine" id="cb1-19" title="19">        <span class="cf">if</span> <span class="fl">1.0</span> <span class="op">&lt;=</span> n <span class="kw">and</span> n <span class="op">&lt;</span> <span class="fl">2.0</span>:</a>
<a class="sourceLine" id="cb1-20" title="20">            <span class="cf">return</span> (<span class="dv">2</span><span class="op">*</span>h<span class="op">*</span>n<span class="op">**</span><span class="dv">3</span>)<span class="op">/</span><span class="dv">3-3</span><span class="op">*</span>h<span class="op">*</span>n<span class="op">**</span><span class="dv">2</span><span class="op">+</span><span class="dv">3</span><span class="op">*</span>h<span class="op">*</span>n<span class="op">+</span><span class="dv">2</span><span class="op">*</span>T<span class="op">*</span>n<span class="op">+</span>h<span class="dv">-3</span><span class="op">*</span>T<span class="dv">-1</span></a>
<a class="sourceLine" id="cb1-21" title="21">        <span class="cf">if</span> <span class="fl">2.0</span> <span class="op">&lt;=</span> n <span class="kw">and</span> n <span class="op">&lt;</span> <span class="fl">3.0</span>:</a>
<a class="sourceLine" id="cb1-22" title="22">            <span class="cf">return</span> <span class="op">-</span>(h<span class="op">*</span>n<span class="op">**</span><span class="dv">3</span>)<span class="op">/</span><span class="dv">3</span><span class="op">+</span><span class="dv">3</span><span class="op">*</span>h<span class="op">*</span>n<span class="op">**</span><span class="dv">2-9</span><span class="op">*</span>h<span class="op">*</span>n<span class="op">+</span><span class="dv">2</span><span class="op">*</span>T<span class="op">*</span>n<span class="op">+</span><span class="dv">9</span><span class="op">*</span>h<span class="dv">-3</span><span class="op">*</span>T<span class="dv">-1</span></a>
<a class="sourceLine" id="cb1-23" title="23">        <span class="cf">return</span> <span class="dv">0</span>  <span class="co"># 念のため。</span></a></code></pre></div>
<p>以下のコードを wxMaxima にコピペすれば式が得られます。</p>
<h2 id="saw">Saw</h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode maxima"><code class="sourceCode maxima"><a class="sourceLine" id="cb2-1" title="1"><span class="cn">DPWSaw</span>(<span class="cn">N</span>) := <span class="fu">block</span>([<span class="cn">result</span>: [], <span class="cn">eq</span>: <span class="cn">x</span> = <span class="dv">0</span>],</a>
<a class="sourceLine" id="cb2-2" title="2">  <span class="va">integration_constant</span>: <span class="do">&#39;</span><span class="cn">C</span>,</a>
<a class="sourceLine" id="cb2-3" title="3">  <span class="fu">reset</span>(<span class="va">integration_constant_counter</span>),</a>
<a class="sourceLine" id="cb2-4" title="4">  <span class="kw">for</span> <span class="cn">i</span>: <span class="dv">1</span> <span class="kw">thru</span> <span class="cn">N</span> <span class="kw">do</span> <span class="fu">block</span>([<span class="cn">a</span>, <span class="cn">c</span>],</a>
<a class="sourceLine" id="cb2-5" title="5">    <span class="cn">eq</span>: <span class="fu">integrate</span>(<span class="cn">eq</span>, <span class="cn">x</span>),</a>
<a class="sourceLine" id="cb2-6" title="6">    <span class="cn">a</span>: <span class="fu">rhs</span>(<span class="fu">solve</span>(<span class="cn">eq</span>, <span class="fu">concat</span>(<span class="do">&#39;</span><span class="cn">C</span>, <span class="cn">i</span>))[<span class="dv">1</span>]),</a>
<a class="sourceLine" id="cb2-7" title="7">    <span class="kw">if</span> <span class="cn">i</span> &gt; <span class="dv">1</span> <span class="kw">then</span> (</a>
<a class="sourceLine" id="cb2-8" title="8">      <span class="cn">c</span>: <span class="fu">rhs</span>(<span class="fu">solve</span>(<span class="fu">subst</span>(<span class="dv">1</span>, <span class="cn">x</span>, <span class="cn">a</span>) = <span class="cn">subst</span>(<span class="dv">-1</span>, <span class="cn">x</span>, <span class="cn">a</span>), <span class="fu">concat</span>(<span class="do">&#39;</span><span class="cn">C</span>, <span class="cn">i</span> - <span class="dv">1</span>))[<span class="dv">1</span>]),</a>
<a class="sourceLine" id="cb2-9" title="9">      <span class="cn">a</span>: <span class="fu">subst</span>(<span class="cn">c</span>, <span class="fu">concat</span>(<span class="do">&#39;</span><span class="cn">C</span>, <span class="cn">i</span> - <span class="dv">1</span>), <span class="cn">a</span>),</a>
<a class="sourceLine" id="cb2-10" title="10">      <span class="cn">eq</span>: <span class="fu">subst</span>(<span class="cn">c</span>, <span class="fu">concat</span>(<span class="do">&#39;</span><span class="cn">C</span>, <span class="cn">i</span> - <span class="dv">1</span>), <span class="cn">eq</span>)</a>
<a class="sourceLine" id="cb2-11" title="11">    ),</a>
<a class="sourceLine" id="cb2-12" title="12">    <span class="cn">a</span>: <span class="fu">num</span>(<span class="cn">a</span>),</a>
<a class="sourceLine" id="cb2-13" title="13">    <span class="cn">a</span>: <span class="cn">a</span> / <span class="fu">coeff</span>(<span class="cn">a</span>, <span class="cn">x</span>, <span class="fu">hipow</span>(<span class="cn">a</span>, <span class="cn">x</span>)),</a>
<a class="sourceLine" id="cb2-14" title="14">    <span class="cn">result</span>: <span class="fu">endcons</span>(<span class="fu">expand</span>(<span class="cn">a</span>), <span class="cn">result</span>)</a>
<a class="sourceLine" id="cb2-15" title="15">  ),</a>
<a class="sourceLine" id="cb2-16" title="16">  <span class="cn">push</span>(<span class="cn">x</span>, <span class="cn">result</span>)</a>
<a class="sourceLine" id="cb2-17" title="17">);</a>
<a class="sourceLine" id="cb2-18" title="18"></a>
<a class="sourceLine" id="cb2-19" title="19"><span class="cn">PTRSaw</span>(<span class="cn">dpw</span>, <span class="cn">N</span>) := <span class="fu">block</span>([<span class="cn">ptr</span>],</a>
<a class="sourceLine" id="cb2-20" title="20">  <span class="cn">removeTinverse</span>(<span class="cn">eq</span>) := <span class="fu">block</span>([<span class="cn">r</span>: <span class="dv">0</span>],</a>
<a class="sourceLine" id="cb2-21" title="21">    <span class="kw">if</span> <span class="fu">atom</span>(<span class="cn">eq</span>) <span class="kw">then</span> <span class="cn">r</span>: <span class="cn">eq</span></a>
<a class="sourceLine" id="cb2-22" title="22">    <span class="kw">else</span> <span class="kw">for</span> <span class="cn">term</span> <span class="kw">in</span> <span class="fu">args</span>(<span class="cn">eq</span>) <span class="kw">do</span> <span class="fu">block</span>([<span class="cn">den</span>],</a>
<a class="sourceLine" id="cb2-23" title="23">      <span class="cn">den</span>: <span class="fu">denom</span>(<span class="cn">term</span>),</a>
<a class="sourceLine" id="cb2-24" title="24">      <span class="kw">if</span> <span class="fu">atom</span>(<span class="cn">den</span>) <span class="kw">then</span></a>
<a class="sourceLine" id="cb2-25" title="25">        <span class="kw">if</span> <span class="cn">den</span> # <span class="cn">T</span> <span class="kw">then</span> <span class="cn">r</span>: <span class="cn">r</span> + <span class="cn">term</span></a>
<a class="sourceLine" id="cb2-26" title="26">    ),</a>
<a class="sourceLine" id="cb2-27" title="27">    <span class="cn">r</span></a>
<a class="sourceLine" id="cb2-28" title="28">  ),</a>
<a class="sourceLine" id="cb2-29" title="29"></a>
<a class="sourceLine" id="cb2-30" title="30">  <span class="cn">phi</span>(<span class="cn">n</span>, <span class="cn">boundary</span>) :=</a>
<a class="sourceLine" id="cb2-31" title="31">    <span class="kw">if</span> <span class="cn">boundary</span> = <span class="do">&#39;</span><span class="cn">n</span> <span class="kw">or</span> <span class="cn">n</span> &gt; <span class="cn">boundary</span> <span class="kw">then</span> <span class="cn">n</span> * <span class="cn">T</span></a>
<a class="sourceLine" id="cb2-32" title="32">    <span class="kw">else</span> <span class="cn">n</span> * <span class="cn">T</span> + <span class="cn">h</span>,</a>
<a class="sourceLine" id="cb2-33" title="33"></a>
<a class="sourceLine" id="cb2-34" title="34">  <span class="cn">s</span>(<span class="cn">n</span>, <span class="cn">boundary</span>) := <span class="dv">2</span> * <span class="cn">phi</span>(<span class="cn">n</span>, <span class="cn">boundary</span>) - <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb2-35" title="35"></a>
<a class="sourceLine" id="cb2-36" title="36">  <span class="cn">y</span>(<span class="cn">dpw</span>, <span class="cn">N</span>) := <span class="fu">block</span>([<span class="cn">M</span>: <span class="cn">N</span> - <span class="dv">1</span>, <span class="cn">result</span>: []],</a>
<a class="sourceLine" id="cb2-37" title="37">    <span class="kw">for</span> <span class="cn">b</span>: <span class="dv">0</span> <span class="kw">thru</span> <span class="cn">M</span> <span class="kw">do</span> <span class="fu">block</span>([<span class="cn">eq</span>: <span class="dv">0</span>],</a>
<a class="sourceLine" id="cb2-38" title="38">      <span class="kw">for</span> <span class="cn">k</span>: <span class="dv">0</span> <span class="kw">thru</span> <span class="cn">M</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb2-39" title="39">        <span class="cn">eq</span>: <span class="cn">eq</span> + (<span class="dv">-1</span>)^<span class="cn">k</span> * <span class="fu">binomial</span>(<span class="cn">M</span>, <span class="cn">k</span>) * <span class="fu">subst</span>(<span class="cn">s</span>(<span class="cn">n</span> - <span class="cn">k</span>, <span class="cn">n</span> - <span class="cn">b</span>), <span class="cn">x</span>, <span class="cn">dpw</span>[<span class="cn">N</span>]),</a>
<a class="sourceLine" id="cb2-40" title="40">      <span class="cn">result</span>: <span class="fu">endcons</span>(<span class="cn">eq</span>, <span class="cn">result</span>)</a>
<a class="sourceLine" id="cb2-41" title="41">    ),</a>
<a class="sourceLine" id="cb2-42" title="42">    <span class="cn">result</span> / (<span class="dv">2</span> * <span class="cn">T</span>)^(<span class="cn">N</span> - <span class="dv">1</span>) / <span class="cn">N</span>!</a>
<a class="sourceLine" id="cb2-43" title="43">  ),</a>
<a class="sourceLine" id="cb2-44" title="44"></a>
<a class="sourceLine" id="cb2-45" title="45">  <span class="cn">ptr</span>: <span class="fu">expand</span>(<span class="fu">ratsimp</span>(<span class="cn">y</span>(<span class="cn">dpw</span>, <span class="cn">N</span>))),</a>
<a class="sourceLine" id="cb2-46" title="46">  <span class="kw">for</span> <span class="cn">i</span>: <span class="dv">1</span> <span class="kw">thru</span> <span class="fu">length</span>(<span class="cn">ptr</span>) <span class="kw">do</span> <span class="cn">ptr</span>[<span class="cn">i</span>]: <span class="cn">removeTinverse</span>(<span class="cn">ptr</span>[<span class="cn">i</span>]),</a>
<a class="sourceLine" id="cb2-47" title="47">  <span class="cn">ptr</span></a>
<a class="sourceLine" id="cb2-48" title="48">);</a>
<a class="sourceLine" id="cb2-49" title="49"></a>
<a class="sourceLine" id="cb2-50" title="50"><span class="cn">dispptrsaw</span>(<span class="cn">dpwsaw</span>) := <span class="fu">block</span>([<span class="cn">N</span>: <span class="fu">length</span>(<span class="cn">dpwsaw</span>)],</a>
<a class="sourceLine" id="cb2-51" title="51">  <span class="kw">for</span> <span class="cn">i</span>: <span class="dv">1</span> <span class="kw">thru</span> <span class="cn">N</span> <span class="kw">do</span> <span class="fu">block</span>([<span class="cn">eq</span>],</a>
<a class="sourceLine" id="cb2-52" title="52">    <span class="cn">eq</span>: <span class="cn">PTRSaw</span>(<span class="cn">dpwsaw</span>, <span class="cn">i</span>),</a>
<a class="sourceLine" id="cb2-53" title="53"></a>
<a class="sourceLine" id="cb2-54" title="54">    <span class="fu">disp</span>(<span class="fu">concat</span>(<span class="do">&#39;</span><span class="cn">PTRSaw</span>, <span class="cn">i</span> - <span class="dv">1</span>)),</a>
<a class="sourceLine" id="cb2-55" title="55">    <span class="fu">disp</span>([(<span class="fu">length</span>(<span class="cn">eq</span>) - <span class="dv">1</span>) * <span class="cn">T</span> &lt;= <span class="cn">phi</span>, <span class="cn">eq</span>[<span class="dv">1</span>]]),</a>
<a class="sourceLine" id="cb2-56" title="56">    <span class="kw">for</span> <span class="cn">j</span>: <span class="dv">2</span> <span class="kw">thru</span> <span class="fu">length</span>(<span class="cn">eq</span>) <span class="kw">do</span></a>
<a class="sourceLine" id="cb2-57" title="57">      <span class="fu">disp</span>([(<span class="cn">j</span> - <span class="dv">2</span>) * <span class="cn">T</span> &lt;= <span class="cn">phi</span> <span class="kw">and</span> <span class="cn">phi</span> &lt; (<span class="cn">j</span> - <span class="dv">1</span>) * <span class="cn">T</span>, <span class="cn">eq</span>[<span class="cn">j</span>]])</a>
<a class="sourceLine" id="cb2-58" title="58">  )</a>
<a class="sourceLine" id="cb2-59" title="59">);</a>
<a class="sourceLine" id="cb2-60" title="60"></a>
<a class="sourceLine" id="cb2-61" title="61"><span class="cn">dpwsaw</span>: <span class="cn">DPWSaw</span>(<span class="dv">10</span>);</a>
<a class="sourceLine" id="cb2-62" title="62"><span class="cn">dispptrsaw</span>(<span class="cn">dpwsaw</span>);</a>
<a class="sourceLine" id="cb2-63" title="63"></a>
<a class="sourceLine" id="cb2-64" title="64"><span class="co">/* format.py で利用。 */</span></a>
<a class="sourceLine" id="cb2-65" title="65"><span class="co">/*</span></a>
<a class="sourceLine" id="cb2-66" title="66"><span class="co">dispptrlist(dpw, ptrfunc) := block([L: []],</span></a>
<a class="sourceLine" id="cb2-67" title="67"><span class="co">  for i: 1 thru length(dpw) do L: endcons(ptrfunc(dpw, i), L),</span></a>
<a class="sourceLine" id="cb2-68" title="68"><span class="co">  L</span></a>
<a class="sourceLine" id="cb2-69" title="69"><span class="co">);</span></a>
<a class="sourceLine" id="cb2-70" title="70"><span class="co">dispptrlist(dpwsaw, PTRSaw);</span></a>
<a class="sourceLine" id="cb2-71" title="71"><span class="co">*/</span></a></code></pre></div>
<h2 id="triangle">Triangle</h2>
<p>位相が <span class="math inline">\([0, 1)\)</span> で一周するとき、 <span class="math inline">\([0, 0.5)\)</span> の範囲の計算式だけを求めています。</p>
<p>導出中の遷移領域の位置 <code>k</code> と、波形の不連続点 <code>b</code> の関係に応じて絶対値 <code>abs(x)</code> を <code>x</code> か <code>-x</code> に置き換えています。位相が <span class="math inline">\([0, 1)\)</span> で一周するとき、 <span class="math inline">\([0, 0.5)\)</span> の範囲の計算式だけを求めています。</p>
<p>Saw とは <span class="math inline">\(\phi\)</span> と <span class="math inline">\(s\)</span> が異なります。スケーリング係数は Saw の 2 倍です。</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode maxima"><code class="sourceCode maxima"><a class="sourceLine" id="cb3-1" title="1"><span class="cn">DPWTri</span>(<span class="cn">N</span>) := <span class="fu">block</span>([<span class="cn">result</span>: []],</a>
<a class="sourceLine" id="cb3-2" title="2">  <span class="cn">tri</span>(<span class="cn">N</span>) := <span class="fu">block</span>([<span class="cn">poly</span>: <span class="dv">0</span>, <span class="cn">poly_diff</span>: [], <span class="cn">A</span>: [], <span class="cn">D</span>],</a>
<a class="sourceLine" id="cb3-3" title="3">    <span class="kw">for</span> <span class="cn">i</span>: <span class="dv">1</span> <span class="kw">thru</span> <span class="cn">N</span> <span class="kw">do</span> (</a>
<a class="sourceLine" id="cb3-4" title="4">      <span class="kw">if</span> <span class="fu">oddp</span>(<span class="cn">i</span>) <span class="kw">then</span></a>
<a class="sourceLine" id="cb3-5" title="5">        <span class="cn">poly</span>: <span class="cn">poly</span> + <span class="cn">if</span> <span class="cn">i</span> = <span class="cn">N</span> <span class="kw">then</span> <span class="cn">x</span>^<span class="cn">i</span> <span class="kw">else</span> <span class="fu">concat</span>(<span class="cn">a</span>, <span class="cn">i</span>) * <span class="cn">x</span>^<span class="cn">i</span></a>
<a class="sourceLine" id="cb3-6" title="6">      <span class="kw">elseif</span> <span class="cn">i</span> = <span class="cn">N</span> <span class="kw">then</span></a>
<a class="sourceLine" id="cb3-7" title="7">        <span class="cn">poly</span>: <span class="cn">poly</span> + <span class="cn">x</span>^(<span class="cn">i</span> - <span class="dv">1</span>) * <span class="cn">abs</span>(<span class="cn">x</span>)</a>
<a class="sourceLine" id="cb3-8" title="8">    ),</a>
<a class="sourceLine" id="cb3-9" title="9"></a>
<a class="sourceLine" id="cb3-10" title="10">    <span class="cn">D</span>: <span class="fu">subst</span>(<span class="cn">x</span>, <span class="fu">abs</span>(<span class="cn">x</span>), <span class="cn">poly</span>),</a>
<a class="sourceLine" id="cb3-11" title="11">    <span class="cn">D</span>: <span class="fu">diff</span>(<span class="cn">D</span>, <span class="cn">x</span>),</a>
<a class="sourceLine" id="cb3-12" title="12">    <span class="cn">poly_diff</span>: <span class="fu">endcons</span>(<span class="cn">D</span>, <span class="cn">poly_diff</span>),</a>
<a class="sourceLine" id="cb3-13" title="13">    <span class="kw">while</span> <span class="fu">hipow</span>(<span class="cn">D</span>, <span class="cn">x</span>) &gt; <span class="dv">1</span> <span class="kw">do</span> (</a>
<a class="sourceLine" id="cb3-14" title="14">      <span class="cn">D</span>: <span class="fu">diff</span>(<span class="cn">D</span>, <span class="cn">x</span>, <span class="dv">2</span>),</a>
<a class="sourceLine" id="cb3-15" title="15">      <span class="cn">poly_diff</span>: <span class="fu">endcons</span>(<span class="cn">D</span>, <span class="cn">poly_diff</span>)</a>
<a class="sourceLine" id="cb3-16" title="16">    ),</a>
<a class="sourceLine" id="cb3-17" title="17"></a>
<a class="sourceLine" id="cb3-18" title="18">    <span class="kw">for</span> <span class="cn">i</span>: <span class="fu">length</span>(<span class="cn">poly_diff</span>) <span class="kw">step</span> <span class="dv">-1</span> <span class="kw">thru</span> <span class="dv">1</span> <span class="kw">do</span> (</a>
<a class="sourceLine" id="cb3-19" title="19">      <span class="cn">D</span>: <span class="fu">solve</span>(<span class="fu">subst</span>(<span class="dv">1</span> / <span class="dv">2</span>, <span class="cn">x</span>, <span class="cn">poly_diff</span>[<span class="cn">i</span>]) = <span class="dv">0</span>, <span class="fu">concat</span>(<span class="cn">a</span>, <span class="cn">i</span> * <span class="dv">2</span> - <span class="dv">1</span>)),</a>
<a class="sourceLine" id="cb3-20" title="20">      <span class="cn">A</span>: <span class="fu">append</span>(<span class="cn">A</span>, <span class="fu">subst</span>(<span class="cn">A</span>, <span class="cn">D</span>))</a>
<a class="sourceLine" id="cb3-21" title="21">    ),</a>
<a class="sourceLine" id="cb3-22" title="22"></a>
<a class="sourceLine" id="cb3-23" title="23">    <span class="fu">subst</span>(<span class="cn">A</span>, <span class="cn">poly</span>)</a>
<a class="sourceLine" id="cb3-24" title="24">  ),</a>
<a class="sourceLine" id="cb3-25" title="25"></a>
<a class="sourceLine" id="cb3-26" title="26">  <span class="kw">for</span> <span class="cn">i</span>: <span class="dv">1</span> <span class="kw">thru</span> <span class="cn">N</span> <span class="kw">do</span> <span class="cn">result</span>: <span class="fu">endcons</span>(<span class="cn">tri</span>(<span class="cn">i</span>), <span class="cn">result</span>),</a>
<a class="sourceLine" id="cb3-27" title="27">  <span class="cn">result</span></a>
<a class="sourceLine" id="cb3-28" title="28">);</a>
<a class="sourceLine" id="cb3-29" title="29"></a>
<a class="sourceLine" id="cb3-30" title="30"><span class="cn">PTRTri</span>(<span class="cn">dpw</span>, <span class="cn">N</span>) := <span class="fu">block</span>([<span class="cn">ptr</span>: []],</a>
<a class="sourceLine" id="cb3-31" title="31">  <span class="cn">phi</span>(<span class="cn">n</span>, <span class="cn">boundary</span>) :=</a>
<a class="sourceLine" id="cb3-32" title="32">    <span class="kw">if</span> <span class="cn">boundary</span> = <span class="do">&#39;</span><span class="cn">n</span> <span class="kw">or</span> <span class="cn">n</span> &gt; <span class="cn">boundary</span> <span class="kw">then</span> <span class="cn">n</span> * <span class="cn">T</span></a>
<a class="sourceLine" id="cb3-33" title="33">    <span class="kw">else</span> <span class="cn">n</span> * <span class="cn">T</span> + <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb3-34" title="34"></a>
<a class="sourceLine" id="cb3-35" title="35">  <span class="cn">s_odd</span>(<span class="cn">n</span>, <span class="cn">boundary</span>) := <span class="dv">1</span> / <span class="dv">2</span> - <span class="cn">abs</span>(<span class="dv">1</span> - <span class="dv">2</span> * <span class="cn">phi</span>(<span class="cn">n</span>, <span class="cn">boundary</span>)),</a>
<a class="sourceLine" id="cb3-36" title="36">  <span class="cn">s_even</span>(<span class="cn">n</span>, <span class="cn">boundary</span>) := <span class="dv">1</span> - <span class="dv">2</span> * <span class="cn">phi</span>(<span class="cn">n</span>, <span class="cn">boundary</span>),</a>
<a class="sourceLine" id="cb3-37" title="37"></a>
<a class="sourceLine" id="cb3-38" title="38">  <span class="cn">replaceabs</span>(<span class="cn">eq</span>, <span class="fu">sign</span>) := <span class="fu">block</span>(</a>
<a class="sourceLine" id="cb3-39" title="39">    <span class="cn">f</span>(<span class="cn">x</span>) := <span class="kw">if</span> <span class="kw">not</span> <span class="fu">atom</span>(<span class="cn">x</span>) <span class="kw">and</span> <span class="fu">op</span>(<span class="cn">x</span>) = <span class="cn">abs</span> <span class="kw">then</span> <span class="fu">sign</span> * <span class="cn">part</span>(<span class="cn">x</span>, <span class="dv">1</span>) <span class="kw">else</span> <span class="cn">x</span>,</a>
<a class="sourceLine" id="cb3-40" title="40">    <span class="kw">if</span> <span class="fu">atom</span>(<span class="cn">eq</span>) <span class="kw">then</span> <span class="cn">eq</span> <span class="kw">else</span> <span class="fu">scanmap</span>(<span class="cn">f</span>, <span class="cn">eq</span>)</a>
<a class="sourceLine" id="cb3-41" title="41">  ),</a>
<a class="sourceLine" id="cb3-42" title="42"></a>
<a class="sourceLine" id="cb3-43" title="43">  <span class="cn">y</span>(<span class="cn">dpw</span>, <span class="cn">N</span>, <span class="cn">s</span>) := <span class="fu">block</span>([<span class="cn">M</span>: <span class="cn">N</span> - <span class="dv">1</span>, <span class="cn">result</span>: []],</a>
<a class="sourceLine" id="cb3-44" title="44">    <span class="kw">for</span> <span class="cn">b</span>: <span class="dv">0</span> <span class="kw">thru</span> <span class="cn">M</span> <span class="kw">do</span> <span class="fu">block</span>([<span class="cn">eq</span>: <span class="dv">0</span>, <span class="cn">boundary</span>],</a>
<a class="sourceLine" id="cb3-45" title="45">      <span class="cn">boundary</span>: <span class="do">&#39;</span><span class="cn">n</span> - <span class="cn">b</span>,</a>
<a class="sourceLine" id="cb3-46" title="46">      <span class="kw">for</span> <span class="cn">k</span>: <span class="dv">0</span> <span class="kw">thru</span> <span class="cn">M</span> <span class="kw">do</span> <span class="fu">block</span>([<span class="cn">abs_x</span>],</a>
<a class="sourceLine" id="cb3-47" title="47">        <span class="cn">abs_x</span>: <span class="kw">if</span> <span class="cn">b</span> = <span class="dv">0</span> <span class="kw">then</span> <span class="cn">x</span> <span class="kw">elseif</span> <span class="cn">k</span> &lt; <span class="cn">b</span> <span class="kw">then</span> <span class="cn">x</span> <span class="kw">else</span> -<span class="cn">x</span>,</a>
<a class="sourceLine" id="cb3-48" title="48">        <span class="cn">eq</span>: <span class="cn">eq</span> + (<span class="dv">-1</span>)^<span class="cn">k</span> * <span class="fu">binomial</span>(<span class="cn">M</span>, <span class="cn">k</span>) * <span class="cn">replaceabs</span>(</a>
<a class="sourceLine" id="cb3-49" title="49">          <span class="fu">subst</span>(<span class="cn">s</span>(<span class="cn">n</span> - <span class="cn">k</span>, <span class="cn">boundary</span>), <span class="cn">x</span>, <span class="cn">dpw</span>[<span class="cn">N</span>]),</a>
<a class="sourceLine" id="cb3-50" title="50">          <span class="kw">if</span> <span class="cn">b</span> = <span class="dv">0</span> <span class="kw">then</span> <span class="dv">-1</span> <span class="kw">elseif</span> <span class="cn">k</span> &lt; <span class="cn">b</span> <span class="kw">then</span> <span class="dv">-1</span> <span class="kw">else</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb3-51" title="51">        )</a>
<a class="sourceLine" id="cb3-52" title="52">      ),</a>
<a class="sourceLine" id="cb3-53" title="53">      <span class="cn">result</span>: <span class="fu">endcons</span>(<span class="cn">eq</span>, <span class="cn">result</span>)</a>
<a class="sourceLine" id="cb3-54" title="54">    ),</a>
<a class="sourceLine" id="cb3-55" title="55">    <span class="cn">result</span> * <span class="dv">2</span> / (<span class="dv">2</span> * <span class="cn">T</span>)^(<span class="cn">N</span> - <span class="dv">1</span>) / <span class="cn">N</span>!</a>
<a class="sourceLine" id="cb3-56" title="56">  ),</a>
<a class="sourceLine" id="cb3-57" title="57"></a>
<a class="sourceLine" id="cb3-58" title="58">  <span class="cn">ptr</span>: <span class="cn">y</span>(<span class="cn">dpw</span>, <span class="cn">N</span>, <span class="kw">if</span> <span class="fu">oddp</span>(<span class="cn">N</span>) <span class="kw">then</span> <span class="cn">s_odd</span> <span class="kw">else</span> <span class="cn">s_even</span>),</a>
<a class="sourceLine" id="cb3-59" title="59">  <span class="cn">ptr</span>: <span class="fu">expand</span>(<span class="fu">ratsimp</span>(<span class="cn">ptr</span>)),</a>
<a class="sourceLine" id="cb3-60" title="60">  <span class="cn">ptr</span></a>
<a class="sourceLine" id="cb3-61" title="61">);</a>
<a class="sourceLine" id="cb3-62" title="62"></a>
<a class="sourceLine" id="cb3-63" title="63"><span class="cn">dispptrtri</span>(<span class="cn">dpwtri</span>) := <span class="fu">block</span>([<span class="cn">N</span>: <span class="fu">length</span>(<span class="cn">dpwtri</span>)],</a>
<a class="sourceLine" id="cb3-64" title="64">  <span class="kw">for</span> <span class="cn">i</span>: <span class="dv">1</span> <span class="kw">thru</span> <span class="cn">N</span> <span class="kw">do</span> <span class="fu">block</span>([<span class="cn">eq</span>],</a>
<a class="sourceLine" id="cb3-65" title="65">    <span class="cn">eq</span>: <span class="cn">PTRTri</span>(<span class="cn">dpwtri</span>, <span class="cn">i</span>),</a>
<a class="sourceLine" id="cb3-66" title="66">    <span class="fu">disp</span>(<span class="fu">concat</span>(<span class="do">&#39;</span><span class="cn">PTRTri</span>, <span class="cn">i</span> - <span class="dv">1</span>)),</a>
<a class="sourceLine" id="cb3-67" title="67">    <span class="kw">for</span> <span class="cn">j</span>: <span class="dv">1</span> <span class="kw">thru</span> <span class="fu">length</span>(<span class="cn">eq</span>) <span class="kw">do</span> <span class="fu">disp</span>([<span class="cn">eq</span>[<span class="cn">j</span>]])</a>
<a class="sourceLine" id="cb3-68" title="68">  )</a>
<a class="sourceLine" id="cb3-69" title="69">);</a>
<a class="sourceLine" id="cb3-70" title="70"></a>
<a class="sourceLine" id="cb3-71" title="71"><span class="cn">dispptrlist</span>(<span class="cn">dpw</span>) := <span class="fu">block</span>([<span class="cn">L</span>: []],</a>
<a class="sourceLine" id="cb3-72" title="72">  <span class="kw">for</span> <span class="cn">i</span>: <span class="dv">1</span> <span class="kw">thru</span> <span class="fu">length</span>(<span class="cn">dpw</span>) <span class="kw">do</span> <span class="cn">L</span>: <span class="fu">endcons</span>(<span class="cn">PTRTri</span>(<span class="cn">dpw</span>, <span class="cn">i</span>), <span class="cn">L</span>),</a>
<a class="sourceLine" id="cb3-73" title="73">  <span class="cn">L</span></a>
<a class="sourceLine" id="cb3-74" title="74">);</a>
<a class="sourceLine" id="cb3-75" title="75"></a>
<a class="sourceLine" id="cb3-76" title="76"><span class="cn">dpwtri</span>: <span class="cn">DPWTri</span>(<span class="dv">11</span>);</a>
<a class="sourceLine" id="cb3-77" title="77"><span class="cn">dispptrtri</span>(<span class="cn">dpwtri</span>);</a></code></pre></div>
<h2 id="ramp">Ramp</h2>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Ramp_function">Ramp function - Wikipedia</a></li>
</ul>
<p>Saw を元にして境界の向こう側を 0 に置き直しました。</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode maxima"><code class="sourceCode maxima"><a class="sourceLine" id="cb4-1" title="1"><span class="cn">DPWRamp</span>(<span class="cn">N</span>) := <span class="fu">block</span>([<span class="cn">result</span>: [], <span class="cn">eq</span>: <span class="cn">x</span> + <span class="dv">1</span> = <span class="dv">0</span>],</a>
<a class="sourceLine" id="cb4-2" title="2">  <span class="va">integration_constant</span>: <span class="do">&#39;</span><span class="cn">C</span>,</a>
<a class="sourceLine" id="cb4-3" title="3">  <span class="fu">reset</span>(<span class="va">integration_constant_counter</span>),</a>
<a class="sourceLine" id="cb4-4" title="4">  <span class="kw">for</span> <span class="cn">i</span>: <span class="dv">1</span> <span class="kw">thru</span> <span class="cn">N</span> <span class="kw">do</span> <span class="fu">block</span>([<span class="cn">a</span>, <span class="cn">c</span>],</a>
<a class="sourceLine" id="cb4-5" title="5">    <span class="cn">eq</span>: <span class="fu">integrate</span>(<span class="cn">eq</span>, <span class="cn">x</span>),</a>
<a class="sourceLine" id="cb4-6" title="6">    <span class="cn">a</span>: <span class="fu">rhs</span>(<span class="fu">solve</span>(<span class="cn">eq</span>, <span class="fu">concat</span>(<span class="do">&#39;</span><span class="cn">C</span>, <span class="cn">i</span>))[<span class="dv">1</span>]),</a>
<a class="sourceLine" id="cb4-7" title="7">    <span class="kw">if</span> <span class="cn">i</span> &gt; <span class="dv">1</span> <span class="kw">then</span> (</a>
<a class="sourceLine" id="cb4-8" title="8">      <span class="co">/* solve の式を変更。 */</span></a>
<a class="sourceLine" id="cb4-9" title="9">      <span class="cn">c</span>: <span class="fu">rhs</span>(<span class="fu">solve</span>(<span class="fu">subst</span>(<span class="dv">-1</span>, <span class="cn">x</span>, <span class="cn">a</span>) = <span class="dv">0</span>, <span class="fu">concat</span>(<span class="do">&#39;</span><span class="cn">C</span>, <span class="cn">i</span> - <span class="dv">1</span>))[<span class="dv">1</span>]),</a>
<a class="sourceLine" id="cb4-10" title="10">      <span class="cn">a</span>: <span class="fu">subst</span>(<span class="cn">c</span>, <span class="fu">concat</span>(<span class="do">&#39;</span><span class="cn">C</span>, <span class="cn">i</span> - <span class="dv">1</span>), <span class="cn">a</span>),</a>
<a class="sourceLine" id="cb4-11" title="11">      <span class="cn">eq</span>: <span class="fu">subst</span>(<span class="cn">c</span>, <span class="fu">concat</span>(<span class="do">&#39;</span><span class="cn">C</span>, <span class="cn">i</span> - <span class="dv">1</span>), <span class="cn">eq</span>)</a>
<a class="sourceLine" id="cb4-12" title="12">    ),</a>
<a class="sourceLine" id="cb4-13" title="13">    <span class="cn">a</span>: <span class="fu">num</span>(<span class="cn">a</span>),</a>
<a class="sourceLine" id="cb4-14" title="14">    <span class="cn">a</span>: <span class="cn">a</span> / <span class="fu">coeff</span>(<span class="cn">a</span>, <span class="cn">x</span>, <span class="fu">hipow</span>(<span class="cn">a</span>, <span class="cn">x</span>)),</a>
<a class="sourceLine" id="cb4-15" title="15">    <span class="cn">result</span>: <span class="fu">endcons</span>(<span class="fu">expand</span>(<span class="cn">a</span>), <span class="cn">result</span>)</a>
<a class="sourceLine" id="cb4-16" title="16">  ),</a>
<a class="sourceLine" id="cb4-17" title="17">  <span class="cn">push</span>(<span class="cn">x</span>, <span class="cn">result</span>)</a>
<a class="sourceLine" id="cb4-18" title="18">);</a>
<a class="sourceLine" id="cb4-19" title="19"></a>
<a class="sourceLine" id="cb4-20" title="20"><span class="cn">PTRRamp</span>(<span class="cn">dpw</span>, <span class="cn">N</span>) := <span class="fu">block</span>([<span class="cn">ptr</span>],</a>
<a class="sourceLine" id="cb4-21" title="21">  <span class="cn">removeTinverse</span>(<span class="cn">eq</span>) := <span class="fu">block</span>([<span class="cn">r</span>: <span class="dv">0</span>],</a>
<a class="sourceLine" id="cb4-22" title="22">    <span class="kw">if</span> <span class="fu">atom</span>(<span class="cn">eq</span>) <span class="kw">then</span> <span class="cn">r</span>: <span class="cn">eq</span></a>
<a class="sourceLine" id="cb4-23" title="23">    <span class="kw">else</span> <span class="kw">for</span> <span class="cn">term</span> <span class="kw">in</span> <span class="fu">args</span>(<span class="cn">eq</span>) <span class="kw">do</span> <span class="fu">block</span>([<span class="cn">den</span>],</a>
<a class="sourceLine" id="cb4-24" title="24">      <span class="cn">den</span>: <span class="fu">denom</span>(<span class="cn">term</span>),</a>
<a class="sourceLine" id="cb4-25" title="25">      <span class="kw">if</span> <span class="fu">atom</span>(<span class="cn">den</span>) <span class="kw">then</span></a>
<a class="sourceLine" id="cb4-26" title="26">        <span class="kw">if</span> <span class="cn">den</span> # <span class="cn">T</span> <span class="kw">then</span> <span class="cn">r</span>: <span class="cn">r</span> + <span class="cn">term</span></a>
<a class="sourceLine" id="cb4-27" title="27">    ),</a>
<a class="sourceLine" id="cb4-28" title="28">    <span class="cn">r</span></a>
<a class="sourceLine" id="cb4-29" title="29">  ),</a>
<a class="sourceLine" id="cb4-30" title="30"></a>
<a class="sourceLine" id="cb4-31" title="31">  <span class="cn">phi</span>(<span class="cn">n</span>, <span class="cn">boundary</span>) :=</a>
<a class="sourceLine" id="cb4-32" title="32">    <span class="kw">if</span> <span class="cn">boundary</span> = <span class="do">&#39;</span><span class="cn">n</span> <span class="kw">or</span> <span class="cn">n</span> &gt; <span class="cn">boundary</span> <span class="kw">then</span> <span class="cn">n</span> * <span class="cn">T</span></a>
<a class="sourceLine" id="cb4-33" title="33">    <span class="kw">else</span> <span class="dv">0</span>, <span class="co">/* 境界を超えると 0 。 */</span></a>
<a class="sourceLine" id="cb4-34" title="34"></a>
<a class="sourceLine" id="cb4-35" title="35">  <span class="cn">s</span>(<span class="cn">n</span>, <span class="cn">boundary</span>) := <span class="dv">2</span> * <span class="cn">phi</span>(<span class="cn">n</span>, <span class="cn">boundary</span>) - <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb4-36" title="36"></a>
<a class="sourceLine" id="cb4-37" title="37">  <span class="cn">y</span>(<span class="cn">dpw</span>, <span class="cn">N</span>) := <span class="fu">block</span>([<span class="cn">M</span>: <span class="cn">N</span> - <span class="dv">1</span>, <span class="cn">result</span>: []],</a>
<a class="sourceLine" id="cb4-38" title="38">    <span class="kw">for</span> <span class="cn">b</span>: <span class="dv">0</span> <span class="kw">thru</span> <span class="cn">M</span> <span class="kw">do</span> <span class="fu">block</span>([<span class="cn">eq</span>: <span class="dv">0</span>],</a>
<a class="sourceLine" id="cb4-39" title="39">      <span class="kw">for</span> <span class="cn">k</span>: <span class="dv">0</span> <span class="kw">thru</span> <span class="cn">M</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb4-40" title="40">        <span class="cn">eq</span>: <span class="cn">eq</span> + (<span class="dv">-1</span>)^<span class="cn">k</span> * <span class="fu">binomial</span>(<span class="cn">M</span>, <span class="cn">k</span>) * <span class="fu">subst</span>(<span class="cn">s</span>(<span class="cn">n</span> - <span class="cn">k</span>, <span class="cn">n</span> - <span class="cn">b</span>), <span class="cn">x</span>, <span class="cn">dpw</span>[<span class="cn">N</span>]),</a>
<a class="sourceLine" id="cb4-41" title="41">      <span class="cn">result</span>: <span class="fu">endcons</span>(<span class="cn">eq</span>, <span class="cn">result</span>)</a>
<a class="sourceLine" id="cb4-42" title="42">    ),</a>
<a class="sourceLine" id="cb4-43" title="43">    <span class="cn">result</span> / (<span class="dv">2</span> * <span class="cn">T</span>)^(<span class="cn">N</span> - <span class="dv">1</span>) / <span class="cn">N</span>!</a>
<a class="sourceLine" id="cb4-44" title="44">  ),</a>
<a class="sourceLine" id="cb4-45" title="45"></a>
<a class="sourceLine" id="cb4-46" title="46">  <span class="cn">ptr</span>: <span class="fu">expand</span>(<span class="fu">ratsimp</span>(<span class="cn">y</span>(<span class="cn">dpw</span>, <span class="cn">N</span>))),</a>
<a class="sourceLine" id="cb4-47" title="47">  <span class="kw">for</span> <span class="cn">i</span>: <span class="dv">1</span> <span class="kw">thru</span> <span class="fu">length</span>(<span class="cn">ptr</span>) <span class="kw">do</span> <span class="cn">ptr</span>[<span class="cn">i</span>]: <span class="cn">removeTinverse</span>(<span class="cn">ptr</span>[<span class="cn">i</span>]),</a>
<a class="sourceLine" id="cb4-48" title="48">  <span class="cn">ptr</span></a>
<a class="sourceLine" id="cb4-49" title="49">);</a>
<a class="sourceLine" id="cb4-50" title="50"></a>
<a class="sourceLine" id="cb4-51" title="51"><span class="cn">dispptrramp</span>(<span class="cn">dpwramp</span>) := <span class="fu">block</span>([<span class="cn">N</span>: <span class="fu">length</span>(<span class="cn">dpwramp</span>)],</a>
<a class="sourceLine" id="cb4-52" title="52">  <span class="kw">for</span> <span class="cn">i</span>: <span class="dv">1</span> <span class="kw">thru</span> <span class="cn">N</span> <span class="kw">do</span> <span class="fu">block</span>([<span class="cn">eq</span>],</a>
<a class="sourceLine" id="cb4-53" title="53">    <span class="cn">eq</span>: <span class="cn">PTRRamp</span>(<span class="cn">dpwramp</span>, <span class="cn">i</span>),</a>
<a class="sourceLine" id="cb4-54" title="54"></a>
<a class="sourceLine" id="cb4-55" title="55">    <span class="fu">disp</span>(<span class="fu">concat</span>(<span class="do">&#39;</span><span class="cn">PTRRamp</span>, <span class="cn">i</span> - <span class="dv">1</span>)),</a>
<a class="sourceLine" id="cb4-56" title="56">    <span class="fu">disp</span>([(<span class="fu">length</span>(<span class="cn">eq</span>) - <span class="dv">1</span>) * <span class="cn">T</span> &lt;= <span class="cn">phi</span>, <span class="cn">eq</span>[<span class="dv">1</span>]]),</a>
<a class="sourceLine" id="cb4-57" title="57">    <span class="kw">for</span> <span class="cn">j</span>: <span class="dv">2</span> <span class="kw">thru</span> <span class="fu">length</span>(<span class="cn">eq</span>) <span class="kw">do</span></a>
<a class="sourceLine" id="cb4-58" title="58">      <span class="fu">disp</span>([(<span class="cn">j</span> - <span class="dv">2</span>) * <span class="cn">T</span> &lt;= <span class="cn">phi</span> <span class="kw">and</span> <span class="cn">phi</span> &lt; (<span class="cn">j</span> - <span class="dv">1</span>) * <span class="cn">T</span>, <span class="cn">eq</span>[<span class="cn">j</span>]])</a>
<a class="sourceLine" id="cb4-59" title="59">  )</a>
<a class="sourceLine" id="cb4-60" title="60">);</a>
<a class="sourceLine" id="cb4-61" title="61"></a>
<a class="sourceLine" id="cb4-62" title="62"><span class="cn">dispptrlist</span>(<span class="cn">dpw</span>) := <span class="fu">block</span>([<span class="cn">L</span>: []],</a>
<a class="sourceLine" id="cb4-63" title="63">  <span class="kw">for</span> <span class="cn">i</span>: <span class="dv">1</span> <span class="kw">thru</span> <span class="fu">length</span>(<span class="cn">dpw</span>) <span class="kw">do</span> <span class="cn">L</span>: <span class="fu">endcons</span>(<span class="cn">PTRRamp</span>(<span class="cn">dpw</span>, <span class="cn">i</span>), <span class="cn">L</span>),</a>
<a class="sourceLine" id="cb4-64" title="64">  <span class="cn">L</span></a>
<a class="sourceLine" id="cb4-65" title="65">);</a>
<a class="sourceLine" id="cb4-66" title="66"></a>
<a class="sourceLine" id="cb4-67" title="67"><span class="cn">dpwramp</span>: <span class="cn">DPWRamp</span>(<span class="dv">10</span>);</a>
<a class="sourceLine" id="cb4-68" title="68"><span class="cn">dispptrramp</span>(<span class="cn">dpwramp</span>);</a></code></pre></div>
<h2 id="step">Step</h2>
<p>Ramp 関数の微分です。</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Heaviside_step_function">Heaviside step function - Wikipedia</a></li>
</ul>
<div class="sourceCode" id="cb5"><pre class="sourceCode maxima"><code class="sourceCode maxima"><a class="sourceLine" id="cb5-1" title="1"><span class="cn">DPWStep</span>(<span class="cn">N</span>) := <span class="fu">block</span>([<span class="cn">result</span>: [], <span class="cn">eq</span>: <span class="cn">x</span> + <span class="dv">1</span> = <span class="dv">0</span>],</a>
<a class="sourceLine" id="cb5-2" title="2">  <span class="va">integration_constant</span>: <span class="do">&#39;</span><span class="cn">C</span>,</a>
<a class="sourceLine" id="cb5-3" title="3">  <span class="fu">reset</span>(<span class="va">integration_constant_counter</span>),</a>
<a class="sourceLine" id="cb5-4" title="4">  <span class="kw">for</span> <span class="cn">i</span>: <span class="dv">1</span> <span class="kw">thru</span> <span class="cn">N</span> <span class="kw">do</span> <span class="fu">block</span>([<span class="cn">a</span>, <span class="cn">c</span>],</a>
<a class="sourceLine" id="cb5-5" title="5">    <span class="cn">eq</span>: <span class="fu">integrate</span>(<span class="cn">eq</span>, <span class="cn">x</span>),</a>
<a class="sourceLine" id="cb5-6" title="6">    <span class="cn">a</span>: <span class="fu">rhs</span>(<span class="fu">solve</span>(<span class="cn">eq</span>, <span class="fu">concat</span>(<span class="do">&#39;</span><span class="cn">C</span>, <span class="cn">i</span>))[<span class="dv">1</span>]),</a>
<a class="sourceLine" id="cb5-7" title="7">    <span class="kw">if</span> <span class="cn">i</span> &gt; <span class="dv">1</span> <span class="kw">then</span> (</a>
<a class="sourceLine" id="cb5-8" title="8">      <span class="cn">c</span>: <span class="fu">rhs</span>(<span class="fu">solve</span>(<span class="fu">subst</span>(<span class="dv">-1</span>, <span class="cn">x</span>, <span class="cn">a</span>) = <span class="dv">0</span>, <span class="fu">concat</span>(<span class="do">&#39;</span><span class="cn">C</span>, <span class="cn">i</span> - <span class="dv">1</span>))[<span class="dv">1</span>]),</a>
<a class="sourceLine" id="cb5-9" title="9">      <span class="cn">a</span>: <span class="fu">subst</span>(<span class="cn">c</span>, <span class="fu">concat</span>(<span class="do">&#39;</span><span class="cn">C</span>, <span class="cn">i</span> - <span class="dv">1</span>), <span class="cn">a</span>),</a>
<a class="sourceLine" id="cb5-10" title="10">      <span class="cn">eq</span>: <span class="fu">subst</span>(<span class="cn">c</span>, <span class="fu">concat</span>(<span class="do">&#39;</span><span class="cn">C</span>, <span class="cn">i</span> - <span class="dv">1</span>), <span class="cn">eq</span>)</a>
<a class="sourceLine" id="cb5-11" title="11">    ),</a>
<a class="sourceLine" id="cb5-12" title="12">    <span class="cn">a</span>: <span class="fu">num</span>(<span class="cn">a</span>),</a>
<a class="sourceLine" id="cb5-13" title="13">    <span class="cn">a</span>: <span class="cn">a</span> / <span class="fu">coeff</span>(<span class="cn">a</span>, <span class="cn">x</span>, <span class="fu">hipow</span>(<span class="cn">a</span>, <span class="cn">x</span>)),</a>
<a class="sourceLine" id="cb5-14" title="14">    <span class="cn">result</span>: <span class="fu">endcons</span>(<span class="fu">diff</span>(<span class="fu">expand</span>(<span class="cn">a</span>), <span class="cn">x</span>), <span class="cn">result</span>) <span class="co">/* diff を追加。 */</span></a>
<a class="sourceLine" id="cb5-15" title="15">  ),</a>
<a class="sourceLine" id="cb5-16" title="16">  <span class="cn">push</span>(<span class="cn">x</span>, <span class="cn">result</span>)</a>
<a class="sourceLine" id="cb5-17" title="17">);</a>
<a class="sourceLine" id="cb5-18" title="18"></a>
<a class="sourceLine" id="cb5-19" title="19"><span class="cn">PTRStep</span>(<span class="cn">dpw</span>, <span class="cn">N</span>) := <span class="fu">block</span>([<span class="cn">ptr</span>],</a>
<a class="sourceLine" id="cb5-20" title="20">  <span class="cn">removeTinverse</span>(<span class="cn">eq</span>) := <span class="fu">block</span>([<span class="cn">r</span>: <span class="dv">0</span>],</a>
<a class="sourceLine" id="cb5-21" title="21">    <span class="kw">if</span> <span class="fu">atom</span>(<span class="cn">eq</span>) <span class="kw">then</span> <span class="cn">r</span>: <span class="cn">eq</span></a>
<a class="sourceLine" id="cb5-22" title="22">    <span class="kw">else</span> <span class="kw">for</span> <span class="cn">term</span> <span class="kw">in</span> <span class="fu">args</span>(<span class="cn">eq</span>) <span class="kw">do</span> <span class="fu">block</span>([<span class="cn">den</span>],</a>
<a class="sourceLine" id="cb5-23" title="23">      <span class="cn">den</span>: <span class="fu">denom</span>(<span class="cn">term</span>),</a>
<a class="sourceLine" id="cb5-24" title="24">      <span class="kw">if</span> <span class="fu">atom</span>(<span class="cn">den</span>) <span class="kw">then</span></a>
<a class="sourceLine" id="cb5-25" title="25">        <span class="kw">if</span> <span class="cn">den</span> # <span class="cn">T</span> <span class="kw">then</span> <span class="cn">r</span>: <span class="cn">r</span> + <span class="cn">term</span></a>
<a class="sourceLine" id="cb5-26" title="26">    ),</a>
<a class="sourceLine" id="cb5-27" title="27">    <span class="cn">r</span></a>
<a class="sourceLine" id="cb5-28" title="28">  ),</a>
<a class="sourceLine" id="cb5-29" title="29"></a>
<a class="sourceLine" id="cb5-30" title="30">  <span class="cn">phi</span>(<span class="cn">n</span>, <span class="cn">boundary</span>) :=</a>
<a class="sourceLine" id="cb5-31" title="31">    <span class="kw">if</span> <span class="cn">boundary</span> = <span class="do">&#39;</span><span class="cn">n</span> <span class="kw">or</span> <span class="cn">n</span> &gt; <span class="cn">boundary</span> <span class="kw">then</span> <span class="cn">n</span> * <span class="cn">T</span></a>
<a class="sourceLine" id="cb5-32" title="32">    <span class="kw">else</span> <span class="cn">h</span>, <span class="co">/* 0 でも h でも結果が同じになる。 */</span></a>
<a class="sourceLine" id="cb5-33" title="33"></a>
<a class="sourceLine" id="cb5-34" title="34">  <span class="cn">s</span>(<span class="cn">n</span>, <span class="cn">boundary</span>) := <span class="dv">2</span> * <span class="cn">phi</span>(<span class="cn">n</span>, <span class="cn">boundary</span>) - <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb5-35" title="35"></a>
<a class="sourceLine" id="cb5-36" title="36">  <span class="cn">y</span>(<span class="cn">dpw</span>, <span class="cn">N</span>) := <span class="fu">block</span>([<span class="cn">M</span>: <span class="cn">N</span> - <span class="dv">1</span>, <span class="cn">result</span>: []],</a>
<a class="sourceLine" id="cb5-37" title="37">    <span class="kw">for</span> <span class="cn">b</span>: <span class="dv">0</span> <span class="kw">thru</span> <span class="cn">M</span> <span class="kw">do</span> <span class="fu">block</span>([<span class="cn">eq</span>: <span class="dv">0</span>],</a>
<a class="sourceLine" id="cb5-38" title="38">      <span class="kw">for</span> <span class="cn">k</span>: <span class="dv">0</span> <span class="kw">thru</span> <span class="cn">M</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb5-39" title="39">        <span class="cn">eq</span>: <span class="cn">eq</span> + (<span class="dv">-1</span>)^<span class="cn">k</span> * <span class="fu">binomial</span>(<span class="cn">M</span>, <span class="cn">k</span>) * <span class="fu">subst</span>(<span class="cn">s</span>(<span class="cn">n</span> - <span class="cn">k</span>, <span class="cn">n</span> - <span class="cn">b</span>), <span class="cn">x</span>, <span class="cn">dpw</span>[<span class="cn">N</span>]),</a>
<a class="sourceLine" id="cb5-40" title="40">      <span class="cn">result</span>: <span class="fu">endcons</span>(<span class="cn">eq</span>, <span class="cn">result</span>)</a>
<a class="sourceLine" id="cb5-41" title="41">    ),</a>
<a class="sourceLine" id="cb5-42" title="42">    <span class="cn">result</span> / (<span class="dv">2</span> * <span class="cn">T</span>)^(<span class="cn">N</span> - <span class="dv">1</span>) / <span class="cn">N</span>!</a>
<a class="sourceLine" id="cb5-43" title="43">  ),</a>
<a class="sourceLine" id="cb5-44" title="44"></a>
<a class="sourceLine" id="cb5-45" title="45">  <span class="cn">ptr</span>: <span class="fu">expand</span>(<span class="fu">ratsimp</span>(<span class="cn">y</span>(<span class="cn">dpw</span>, <span class="cn">N</span>))),</a>
<a class="sourceLine" id="cb5-46" title="46">  <span class="kw">for</span> <span class="cn">i</span>: <span class="dv">1</span> <span class="kw">thru</span> <span class="fu">length</span>(<span class="cn">ptr</span>) <span class="kw">do</span> <span class="cn">ptr</span>[<span class="cn">i</span>]: <span class="cn">removeTinverse</span>(<span class="cn">ptr</span>[<span class="cn">i</span>]),</a>
<a class="sourceLine" id="cb5-47" title="47">  <span class="cn">ptr</span></a>
<a class="sourceLine" id="cb5-48" title="48">);</a>
<a class="sourceLine" id="cb5-49" title="49"></a>
<a class="sourceLine" id="cb5-50" title="50"><span class="cn">dpwstep</span>: <span class="cn">DPWStep</span>(<span class="dv">10</span>);</a>
<a class="sourceLine" id="cb5-51" title="51"><span class="cn">dispptrramp</span>(<span class="cn">dpwstep</span>);</a></code></pre></div>


  <footer>
    <a href="../index.html">インデックスに戻る</a>
  </footer>
</body>

</html>

