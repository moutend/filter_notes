<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="" >

<head>
<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<meta name="dcterms.date" content="2020-04-05" />
<title>doublefilter</title>

<!-- highlight.js -->
<link rel="stylesheet" href="../script/highlight/idea.css">
<script src="../script/highlight/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<!-- KaTeX -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.css"
integrity="sha384-yFRtMMDnQtDRO8rLpMIKrtPCD5jdktao2TV19YiZYWMDkUR5GQZR/NOVTdquEx1j" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.js"
integrity="sha384-9Nhn55MVVN0/4OFx7EE5kpFBPsEMZxKTCnA+4fqDmg12eCTqGi6+BB2LjY8brQxJ"
crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/contrib/auto-render.min.js"
integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"
onload="renderMathInElement(document.body);"></script>

<style>
body {
max-width: 704px;
margin: auto;
padding: 32px 8px;
font-size: 14px;
}

img {
max-width: 100%;
}

video {
max-width: 100%;
}

kbd {
border-style: solid;
border-width: 1px 2px 2px 1px;
border-radius: 2px;
padding: 2px;
margin: 2px;
}

a {
text-decoration: none;
}

h1,
h2,
h3,
h4,
h5,
h6 {
border-left: solid 8px #eeeeee;
padding-left: 8px;
}

table {
border-spacing: 0px;
border-collapse: separate;
border: 1px solid #dddddd;
}

tr.header {
border: 1px solid black;
}

tr.odd {
background: #eeeeee;
}

tr.even {
background: #ffffff;
}

th {
height: 2em;
font-weight: normal;
color: #004444;
padding-left: 0.35em;
padding-right: 0.35em;
border-bottom: 3px solid #dddddd;
border-left: 1px solid #dddddd;
}

td {
height: 1.5em;
padding-left: 0.35em;
padding-right: 0.35em;
border-bottom: 1px solid #dddddd;
border-left: 1px solid #dddddd;
}

audio {
vertical-align: middle;
}

label {
vertical-align: middle;
}

code {
color: #004444;
}

pre code {
border: 4px solid #eeeeee;
}

li {
margin: 8px;
}

header {
border-bottom: 1px gray solid;
padding: 0.5em;
margin-bottom: 1em;
}

footer {
border-top: 1px gray solid;
padding: 0.5em;
margin-top: 1em;
}

summary:hover {
background-color: #eeeeee;
}

canvas {
/* image-rendering: pixelated; */
display: inline-block;
border-style: solid;
border-width: 1px;
border-color: #627f84;
}

.controlBlock {
display: inline-block;
width: 450px;
text-align: left;
vertical-align: top;
margin-left: 4px;
}

input[type="button"] {
background-color: #ffffff;
border: 2px solid #aaaaaa;
font-size: 16px;
height: 32px;
}

input[type="button"]:hover {
background-color: #ffffff;
border: 2px solid #aaccff;
}

div.numberInput {
display: block;
white-space: nowrap;
}

div.numberInput:hover {
background-color: #e0ecff;
}

.numberInputLabel {
/* max 12 letter  */
display: inline-block;
margin: 0 8px 0 8px;
text-align: left;
vertical-align: middle;
width: 100px;

font-size: 10pt;
font-family: 'Courier New', Courier, monospace;
}

.numberInputNumber {
display: inline-block;
vertical-align: middle;
width: 120px;
}

.numberInputRange {
display: inline-block;
vertical-align: middle;
width: 160px;
}

.pullDownMenu {
display: inline-block;
text-align: center;
}

.pullDownMenu:hover {
background-color: #e0ecff;
}

select {
background-color: #ffffff;
border: 2px solid #aaaaaa;
height: 24px;
vertical-align: middle;
font-size: 12px;
}

select:hover {
background-color: #ffffff;
border: 2px solid #aaccff;
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS_CHTML-full" type="text/javascript"></script>
</head>

<body>
<header>
<p>
何かあれば <a href="https://github.com/ryukau/filter_notes">GitHub のリポジトリ</a>に issue を作るか ryukau@gmail.com までお気軽にどうぞ。
</p>
<hr>
<a href="../index.html">インデックスに戻る</a>
<p>
Update: 2020-04-05
</p>
<details>
<summary translate="yes">Table of Contents</summary>
<nav id="TOC" role="doc-toc">
  <ul>
  <li><a href="#変な-4-pole-フィルタ">変な 4-pole フィルタ</a><ul>
  <li><a href="#出力-u_2-の伝達関数">出力 <span class="math inline">\(u_2\)</span> の伝達関数</a></li>
  <li><a href="#ローパスのカットオフ周波数のチューニング">ローパスのカットオフ周波数のチューニング</a></li>
  <li><a href="#レゾナンスのチューニング">レゾナンスのチューニング</a><ul>
  <li><a href="#発散を防ぐ">発散を防ぐ</a></li>
  </ul></li>
  <li><a href="#出力ゲインのチューニング">出力ゲインのチューニング</a></li>
  <li><a href="#出力-u_1">出力 <span class="math inline">\(u_1\)</span></a></li>
  <li><a href="#実装">実装</a></li>
  <li><a href="#音のサンプル">音のサンプル</a><ul>
  <li><a href="#出力-u_2-ローパス">出力 <span class="math inline">\(u_2\)</span> (ローパス)</a></li>
  <li><a href="#出力-u_1-ハイパス">出力 <span class="math inline">\(u_1\)</span> (ハイパス)</a></li>
  </ul></li>
  <li><a href="#その他">その他</a><ul>
  <li><a href="#出力-u_1-の伝達関数">出力 <span class="math inline">\(u_1\)</span> の伝達関数</a></li>
  </ul></li>
  <li><a href="#参考サイト">参考サイト</a></li>
  </ul></li>
  </ul>
</nav>
</details>
</header>
<h1 id="変な-4-pole-フィルタ">変な 4-pole フィルタ</h1>
<p><a href="https://www.myphysicslab.com/springs/double-spring-en.html">2 重ばねの式</a>から適当に係数などを入れ替えて次のコードを作りました。</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">class</span> Model:</a>
<a class="sourceLine" id="cb1-2" title="2">    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, k1, k2):</a>
<a class="sourceLine" id="cb1-3" title="3">        <span class="va">self</span>.k1 <span class="op">=</span> k1</a>
<a class="sourceLine" id="cb1-4" title="4">        <span class="va">self</span>.k2 <span class="op">=</span> k2</a>
<a class="sourceLine" id="cb1-5" title="5"></a>
<a class="sourceLine" id="cb1-6" title="6">        <span class="va">self</span>.acc1 <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb1-7" title="7">        <span class="va">self</span>.vel1 <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb1-8" title="8">        <span class="va">self</span>.pos1 <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb1-9" title="9"></a>
<a class="sourceLine" id="cb1-10" title="10">        <span class="va">self</span>.acc2 <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb1-11" title="11">        <span class="va">self</span>.vel2 <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb1-12" title="12">        <span class="va">self</span>.pos2 <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb1-13" title="13"></a>
<a class="sourceLine" id="cb1-14" title="14">        <span class="va">self</span>.x1 <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb1-15" title="15"></a>
<a class="sourceLine" id="cb1-16" title="16">    <span class="kw">def</span> processLP(<span class="va">self</span>, x0):</a>
<a class="sourceLine" id="cb1-17" title="17">        <span class="va">self</span>.acc2 <span class="op">=</span> <span class="va">self</span>.k2 <span class="op">*</span> (<span class="va">self</span>.vel1 <span class="op">-</span> <span class="va">self</span>.vel2)</a>
<a class="sourceLine" id="cb1-18" title="18">        <span class="va">self</span>.vel2 <span class="op">+=</span> <span class="va">self</span>.acc2 <span class="op">+</span> x0 <span class="op">-</span> <span class="va">self</span>.x1</a>
<a class="sourceLine" id="cb1-19" title="19">        <span class="va">self</span>.pos2 <span class="op">+=</span> <span class="va">self</span>.vel2 <span class="op">*</span> <span class="va">self</span>.k2</a>
<a class="sourceLine" id="cb1-20" title="20"></a>
<a class="sourceLine" id="cb1-21" title="21">        <span class="va">self</span>.acc1 <span class="op">=</span> <span class="op">-</span><span class="va">self</span>.k1 <span class="op">*</span> <span class="va">self</span>.pos1 <span class="op">-</span> <span class="va">self</span>.acc2</a>
<a class="sourceLine" id="cb1-22" title="22">        <span class="va">self</span>.vel1 <span class="op">+=</span> <span class="va">self</span>.acc1</a>
<a class="sourceLine" id="cb1-23" title="23">        <span class="va">self</span>.pos1 <span class="op">+=</span> <span class="va">self</span>.vel1</a>
<a class="sourceLine" id="cb1-24" title="24"></a>
<a class="sourceLine" id="cb1-25" title="25">        <span class="va">self</span>.x1 <span class="op">=</span> x0</a>
<a class="sourceLine" id="cb1-26" title="26">        <span class="cf">return</span> <span class="va">self</span>.pos2</a></code></pre></div>
<p>この文章では上のコードのフィルタのことを DoubleFilter と呼ぶことにします。</p>
<p><code>pos1</code> からはハイパス、 <code>pos2</code> からはローパスに近い出力が出力が得られました。ローパスフィルタのほうが好きなので <code>pos2</code> について <code>k1</code> と <code>k2</code> をチューニングします。</p>
<p><code>k1</code> と <code>k2</code> について次のことが知りたいです。</p>
<ul>
<li>出力が発散しない値の範囲。</li>
<li>カットオフ周波数から <code>k1, k2</code> の値を決める式。</li>
<li>レゾナンスから <code>k1, k2</code> の値を決める式。</li>
</ul>
<h2 id="出力-u_2-の伝達関数">出力 <span class="math inline">\(u_2\)</span> の伝達関数</h2>
<p>コードを式に直します。</p>
<p><span class="math display">\[
\begin{aligned}
\ddot{u_2}[n] &amp;= k_2 (\dot{u_1}[n-1] - \dot{u_2}[n-1]) \\
\dot{u_2}[n] &amp;= \dot{u_2}[n-1] + \ddot{u_2}[n] + x[n] - x[n - 1] \\
u_2[n] &amp;= u_2[n-1] + k_2 \dot{u_2}[n] \\
\\
\ddot{u_1}[n] &amp;= -k_1 u_1[n-1] - \ddot{u_2}[n] \\
\dot{u_1}[n] &amp;= \dot{u_1}[n-1] + \ddot{u_1}[n] \\
u_1[n] &amp;= u_1[n-1] + \dot{u_1}[n] \\
\end{aligned}
\]</span></p>
<p><span class="math inline">\(u_2\)</span> の項だけが残るようにフィルタの式を変形します。</p>
<p><span class="math display">\[
\begin{aligned}
\dot{u_1}[n] &amp;= \frac{1}{k_2} \ddot{u_2}[n+1] - \dot{u_2}[n]   &amp;(1) \\
\ddot{u_2}[n] &amp;= \dot{u_2}[n] - \dot{u_2}[n-1] - x[n] + x[n-1] &amp;(2) \\
\dot{u_2}[n] &amp;= \frac{1}{k_2} (u_2[n] - u_2[n-1])                              &amp;(3) \\
\\
u_1[n] &amp;= \frac{1}{k_1} \left( - \ddot{u_1}[n+1] - \ddot{u_2}[n+1] \right) &amp;(4) \\
\ddot{u_1}[n] &amp;= \dot{u_1}[n] - \dot{u_1}[n-1] &amp;(5) \\
\dot{u_1}[n] &amp;= u_1[n] - u_1[n-1]              &amp;(6)\\
\end{aligned}
\]</span></p>
<p>次の手順で代入すると <span class="math inline">\(x\)</span> と <span class="math inline">\(u_2\)</span> の項だけの式になります。</p>
<ul>
<li>3 -&gt; 2 -&gt; 1</li>
<li>5 -&gt; 4 -&gt; 6</li>
<li>(3 -&gt; 2 -&gt; 1) -&gt; (5 -&gt; 4 -&gt; 6)</li>
</ul>
<p>Maxima で代入します。</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode maxima"><code class="sourceCode maxima"><a class="sourceLine" id="cb2-1" title="1"><span class="cn">d1_u1</span>(<span class="cn">n</span>) := <span class="cn">d2_u2</span>(<span class="cn">n</span> + <span class="dv">1</span>) / <span class="cn">k_2</span> - <span class="cn">d1_u2</span>(<span class="cn">n</span>);             <span class="co">/* (1) */</span></a>
<a class="sourceLine" id="cb2-2" title="2"><span class="cn">d2_u2</span>(<span class="cn">n</span>) := <span class="cn">d1_u2</span>(<span class="cn">n</span>) - <span class="cn">d1_u2</span>(<span class="cn">n</span> - <span class="dv">1</span>) - <span class="cn">x</span>(<span class="cn">n</span>) + <span class="cn">x</span>(<span class="cn">n</span> - <span class="dv">1</span>); <span class="co">/* (2) */</span></a>
<a class="sourceLine" id="cb2-3" title="3"><span class="cn">d1_u2</span>(<span class="cn">n</span>) := (<span class="cn">u_2</span>(<span class="cn">n</span>) - <span class="cn">u_2</span>(<span class="cn">n</span> - <span class="dv">1</span>)) / <span class="cn">k_2</span>;               <span class="co">/* (3) */</span></a>
<a class="sourceLine" id="cb2-4" title="4"><span class="cn">u_1</span>(<span class="cn">n</span>) := (-<span class="cn">d2_u1</span>(<span class="cn">n</span> + <span class="dv">1</span>) - <span class="cn">d2_u2</span>(<span class="cn">n</span> + <span class="dv">1</span>)) / <span class="cn">k_1</span>;        <span class="co">/* (4) */</span></a>
<a class="sourceLine" id="cb2-5" title="5"><span class="cn">d2_u1</span>(<span class="cn">n</span>) := <span class="cn">d1_u1</span>(<span class="cn">n</span>) - <span class="cn">d1_u1</span>(<span class="cn">n</span> - <span class="dv">1</span>);                   <span class="co">/* (5) */</span></a>
<a class="sourceLine" id="cb2-6" title="6"></a>
<a class="sourceLine" id="cb2-7" title="7"><span class="cn">result</span>: <span class="cn">d1_u1</span>(<span class="cn">n</span>) = <span class="cn">u_1</span>(<span class="cn">n</span>) - <span class="cn">u_1</span>(<span class="cn">n</span> - <span class="dv">1</span>);                <span class="co">/* (6) */</span></a>
<a class="sourceLine" id="cb2-8" title="8"></a>
<a class="sourceLine" id="cb2-9" title="9"><span class="fu">ratvars</span>(<span class="cn">u</span>(<span class="cn">n</span>), <span class="cn">u</span>(<span class="cn">n</span><span class="dv">-1</span>), <span class="cn">u</span>(<span class="cn">n</span><span class="dv">-2</span>), <span class="cn">u</span>(<span class="cn">n</span><span class="dv">-3</span>), <span class="cn">x</span>(<span class="cn">n</span>), <span class="cn">x</span>(<span class="cn">n</span><span class="dv">-1</span>), <span class="cn">x</span>(<span class="cn">n</span><span class="dv">-2</span>), <span class="cn">x</span>(<span class="cn">n</span><span class="dv">-3</span>));</a>
<a class="sourceLine" id="cb2-10" title="10"><span class="fu">ratexpand</span>(<span class="dv">0</span> = <span class="fu">rhs</span>(<span class="cn">result</span>) - <span class="fu">lhs</span>(<span class="cn">result</span>));</a></code></pre></div>
<p>出力に <span class="math inline">\(k_1 k_2\)</span> を掛けて整理した式です。</p>
<p><span class="math display">\[
\begin{aligned}
&amp;
x[n]
\ +\ (k_2 + k_1 - 3) x[n-1]
\ +\ (- 2 k_2 - k_1 + 3) x[n-2]
\ +\ ( k_2 - 1) x[n-3]
\\&amp;\quad=
\frac{1}{k_2} u_2[n]
\ +\ \frac{k_1 - 4}{k_2} u_2[n-1]
\ -\ \left( \frac{2 k_1 - 6}{k_2} + k_1 \right) u_2[n-2]
\\&amp;\qquad
\ +\ \left( \frac{k_1 - 4}{k_2} + k_1 \right) u_2[n-3]
\ +\ \frac{1}{k_2} u_2[n-4]
\end{aligned}
\]</span></p>
<p>伝達関数です。</p>
<p><span class="math display">\[
\begin{aligned}
&amp;H(z) = \frac{
  b_0 + b_1 z^{-1} + b_2 z^{-2} + b_3 z^{-3}
}{
  a_0 + a_1 z^{-1} + a_2 z^{-2} + a_3 z^{-3} + a_4 z^{-4}
}
\\&amp;
\\&amp;
\begin{aligned}
b_0 &amp;= 1 \\
b_1 &amp;= k_2 + k_1 - 3 \\
b_2 &amp;= - 2 k_2 - k_1 + 3 \\
b_3 &amp;= k_2 - 1 \\
\end{aligned}
\qquad \qquad
\begin{aligned}
a_0 &amp;= \frac{1}{k_2} \\
a_1 &amp;= \frac{k_1 - 4}{k_2} \\
a_2 &amp;= \frac{- 2 k_1 + 6}{k_2} - k_1 \\
a_3 &amp;= \frac{k_1 - 4}{k_2} + k_1 \\
a_4 &amp;= \frac{1}{k_2} \\
\end{aligned}
\end{aligned}
\]</span></p>
<p>次のコードは <code>scipy.signal</code> で使える形にした伝達関数です。</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">def</span> transferFunctionU2(k1, k2):</a>
<a class="sourceLine" id="cb3-2" title="2">    <span class="cf">return</span> (</a>
<a class="sourceLine" id="cb3-3" title="3">        [</a>
<a class="sourceLine" id="cb3-4" title="4">            <span class="dv">1</span>,                <span class="co"># b0</span></a>
<a class="sourceLine" id="cb3-5" title="5">            k2 <span class="op">+</span> k1 <span class="op">-</span> <span class="dv">3</span>,      <span class="co"># b1</span></a>
<a class="sourceLine" id="cb3-6" title="6">            <span class="dv">-2</span> <span class="op">*</span> k2 <span class="op">-</span> k1 <span class="op">+</span> <span class="dv">3</span>, <span class="co"># b2</span></a>
<a class="sourceLine" id="cb3-7" title="7">            k2 <span class="op">-</span> <span class="dv">1</span>,           <span class="co"># b3</span></a>
<a class="sourceLine" id="cb3-8" title="8">            <span class="dv">0</span>,                <span class="co"># b4 は無いので 0 。</span></a>
<a class="sourceLine" id="cb3-9" title="9">        ],</a>
<a class="sourceLine" id="cb3-10" title="10">        [</a>
<a class="sourceLine" id="cb3-11" title="11">            <span class="dv">1</span> <span class="op">/</span> k2,                  <span class="co"># a0</span></a>
<a class="sourceLine" id="cb3-12" title="12">            (k1 <span class="op">-</span> <span class="dv">4</span>) <span class="op">/</span> k2,           <span class="co"># a1</span></a>
<a class="sourceLine" id="cb3-13" title="13">            (<span class="op">-</span><span class="dv">2</span> <span class="op">*</span> k1 <span class="op">+</span> <span class="dv">6</span>) <span class="op">/</span> k2 <span class="op">-</span> k1, <span class="co"># a2</span></a>
<a class="sourceLine" id="cb3-14" title="14">            (k1 <span class="op">-</span> <span class="dv">4</span>) <span class="op">/</span> k2 <span class="op">+</span> k1,      <span class="co"># a3</span></a>
<a class="sourceLine" id="cb3-15" title="15">            <span class="dv">1</span> <span class="op">/</span> k2,                  <span class="co"># a4</span></a>
<a class="sourceLine" id="cb3-16" title="16">        ],</a>
<a class="sourceLine" id="cb3-17" title="17">    )</a></code></pre></div>
<h2 id="ローパスのカットオフ周波数のチューニング">ローパスのカットオフ周波数のチューニング</h2>
<p>プロットに使ったコードは <a href="https://ryukau.github.io/filter_notes/3pole_lowpass/3pole_lowpass.html">3-pole ローパスフィルタ</a> と同じなので省略します。</p>
<p>次の図は <span class="math inline">\(k_1\)</span> を <span class="math inline">\(\pi\)</span> に固定して <span class="math inline">\(k_2\)</span> を動かしたときの振幅特性です。 <span class="math inline">\(k_1\)</span> が <span class="math inline">\(\pi\)</span> を超えても振幅特性は計算できますが、実際に信号を入力すると発散しました。 プロットの丸い点は -3 dB の位置です。</p>
<figure>
<img src="img/GainFrequencyPlot.png" alt="Image of gain response plot." style="padding-bottom: 12px;"/>
</figure>
<p>ローパスのような特性ですが、ナイキスト周波数の近くに変なピークがあります。 <span class="math inline">\(k_1\)</span> を 0 に近づけるとピークの位置が 0 Hz に近づきます。</p>
<p>カットオフ周波数 <span class="math inline">\(\omega_c\)</span> から <span class="math inline">\(k_2\)</span> を求める近似曲線を <a href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.polyfit.html"><code>numpy.polyfit</code></a> を使って求めたところ、次の式が見つかりました。中点 <span class="math inline">\(\cdot\)</span> は乗算を表しています。</p>
<p><span class="math display">\[
k_2 = 6.5451144600705975 \cdot x + 20.46391326872472 \cdot x^2, \qquad x = \frac{\omega_c}{2 \pi}.
\]</span></p>
<p>カットオフ周波数と近似曲線のプロットです。丸い点が振幅特性から求めたカットオフ周波数、青い線が近似曲線です。</p>
<figure>
<img src="img/K2FrequencyPlot.png" alt="Image of k2-cutoff plot." style="padding-bottom: 12px;"/>
</figure>
<h2 id="レゾナンスのチューニング">レゾナンスのチューニング</h2>
<p><span class="math inline">\(k_2\)</span> がユーザによって決められたときに発散しない <span class="math inline">\(k_1\)</span> の最大値を探します。</p>
<p><a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.signal.tf2zpk.html#scipy.signal.tf2zpk"><code>scipy.signal.tf2zpk</code></a> から得られる伝達関数の極の絶対値の最大値が 1 になるような <span class="math inline">\(k_1\)</span> の値を探します。</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb4-1" title="1"><span class="im">import</span> numpy <span class="im">as</span> np</a>
<a class="sourceLine" id="cb4-2" title="2"><span class="im">import</span> scipy.signal <span class="im">as</span> signal</a>
<a class="sourceLine" id="cb4-3" title="3"><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> pyplot</a>
<a class="sourceLine" id="cb4-4" title="4"></a>
<a class="sourceLine" id="cb4-5" title="5"><span class="kw">def</span> stabilityPlot(transferFunction):</a>
<a class="sourceLine" id="cb4-6" title="6">    maxIteration <span class="op">=</span> <span class="dv">1024</span></a>
<a class="sourceLine" id="cb4-7" title="7">    nK2 <span class="op">=</span> <span class="dv">256</span></a>
<a class="sourceLine" id="cb4-8" title="8">    data <span class="op">=</span> []</a>
<a class="sourceLine" id="cb4-9" title="9">    <span class="cf">for</span> idx, k2 <span class="kw">in</span> <span class="bu">enumerate</span>(np.linspace(<span class="fl">0.1</span>, <span class="dv">1</span>, nK2)):</a>
<a class="sourceLine" id="cb4-10" title="10">        k1 <span class="op">=</span> <span class="dv">65536</span></a>
<a class="sourceLine" id="cb4-11" title="11">        delta <span class="op">=</span> k1 <span class="op">/</span> <span class="dv">2</span></a>
<a class="sourceLine" id="cb4-12" title="12">        jdx <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb4-13" title="13">        <span class="cf">while</span> jdx <span class="op">&lt;</span> maxIteration:</a>
<a class="sourceLine" id="cb4-14" title="14">            b, a <span class="op">=</span> transferFunction(k1, k2)</a>
<a class="sourceLine" id="cb4-15" title="15">            _, pole, gain <span class="op">=</span> signal.tf2zpk(b, a)</a>
<a class="sourceLine" id="cb4-16" title="16">            <span class="cf">if</span> np.<span class="bu">max</span>(np.<span class="bu">abs</span>(pole <span class="op">*</span> gain)) <span class="op">&gt;=</span> <span class="dv">1</span>:</a>
<a class="sourceLine" id="cb4-17" title="17">                k1 <span class="op">-=</span> delta</a>
<a class="sourceLine" id="cb4-18" title="18">            <span class="cf">else</span>:</a>
<a class="sourceLine" id="cb4-19" title="19">                k1 <span class="op">+=</span> delta</a>
<a class="sourceLine" id="cb4-20" title="20">            jdx <span class="op">+=</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb4-21" title="21">            delta <span class="op">*=</span> <span class="fl">0.5</span></a>
<a class="sourceLine" id="cb4-22" title="22">        data.append((k1, k2))</a>
<a class="sourceLine" id="cb4-23" title="23">        <span class="bu">print</span>(idx, k1, k2)</a>
<a class="sourceLine" id="cb4-24" title="24">    k1, k2 <span class="op">=</span> <span class="bu">zip</span>(<span class="op">*</span>data)</a>
<a class="sourceLine" id="cb4-25" title="25">    pyplot.scatter(k2, k1, s<span class="op">=</span><span class="dv">4</span>, zorder<span class="op">=</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb4-26" title="26">    pyplot.grid(zorder<span class="op">=</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb4-27" title="27">    pyplot.show()</a></code></pre></div>
<p>出力されたプロットです。</p>
<figure>
<img src="img/K1K2Plot.png" alt="Image of k1-k2 plot." style="padding-bottom: 12px;"/>
</figure>
<p><span class="math inline">\(k_2\)</span> が 0.6 を超えたあたりで異なる曲線がつなぎ合わされているように見えます。曲線が変わる点での <span class="math inline">\(k_2\)</span> の値を <span class="math inline">\(\xi_{k_2}\)</span> とします。 <span class="math inline">\(\xi_{k_2}\)</span> の値は <span class="math inline">\(2 \pi\)</span> に近いですが、はっきりしないので近似曲線を探すときは 0.63 を使っています。</p>
<p><span class="math inline">\(k_2\)</span> が <span class="math inline">\(\xi_{k_2}\)</span> 以下のときに対応する <span class="math inline">\(k_1\)</span> をそのまま使うと発散しました。そこで <span class="math inline">\(k_2\)</span> が <span class="math inline">\(\xi_{k_2}\)</span> 以下のときは <span class="math inline">\(k_1\)</span> の上限を <span class="math inline">\(\pi\)</span> にします。</p>
<p><span class="math inline">\(k_2\)</span> が <span class="math inline">\(\xi_{k_2}\)</span> 以上のときに <span class="math inline">\(k_2\)</span> から <span class="math inline">\(k_1\)</span> を求める近似曲線を探します。いろいろ試したところ <a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.curve_fit.html"><code>scipy.optimize.curve_fit</code></a> に次の関数を渡すと近似できました。</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb5-1" title="1"><span class="kw">def</span> curve_func(x, a0, a1, a2, a3, a4):</a>
<a class="sourceLine" id="cb5-2" title="2">    <span class="cf">return</span> <span class="dv">1</span> <span class="op">/</span> (a0 <span class="op">+</span> a1 <span class="op">*</span> x <span class="op">+</span> a2 <span class="op">*</span> x <span class="op">*</span> x <span class="op">+</span> a3 <span class="op">*</span> x <span class="op">*</span> x <span class="op">*</span> x <span class="op">+</span> a4 <span class="op">*</span> x <span class="op">*</span> x <span class="op">*</span> x <span class="op">*</span> x)</a></code></pre></div>
<p>得られた近似曲線の式です。 <span class="math inline">\(C_0\)</span> は <span class="math inline">\(k_2 = 0\)</span> のとき <span class="math inline">\(k_1 = 0\)</span> となるように調整しました。</p>
<p><span class="math display">\[
\begin{aligned}
k_1 &amp;\approx \begin{cases}
  \mathtt{resonance} \cdot \pi &amp;, \quad k_2 &lt; \xi_{k_2} \\
  \mathtt{resonance} \cdot
  \left(C_0 + \dfrac{1}{C_1 + C_2 k_2 + C_3 (k_2)^2 + C_4 (k_2)^3 + C_5 (k_2)^4} \right)
  &amp;, \quad \xi_{k_2} \leq k_2.
\end{cases} \\
\\
C_0 &amp;= -0.0049691265927442885\\
C_1 &amp;= -471.738128187657\\
C_2 &amp;= 1432.5662635997667\\
C_3 &amp;= 345.2853784111966\\
C_4 &amp;= -4454.40786711102\\
C_5 &amp;= 3468.062963176107\\
\end{aligned}
\]</span></p>
<p>近似曲線が <span class="math inline">\(k_2 = \xi_{k_2}\)</span> のときに <span class="math inline">\(\pi\)</span> となる <span class="math inline">\(\xi_{k_2}\)</span> は <span class="math inline">\(0.6295160864148501\)</span> です。</p>
<p><span class="math inline">\(k_2 \geq \xi_{k_2}\)</span> のときの実データと近似曲線のプロットです。</p>
<figure>
<img src="img/K1K2Fit.png" alt="Image of approximation of k1-k2 curve where k2 is greater or equal than xi_k2." style="padding-bottom: 12px;"/>
</figure>
<h3 id="発散を防ぐ">発散を防ぐ</h3>
<p>プラグインにして試したところ <span class="math inline">\(\mathtt{resonance} = 1\)</span> かつ <span class="math inline">\(k_2\)</span> が <span class="math inline">\(\xi_{k_2}\)</span> より小さいときに発散することが分かりました。試行錯誤を重ねた結果、 <span class="math inline">\(k_1\)</span> に 0.69 を掛け合わせると発散しなくなりました。次のようなコードで <span class="math inline">\(k_2 &lt; \xi_{k_2}\)</span> のときの <span class="math inline">\(k_1\)</span> の値を小さくします。</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb6-1" title="1"><span class="kw">def</span> shelveK1(k1, k2):</a>
<a class="sourceLine" id="cb6-2" title="2">    k1Gain <span class="op">=</span> <span class="fl">0.69</span></a>
<a class="sourceLine" id="cb6-3" title="3">    k1Delta <span class="op">=</span> <span class="fl">0.31</span>  <span class="co"># 1 - k1Gain.</span></a>
<a class="sourceLine" id="cb6-4" title="4">    B_2 <span class="op">=</span> <span class="fl">0.63</span>      <span class="co"># Tuning boundary (xi_{k_2}).</span></a>
<a class="sourceLine" id="cb6-5" title="5">    B_3 <span class="op">=</span> <span class="fl">0.635</span></a>
<a class="sourceLine" id="cb6-6" title="6"></a>
<a class="sourceLine" id="cb6-7" title="7">    <span class="cf">if</span> k2 <span class="op">&lt;</span> B_2:</a>
<a class="sourceLine" id="cb6-8" title="8">        k1 <span class="op">*=</span> k1Gain</a>
<a class="sourceLine" id="cb6-9" title="9">    <span class="cf">elif</span> k2 <span class="op">&gt;=</span> B_2 <span class="kw">and</span> k2 <span class="op">&lt;</span> B_3:</a>
<a class="sourceLine" id="cb6-10" title="10">        k1 <span class="op">*=</span> k1Gain <span class="op">+</span> k1Delta <span class="op">*</span> (k2 <span class="op">-</span> B_2) <span class="op">/</span> (B_3 <span class="op">-</span> B_2)</a>
<a class="sourceLine" id="cb6-11" title="11">    <span class="cf">return</span> k1</a></code></pre></div>
<p>最終的な <span class="math inline">\(k_1\)</span> のチューニング曲線のプロットです。</p>
<figure>
<img src="img/K1TuningDefault.png" alt="Image of ." style="padding-bottom: 12px;"/>
</figure>
<h2 id="出力ゲインのチューニング">出力ゲインのチューニング</h2>
<p>思いつきで <code>sqrt(k1)</code> を <code>pos2</code> の式に掛け合わせて出力ゲインのチューニングを変えてみました。</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb7-1" title="1"><span class="im">import</span> math</a>
<a class="sourceLine" id="cb7-2" title="2"></a>
<a class="sourceLine" id="cb7-3" title="3"><span class="kw">class</span> Model:</a>
<a class="sourceLine" id="cb7-4" title="4">    <span class="co"># ...</span></a>
<a class="sourceLine" id="cb7-5" title="5">    <span class="kw">def</span> processLP(<span class="va">self</span>, x0):</a>
<a class="sourceLine" id="cb7-6" title="6">        <span class="va">self</span>.acc2 <span class="op">=</span> <span class="va">self</span>.k2 <span class="op">*</span> (<span class="va">self</span>.vel1 <span class="op">-</span> <span class="va">self</span>.vel2)</a>
<a class="sourceLine" id="cb7-7" title="7">        <span class="va">self</span>.vel2 <span class="op">+=</span> <span class="va">self</span>.acc2 <span class="op">+</span> x0 <span class="op">-</span> <span class="va">self</span>.x1</a>
<a class="sourceLine" id="cb7-8" title="8">        <span class="va">self</span>.pos2 <span class="op">+=</span> <span class="va">self</span>.vel2 <span class="op">*</span> <span class="va">self</span>.k2 <span class="op">*</span> math.sqrt(k1)</a>
<a class="sourceLine" id="cb7-9" title="9"></a>
<a class="sourceLine" id="cb7-10" title="10">        <span class="va">self</span>.acc1 <span class="op">=</span> <span class="op">-</span><span class="va">self</span>.k1 <span class="op">*</span> <span class="va">self</span>.pos1 <span class="op">-</span> <span class="va">self</span>.acc2</a>
<a class="sourceLine" id="cb7-11" title="11">        <span class="va">self</span>.vel1 <span class="op">+=</span> <span class="va">self</span>.acc1</a>
<a class="sourceLine" id="cb7-12" title="12">        <span class="va">self</span>.pos1 <span class="op">+=</span> <span class="va">self</span>.vel1</a>
<a class="sourceLine" id="cb7-13" title="13"></a>
<a class="sourceLine" id="cb7-14" title="14">        <span class="va">self</span>.x1 <span class="op">=</span> x0</a>
<a class="sourceLine" id="cb7-15" title="15">        <span class="cf">return</span> <span class="va">self</span>.pos2</a></code></pre></div>
<p>出力ゲインのチューニングを変えると <span class="math inline">\(k_1\)</span> の上限が変わります。</p>
<p><span class="math inline">\(k_1\)</span> が <span class="math inline">\(0.7 \pi\)</span> よりも大きいと発散するので、近似曲線から得られた値に 0.7 を掛け合わせます。</p>
<p>0.7 を掛け合わせても <span class="math inline">\(k_2\)</span> が <span class="math inline">\(\xi_{k_2}\)</span> より小さく <span class="math inline">\(\xi_{k_2}\)</span> に近いときに発散します。そこで <span class="math inline">\(\xi_{k_2}\)</span> の周りにチューニングの凹みを作ります。</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb8-1" title="1"><span class="kw">def</span> dentK1(k1, k2):</a>
<a class="sourceLine" id="cb8-2" title="2">    k1Gain <span class="op">=</span> <span class="fl">0.69</span></a>
<a class="sourceLine" id="cb8-3" title="3">    k1Delta <span class="op">=</span> <span class="fl">0.31</span>  <span class="co"># 1 - k1Gain.</span></a>
<a class="sourceLine" id="cb8-4" title="4">    B_0 <span class="op">=</span> <span class="fl">0.61</span></a>
<a class="sourceLine" id="cb8-5" title="5">    B_1 <span class="op">=</span> <span class="fl">0.625</span></a>
<a class="sourceLine" id="cb8-6" title="6">    B_2 <span class="op">=</span> <span class="fl">0.63</span>  <span class="co"># Tuning boundary (xi_{k_2}).</span></a>
<a class="sourceLine" id="cb8-7" title="7">    B_3 <span class="op">=</span> <span class="fl">0.635</span></a>
<a class="sourceLine" id="cb8-8" title="8"></a>
<a class="sourceLine" id="cb8-9" title="9">    <span class="cf">if</span> k2 <span class="op">&gt;=</span> B_0 <span class="kw">and</span> k2 <span class="op">&lt;</span> B_1:</a>
<a class="sourceLine" id="cb8-10" title="10">        k1 <span class="op">*=</span> Sample(<span class="dv">1</span>) <span class="op">-</span> k1Delta <span class="op">*</span> (k2 <span class="op">-</span> B_0) <span class="op">/</span> (B_1 <span class="op">-</span> B_0)</a>
<a class="sourceLine" id="cb8-11" title="11">    <span class="cf">elif</span> k2 <span class="op">&gt;=</span> B_1 <span class="kw">and</span> k2 <span class="op">&lt;</span> B_2:</a>
<a class="sourceLine" id="cb8-12" title="12">        k1 <span class="op">*=</span> k1Gain</a>
<a class="sourceLine" id="cb8-13" title="13">    <span class="cf">elif</span> k2 <span class="op">&gt;=</span> B_2 <span class="kw">and</span> k2 <span class="op">&lt;</span> B_3:</a>
<a class="sourceLine" id="cb8-14" title="14">        k1 <span class="op">*=</span> k1Gain <span class="op">+</span> k1Delta <span class="op">*</span> (k2 <span class="op">-</span> B_2) <span class="op">/</span> (B_3 <span class="op">-</span> B_2)</a>
<a class="sourceLine" id="cb8-15" title="15"></a>
<a class="sourceLine" id="cb8-16" title="16">    <span class="cf">return</span> k1 <span class="op">*</span> <span class="fl">0.7</span></a></code></pre></div>
<p><code>sqrt(k1)</code> を <code>pos2</code> の式に掛けたときの <span class="math inline">\(k_1\)</span> のチューニング曲線のプロットです。</p>
<figure>
<img src="img/K1TuningSqrt.png" alt="Image of ." style="padding-bottom: 12px;"/>
</figure>
<h2 id="出力-u_1">出力 <span class="math inline">\(u_1\)</span></h2>
<p>フィルタの式の <span class="math inline">\(u_1\)</span> を出力に使うとハイパスフィルタを通したような音になります。出力 <span class="math inline">\(u_2\)</span> のチューニングを使っても発散しなかったので流用することにしました。</p>
<h2 id="実装">実装</h2>
<p>C++ による実装です。</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb9-1" title="1"><span class="kw">template</span>&lt;<span class="kw">typename</span> Sample&gt; <span class="kw">class</span> DoubleFilter {</a>
<a class="sourceLine" id="cb9-2" title="2"><span class="kw">public</span>:</a>
<a class="sourceLine" id="cb9-3" title="3">  <span class="dt">void</span> reset()</a>
<a class="sourceLine" id="cb9-4" title="4">  {</a>
<a class="sourceLine" id="cb9-5" title="5">    acc2 = vel2 = pos2 = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb9-6" title="6">    acc1 = vel1 = pos1 = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb9-7" title="7">    x1 = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb9-8" title="8">  }</a>
<a class="sourceLine" id="cb9-9" title="9"></a>
<a class="sourceLine" id="cb9-10" title="10">  <span class="dt">void</span> set(Sample sampleRate, Sample cutoffHz, Sample resonance, <span class="dt">bool</span> altGain)</a>
<a class="sourceLine" id="cb9-11" title="11">  {</a>
<a class="sourceLine" id="cb9-12" title="12">    Sample x = cutoffHz / sampleRate;</a>
<a class="sourceLine" id="cb9-13" title="13">    k2 = Sample(<span class="fl">6.5451144600705975</span>) * x + Sample(<span class="fl">20.46391326872472</span>) * x * x;</a>
<a class="sourceLine" id="cb9-14" title="14"></a>
<a class="sourceLine" id="cb9-15" title="15">    <span class="co">// k2 ~= 0.2π (~0.63) のあたりにチューニングの境界がある。</span></a>
<a class="sourceLine" id="cb9-16" title="16">    <span class="cf">if</span> (k2 &lt; Sample(<span class="fl">0.6295160864148501</span>)) {</a>
<a class="sourceLine" id="cb9-17" title="17">      k1 = Sample(pi) * resonance;</a>
<a class="sourceLine" id="cb9-18" title="18">    } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb9-19" title="19">      k1 = resonance</a>
<a class="sourceLine" id="cb9-20" title="20">        * (Sample(-<span class="fl">0.0049691265927442885</span>)</a>
<a class="sourceLine" id="cb9-21" title="21">           + Sample(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb9-22" title="22">             / (Sample(-<span class="fl">471.738128187657</span>) + Sample(<span class="fl">1432.5662635997667</span>) * k2 + Sample(<span class="fl">345.2853784111966</span>) * k2 * k2 + Sample(-<span class="fl">4454.40786711102</span>) * k2 * k2 * k2 + Sample(<span class="fl">3468.062963176107</span>) * k2 * k2 * k2 * k2));</a>
<a class="sourceLine" id="cb9-23" title="23">    }</a>
<a class="sourceLine" id="cb9-24" title="24"></a>
<a class="sourceLine" id="cb9-25" title="25">    <span class="at">const</span> <span class="kw">auto</span> k1Gain = Sample(<span class="fl">0.69</span>);</a>
<a class="sourceLine" id="cb9-26" title="26">    <span class="at">const</span> <span class="kw">auto</span> k1Delta = Sample(<span class="fl">0.31</span>); <span class="co">// 1 - k1Gain.</span></a>
<a class="sourceLine" id="cb9-27" title="27">    <span class="at">const</span> <span class="kw">auto</span> B_0 = Sample(<span class="fl">0.61</span>);</a>
<a class="sourceLine" id="cb9-28" title="28">    <span class="at">const</span> <span class="kw">auto</span> B_1 = Sample(<span class="fl">0.625</span>);</a>
<a class="sourceLine" id="cb9-29" title="29">    <span class="at">const</span> <span class="kw">auto</span> B_2 = Sample(<span class="fl">0.63</span>); <span class="co">// だいたいチューニング境界。</span></a>
<a class="sourceLine" id="cb9-30" title="30">    <span class="at">const</span> <span class="kw">auto</span> B_3 = Sample(<span class="fl">0.635</span>);</a>
<a class="sourceLine" id="cb9-31" title="31">    <span class="cf">if</span> (altGain) {</a>
<a class="sourceLine" id="cb9-32" title="32">      <span class="co">// k2 の値が チューニング境界 (~0.63) に近いときに k1 を小さくする。</span></a>
<a class="sourceLine" id="cb9-33" title="33">      <span class="cf">if</span> (k2 &gt;= B_0 &amp;&amp; k2 &lt; B_1)</a>
<a class="sourceLine" id="cb9-34" title="34">        k1 *= Sample(<span class="dv">1</span>) - k1Delta * (k2 - B_0) / (B_1 - B_0);</a>
<a class="sourceLine" id="cb9-35" title="35">      <span class="cf">else</span> <span class="cf">if</span> (k2 &gt;= B_1 &amp;&amp; k2 &lt; B_2)</a>
<a class="sourceLine" id="cb9-36" title="36">        k1 *= k1Gain;</a>
<a class="sourceLine" id="cb9-37" title="37">      <span class="cf">else</span> <span class="cf">if</span> (k2 &gt;= B_2 &amp;&amp; k2 &lt; B_3)</a>
<a class="sourceLine" id="cb9-38" title="38">        k1 *= k1Gain + k1Delta * (k2 - B_2) / (B_3 - B_2);</a>
<a class="sourceLine" id="cb9-39" title="39"></a>
<a class="sourceLine" id="cb9-40" title="40">      k1 *= Sample(<span class="fl">0.7</span>);</a>
<a class="sourceLine" id="cb9-41" title="41"></a>
<a class="sourceLine" id="cb9-42" title="42">      v2Gain = somesqrt&lt;Sample&gt;(k1);</a>
<a class="sourceLine" id="cb9-43" title="43">    } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb9-44" title="44">      <span class="co">// k2 の値が チューニング境界 (~0.63) より小さいときに k1 を小さくする。</span></a>
<a class="sourceLine" id="cb9-45" title="45">      <span class="cf">if</span> (k2 &lt; B_2)</a>
<a class="sourceLine" id="cb9-46" title="46">        k1 *= k1Gain;</a>
<a class="sourceLine" id="cb9-47" title="47">      <span class="cf">else</span> <span class="cf">if</span> (k2 &gt;= B_2 &amp;&amp; k2 &lt; B_3)</a>
<a class="sourceLine" id="cb9-48" title="48">        k1 *= k1Gain + k1Delta * (k2 - B_2) / (B_3 - B_2);</a>
<a class="sourceLine" id="cb9-49" title="49"></a>
<a class="sourceLine" id="cb9-50" title="50">      v2Gain = Sample(<span class="dv">1</span>);</a>
<a class="sourceLine" id="cb9-51" title="51">    }</a>
<a class="sourceLine" id="cb9-52" title="52">  }</a>
<a class="sourceLine" id="cb9-53" title="53"></a>
<a class="sourceLine" id="cb9-54" title="54">  Sample process(Sample x0, <span class="dt">bool</span> highpass)</a>
<a class="sourceLine" id="cb9-55" title="55">  {</a>
<a class="sourceLine" id="cb9-56" title="56">    acc2 = k2 * (vel1 - vel2);</a>
<a class="sourceLine" id="cb9-57" title="57">    vel2 += acc2 + x0 - x1;</a>
<a class="sourceLine" id="cb9-58" title="58">    pos2 += vel2 * k2 * v2Gain;</a>
<a class="sourceLine" id="cb9-59" title="59"></a>
<a class="sourceLine" id="cb9-60" title="60">    acc1 = -k1 * pos1 - acc2;</a>
<a class="sourceLine" id="cb9-61" title="61">    vel1 += acc1;</a>
<a class="sourceLine" id="cb9-62" title="62">    pos1 += vel1;</a>
<a class="sourceLine" id="cb9-63" title="63"></a>
<a class="sourceLine" id="cb9-64" title="64">    x1 = x0;</a>
<a class="sourceLine" id="cb9-65" title="65"></a>
<a class="sourceLine" id="cb9-66" title="66">    <span class="co">// 直流除去のため 0.999 を掛け合わせる。</span></a>
<a class="sourceLine" id="cb9-67" title="67">    <span class="cf">if</span> (highpass) <span class="cf">return</span> pos1 *= Sample(<span class="fl">0.999</span>);</a>
<a class="sourceLine" id="cb9-68" title="68">    <span class="cf">return</span> pos2 *= Sample(<span class="fl">0.999</span>);</a>
<a class="sourceLine" id="cb9-69" title="69">  }</a>
<a class="sourceLine" id="cb9-70" title="70"></a>
<a class="sourceLine" id="cb9-71" title="71"><span class="kw">private</span>:</a>
<a class="sourceLine" id="cb9-72" title="72">  Sample k1 = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb9-73" title="73">  Sample k2 = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb9-74" title="74">  Sample v2Gain = <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb9-75" title="75"></a>
<a class="sourceLine" id="cb9-76" title="76">  Sample acc2 = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb9-77" title="77">  Sample vel2 = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb9-78" title="78">  Sample pos2 = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb9-79" title="79"></a>
<a class="sourceLine" id="cb9-80" title="80">  Sample acc1 = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb9-81" title="81">  Sample vel1 = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb9-82" title="82">  Sample pos1 = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb9-83" title="83"></a>
<a class="sourceLine" id="cb9-84" title="84">  Sample x1 = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb9-85" title="85">};</a></code></pre></div>
<ul>
<li><a href="https://github.com/ryukau/LV2Plugins/blob/master/lv2cvport/CV_DoubleFilter/dsp/doublefilter.hpp">LV2Plugins/doublefilter.hpp at master · ryukau/LV2Plugins · GitHub</a></li>
</ul>
<h2 id="音のサンプル">音のサンプル</h2>
<p>サンプルの生成に使ったコードへのリンクです。</p>
<ul>
<li><a href="https://github.com/ryukau/filter_notes/blob/master/doublefilter/demo/sound.py">filter_notes/sound.py at master · ryukau/filter_notes · GitHub</a></li>
</ul>
<p>カットオフ周波数の変調には <a href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.geomspace.html"><code>numpy.geomspace</code></a> を使っています。</p>
<pre><code>cutoff = 5000 * numpy.geomspace(1e-5, 1, nSample)</code></pre>
<p>入力信号は <a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.signal.sawtooth.html"><code>scipy.signal.sawtooth</code></a> で生成した 45 Hz ののこぎり波です。</p>
<p><code>altGain</code> が true のとき <code>sqrt(k1)</code> を <code>pos2</code> に掛け合わせています。</p>
<h3 id="出力-u_2-ローパス">出力 <span class="math inline">\(u_2\)</span> (ローパス)</h3>
<p><code>altGain</code> = False としたときの出力です。</p>
<figure>
<figcaption>
resonance=0.001, altGain=False, isHighpass=False
</figcaption>
<audio controls>
<source src="lin_res0.00100_altGainFalse_isHighpassFalse.wav" type="audio/wav">
</audio>
</figure>
<figure>
<figcaption>
resonance=0.1, altGain=False, isHighpass=False
</figcaption>
<audio controls>
<source src="lin_res0.10000_altGainFalse_isHighpassFalse.wav" type="audio/wav">
</audio>
</figure>
<figure>
<figcaption>
resonance=1.0, altGain=False, isHighpass=False
</figcaption>
<audio controls>
<source src="lin_res1.00000_altGainFalse_isHighpassFalse.wav" type="audio/wav">
</audio>
</figure>
<p><code>altGain</code> = True としたときの出力です。</p>
<figure>
<figcaption>
resonance=0.001, altGain=True, isHighpass=False
</figcaption>
<audio controls>
<source src="lin_res0.00100_altGainTrue_isHighpassFalse.wav" type="audio/wav">
</audio>
</figure>
<figure>
<figcaption>
resonance=0.1, altGain=True, isHighpass=False
</figcaption>
<audio controls>
<source src="lin_res0.10000_altGainTrue_isHighpassFalse.wav" type="audio/wav">
</audio>
</figure>
<figure>
<figcaption>
resonance=1.0, altGain=True, isHighpass=False
</figcaption>
<audio controls>
<source src="lin_res1.00000_altGainTrue_isHighpassFalse.wav" type="audio/wav">
</audio>
</figure>
<h3 id="出力-u_1-ハイパス">出力 <span class="math inline">\(u_1\)</span> (ハイパス)</h3>
<p><code>altGain</code> = False としたときの出力です。</p>
<figure>
<figcaption>
resonance=0.001, altGain=False, isHighpass=True
</figcaption>
<audio controls>
<source src="lin_res0.00100_altGainFalse_isHighpassTrue.wav" type="audio/wav">
</audio>
</figure>
<figure>
<figcaption>
resonance=0.1, altGain=False, isHighpass=True
</figcaption>
<audio controls>
<source src="lin_res0.10000_altGainFalse_isHighpassTrue.wav" type="audio/wav">
</audio>
</figure>
<figure>
<figcaption>
resonance=1.0, altGain=False, isHighpass=True
</figcaption>
<audio controls>
<source src="lin_res1.00000_altGainFalse_isHighpassTrue.wav" type="audio/wav">
</audio>
</figure>
<p><code>altGain</code> = True としたときの出力です。</p>
<figure>
<figcaption>
resonance=0.001, altGain=True, isHighpass=True
</figcaption>
<audio controls>
<source src="lin_res0.00100_altGainTrue_isHighpassTrue.wav" type="audio/wav">
</audio>
</figure>
<figure>
<figcaption>
resonance=0.1, altGain=True, isHighpass=True
</figcaption>
<audio controls>
<source src="lin_res0.10000_altGainTrue_isHighpassTrue.wav" type="audio/wav">
</audio>
</figure>
<figure>
<figcaption>
resonance=1.0, altGain=True, isHighpass=True
</figcaption>
<audio controls>
<source src="lin_res1.00000_altGainTrue_isHighpassTrue.wav" type="audio/wav">
</audio>
</figure>
<h2 id="その他">その他</h2>
<h3 id="出力-u_1-の伝達関数">出力 <span class="math inline">\(u_1\)</span> の伝達関数</h3>
<p>フィルタの式を再掲します。</p>
<p><span class="math display">\[
\begin{aligned}
\ddot{u_2}[n] &amp;= k_2 (\dot{u_1}[n-1] - \dot{u_2}[n-1]) \\
\dot{u_2}[n] &amp;= \dot{u_2}[n-1] + \ddot{u_2}[n] + x[n] - x[n - 1] \\
u_2[n] &amp;= u_2[n-1] + k_2 \dot{u_2}[n] \\
\\
\ddot{u_1}[n] &amp;= -k_1 u_1[n-1] - \ddot{u_2}[n] \\
\dot{u_1}[n] &amp;= \dot{u_1}[n-1] + \ddot{u_1}[n] \\
u_1[n] &amp;= u_1[n-1] + \dot{u_1}[n] \\
\end{aligned}
\]</span></p>
<p><span class="math inline">\(u_1\)</span> の項だけが残るようにフィルタの式を変形します。</p>
<p><span class="math display">\[
\begin{aligned}
\dot{u_2}[n] &amp;= \dot{u_1}[n] - \frac{1}{k_2} \ddot{u_2}[n+1]     &amp;(1) \\
\ddot{u_2}[n] &amp;= \dot{u_2}[n] - \dot{u_2}[n-1] - x[n] + x[n - 1] &amp;(2) \\
\\
\ddot{u_2}[n] &amp;= - \ddot{u_1}[n] - k_1 u_1[n-1]                  &amp;(3) \\
\ddot{u_1}[n] &amp;= \dot{u_1}[n] - \dot{u_1}[n-1]                   &amp;(4) \\
\dot{u_1}[n] &amp;= u_1[n] - u_1[n-1]                                &amp;(5) \\
\end{aligned}
\]</span></p>
<p>次の手順で代入して <span class="math inline">\(u_1\)</span> の項だけにします。</p>
<ul>
<li>5 -&gt; 4 -&gt; 3</li>
<li>1 -&gt; 2</li>
<li>(5 -&gt; 4 -&gt; 3) を (1 -&gt; 2) に代入。</li>
</ul>
<div class="sourceCode" id="cb11"><pre class="sourceCode maxima"><code class="sourceCode maxima"><a class="sourceLine" id="cb11-1" title="1"><span class="cn">d1_u2</span>(<span class="cn">n</span>) := <span class="cn">d1_u1</span>(<span class="cn">n</span>) - <span class="cn">d2_u2</span>(<span class="cn">n</span> + <span class="dv">1</span>) / <span class="cn">k_2</span>;                    <span class="co">/* (1) */</span></a>
<a class="sourceLine" id="cb11-2" title="2"><span class="cn">d2_u2</span>(<span class="cn">n</span>) := -<span class="cn">d2_u1</span>(<span class="cn">n</span>) - <span class="cn">k_1</span> * <span class="cn">u_1</span>(<span class="cn">n</span> - <span class="dv">1</span>);  <span class="co">/* (3) */</span></a>
<a class="sourceLine" id="cb11-3" title="3"><span class="cn">d2_u1</span>(<span class="cn">n</span>) := <span class="cn">d1_u1</span>(<span class="cn">n</span>) - <span class="cn">d1_u1</span>(<span class="cn">n</span> - <span class="dv">1</span>);                          <span class="co">/* (4) */</span></a>
<a class="sourceLine" id="cb11-4" title="4"><span class="cn">d1_u1</span>(<span class="cn">n</span>) := <span class="cn">u_1</span>(<span class="cn">n</span>) - <span class="cn">u_1</span>(<span class="cn">n</span> - <span class="dv">1</span>);                              <span class="co">/* (5) */</span></a>
<a class="sourceLine" id="cb11-5" title="5"></a>
<a class="sourceLine" id="cb11-6" title="6"><span class="cn">result</span>: <span class="cn">d2_u2</span>(<span class="cn">n</span>) = <span class="cn">d1_u2</span>(<span class="cn">n</span>) - <span class="cn">d1_u2</span>(<span class="cn">n</span> - <span class="dv">1</span>) - <span class="cn">x</span>(<span class="cn">n</span>) + <span class="cn">x</span>(<span class="cn">n</span> - <span class="dv">1</span>); <span class="co">/* (2) */</span></a>
<a class="sourceLine" id="cb11-7" title="7"></a>
<a class="sourceLine" id="cb11-8" title="8"><span class="fu">ratvars</span>(<span class="cn">u</span>(<span class="cn">n</span>), <span class="cn">u</span>(<span class="cn">n</span><span class="dv">-1</span>), <span class="cn">u</span>(<span class="cn">n</span><span class="dv">-2</span>), <span class="cn">u</span>(<span class="cn">n</span><span class="dv">-3</span>), <span class="cn">x</span>(<span class="cn">n</span>), <span class="cn">x</span>(<span class="cn">n</span><span class="dv">-1</span>), <span class="cn">x</span>(<span class="cn">n</span><span class="dv">-2</span>), <span class="cn">x</span>(<span class="cn">n</span><span class="dv">-3</span>));</a>
<a class="sourceLine" id="cb11-9" title="9"><span class="fu">ratexpand</span>(<span class="dv">0</span> = <span class="fu">rhs</span>(<span class="cn">result</span>) - <span class="fu">lhs</span>(<span class="cn">result</span>));</a></code></pre></div>
<p>出力です。</p>
<p><span class="math display">\[
\begin{aligned}
0=&amp;
- x(n)
\\&amp;
+ x(n-1)
\\&amp;
+ \frac{u_1(n+1)}{k_2}
\\&amp;
+ \frac{k_1 u_1(n)}{k_2}
- \frac{3 u_1(n)}{k_2}
+ 2 u_1(n)
\\&amp;
- \frac{k_1 u_1(n-1)}{k_2}
+ \frac{3 u_1(n-1)}{k_2}
+ k_1 u_1(n-1)
- 4 u_1(n-1)
\\&amp;
- \frac{u_1(n-2)}{k_2}
+ 2 u_1(n-2)
\end{aligned}
\]</span></p>
<p>整理します。</p>
<p><span class="math display">\[
\begin{aligned}
x[n-1] - x[n-2] =&amp; \frac{1}{k_2} u_1[n]
+ \left( \frac{k_1 - 3}{k_2} + 2 \right) u_1[n-1]
\\&amp;
+ \left( \frac{- k_1 + 3}{k_2} + k_1 - 4 \right) u_1[n-2]
+ \left( \frac{- 1}{k_2}  + 2 \right) u_1[n-3]
\end{aligned}
\]</span></p>
<p>伝達関数が得られました。</p>
<p><span class="math display">\[
H(z) = \frac{z^{-1} - z^{-2}}{C_0 + C_1 z^{-1} + C_2 z^{-2} + C_3 z^{-3}}
,\qquad
\begin{aligned}
C_0 &amp;= \frac{1}{k_2} \\
C_1 &amp;= \frac{k_1 - 3}{k_2} + 2 \\
C_2 &amp;= \frac{- k_1 + 3}{k_2} + k_1 - 4 \\
C_3 &amp;= \frac{- 1}{k_2} + 2 \\
\end{aligned}
\]</span></p>
<h2 id="参考サイト">参考サイト</h2>
<ul>
<li><a href="https://www.myphysicslab.com/springs/double-spring-en.html">myPhysicsLab Double Spring</a></li>
<li><a href="https://ccrma.stanford.edu/~jos/filters/Stability_Revisited.html">Stability Revisited</a></li>
</ul>
<footer>
<a href="../index.html">インデックスに戻る</a>
</footer>
</body>

</html>
