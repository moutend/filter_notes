<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="" >

<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
      <meta name="dcterms.date" content="2019-11-29" />
      <title>ptr_trapezoid</title>

  <!-- highlight.js -->
  <link rel="stylesheet" href="../script/highlight/idea.css">
  <script src="../script/highlight/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

  <!-- KaTeX -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.css"
    integrity="sha384-yFRtMMDnQtDRO8rLpMIKrtPCD5jdktao2TV19YiZYWMDkUR5GQZR/NOVTdquEx1j" crossorigin="anonymous">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.js"
    integrity="sha384-9Nhn55MVVN0/4OFx7EE5kpFBPsEMZxKTCnA+4fqDmg12eCTqGi6+BB2LjY8brQxJ"
    crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/contrib/auto-render.min.js"
    integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>

  <style>
    body {
      max-width: 704px;
      margin: auto;
      padding: 32px 8px;
      font-size: 14px;
    }

    img {
      max-width: 100%;
    }

    video {
      max-width: 100%;
    }

    kbd {
      border-style: solid;
      border-width: 1px 2px 2px 1px;
      border-radius: 2px;
      padding: 2px;
      margin: 2px;
    }

    a {
      text-decoration: none;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
      border-left: solid 8px #eeeeee;
      padding-left: 8px;
    }

    table {
      border-spacing: 0px;
      border-collapse: separate;
      border: 1px solid #dddddd;
    }

    tr.header {
      border: 1px solid black;
    }

    tr.odd {
      background: #eeeeee;
    }

    tr.even {
      background: #ffffff;
    }

    th {
      height: 2em;
      font-weight: normal;
      color: #004444;
      padding-left: 0.35em;
      padding-right: 0.35em;
      border-bottom: 3px solid #dddddd;
      border-left: 1px solid #dddddd;
    }

    td {
      height: 1.5em;
      padding-left: 0.35em;
      padding-right: 0.35em;
      border-bottom: 1px solid #dddddd;
      border-left: 1px solid #dddddd;
    }

    audio {
      vertical-align: middle;
    }

    label {
      vertical-align: middle;
    }

    code {
      color: #004444;
    }

    pre code {
      border: 4px solid #eeeeee;
    }

    li {
      margin: 8px;
    }

    header {
      border-bottom: 1px gray solid;
      padding: 0.5em;
      margin-bottom: 1em;
    }

    footer {
      border-top: 1px gray solid;
      padding: 0.5em;
      margin-top: 1em;
    }

    summary:hover {
      background-color: #eeeeee;
    }

    canvas {
      /* image-rendering: pixelated; */
      display: inline-block;
      border-style: solid;
      border-width: 1px;
      border-color: #627f84;
    }

    .controlBlock {
      display: inline-block;
      width: 450px;
      text-align: left;
      vertical-align: top;
      margin-left: 4px;
    }

    input[type="button"] {
      background-color: #ffffff;
      border: 2px solid #aaaaaa;
      font-size: 16px;
      height: 32px;
    }

    input[type="button"]:hover {
      background-color: #ffffff;
      border: 2px solid #aaccff;
    }

    div.numberInput {
      display: block;
      white-space: nowrap;
    }

    div.numberInput:hover {
      background-color: #e0ecff;
    }

    .numberInputLabel {
      /* max 12 letter  */
      display: inline-block;
      margin: 0 8px 0 8px;
      text-align: left;
      vertical-align: middle;
      width: 100px;

      font-size: 10pt;
      font-family: 'Courier New', Courier, monospace;
    }

    .numberInputNumber {
      display: inline-block;
      vertical-align: middle;
      width: 120px;
    }

    .numberInputRange {
      display: inline-block;
      vertical-align: middle;
      width: 160px;
    }

    .pullDownMenu {
      display: inline-block;
      text-align: center;
    }

    .pullDownMenu:hover {
      background-color: #e0ecff;
    }

    select {
      background-color: #ffffff;
      border: 2px solid #aaaaaa;
      height: 24px;
      vertical-align: middle;
      font-size: 12px;
    }

    select:hover {
      background-color: #ffffff;
      border: 2px solid #aaccff;
    }
  </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS_CHTML-full" type="text/javascript"></script>
    </head>

<body>
    <header>
    <p>
      何かあれば <a href="https://github.com/ryukau/filter_notes">GitHub のリポジトリ</a>に issue を作るか ryukau@gmail.com までお気軽にどうぞ。
    </p>

    <hr>

    <a href="../index.html">インデックスに戻る</a>

        <p>
      Update: 2019-11-29
    </p>
            <details>
      <summary translate="yes">Table of Contents</summary>
      <nav id="TOC" role="doc-toc">
        <ul>
        <li><a href="#ptr-台形オシレータ">PTR 台形オシレータ</a><ul>
        <li><a href="#ptr-台形の特性">PTR 台形の特性</a><ul>
        <li><a href="#y-の値"><span class="math inline">\(y\)</span> の値</a></li>
        <li><a href="#a_1-と-a_2-の関係"><span class="math inline">\(A_1\)</span> と <span class="math inline">\(A_2\)</span> の関係</a></li>
        <li><a href="#a_1-の範囲"><span class="math inline">\(A_1\)</span> の範囲</a></li>
        <li><a href="#k-の範囲"><span class="math inline">\(K\)</span> の範囲</a></li>
        <li><a href="#直流補正">直流補正</a></li>
        </ul></li>
        <li><a href="#音程が高いときのノイズの低減">音程が高いときのノイズの低減</a></li>
        <li><a href="#実装">実装</a></li>
        </ul></li>
        </ul>
      </nav>
    </details>
      </header>
  <h1 id="ptr-台形オシレータ">PTR 台形オシレータ</h1>
  <p><a href="https://ryukau.github.io/VSTPlugins/manual/TrapezoidSynth/TrapezoidSynth_ja.html">TrapezoidSynth</a> の<a href="https://github.com/ryukau/VSTPlugins/blob/91d663e7ed916bc7c5e372990ad40eb9736ad84e/TrapezoidSynth/source/dsp/oscillator.hpp#L106">オシレータのコード</a>があまりにも場当たり的で自分でも読めなくなったので整理しました。</p>
  <h2 id="ptr-台形の特性">PTR 台形の特性</h2>
  <p>TrapezoidSynth の PTR 台形オシレータは 4 つの PTR <a href="https://en.wikipedia.org/wiki/Ramp_function">ランプ関数</a>をつぎはぎすることで台形を合成しています。このつぎはぎが複雑さの原因です。</p>
  <p>ランプ関数の定義です。</p>
  <p><span class="math display">\[
  R(x) = \begin{cases}
  0, &amp; \text{if}\ x &lt; 0,\\
  x, &amp; \text{otherwise.}
  \end{cases}
  \]</span></p>
  <p>PTR ランプ関数の導出は次のリンクにまとめています。</p>
  <ul>
  <li><a href="../ptr_oscillator/ptr_oscillator.html">PTR オシレータ</a></li>
  </ul>
  <p>次の図はランプ関数のつぎはぎの様子を表しています。下側の矢印はランプ関数の <span class="math inline">\(x\)</span> が増える方向です。</p>
  <figure>
  <img src="img/ramp_patch.svg" alt="Image of trapezoid made from 4 ramp functions." style="width: 480px;padding-bottom: 12px;"/>
  </figure>
  <ul>
  <li><a href="https://en.wikipedia.org/wiki/Ramp_function">Ramp function - Wikipedia</a></li>
  </ul>
  <p>まずは台形の各部に名前をつけます。</p>
  <figure>
  <img src="img/trapezoid_dc1.svg" alt="Image of trapezoid with name of parts." style="width: 480px;padding-bottom: 12px;"/>
  </figure>
  <h3 id="y-の値"><span class="math inline">\(y\)</span> の値</h3>
  <p>PTR の次数を <span class="math inline">\(N\)</span> 、 1 サンプルあたりに進む位相を <span class="math inline">\(T\)</span> とすると <span class="math inline">\(y = 1 - 2 K N T\)</span> です。 <span class="math inline">\(- 2 K N T\)</span> という値は試行錯誤して見つけた適当な値です。</p>
  <h3 id="a_1-と-a_2-の関係"><span class="math inline">\(A_1\)</span> と <span class="math inline">\(A_2\)</span> の関係</h3>
  <p><span class="math inline">\(A_1\)</span> と <span class="math inline">\(K\)</span> はユーザが決定する定数です。 <span class="math inline">\(A_1\)</span> は1つ目の台形の上辺の長さ、 <span class="math inline">\(K\)</span> は台形の斜線の傾きです。</p>
  <p><span class="math inline">\(B_1 + B_2\)</span> は 1 周期の波長です。ここでは正規化して <span class="math inline">\(B_1 + B_2 = 1\)</span> と定義します。この定義を使って、2つ目の台形の上辺の長さ <span class="math inline">\(A_2\)</span> を計算できます。</p>
  <p><span class="math display">\[
  \begin{aligned}
  A_2 &amp;= B_1 + B_2 - A_1 - \frac{1}{K}\\
    &amp;= 1 - A_1 - \frac{1}{K} &amp; \text{(1)}
  \end{aligned}
  \]</span></p>
  <h3 id="a_1-の範囲"><span class="math inline">\(A_1\)</span> の範囲</h3>
  <p><span class="math inline">\(A_1\)</span> の最小値は <span class="math inline">\(0\)</span> です。</p>
  <p><span class="math inline">\(A_1\)</span> が最大となるとき、 <span class="math inline">\(A_2 = 0\)</span> です。 <span class="math inline">\(A_2 = 0\)</span> を式 (1) に代入すると <span class="math inline">\(A_1\)</span> の最大値 <span class="math inline">\(1 - \dfrac{1}{K}\)</span> が得られます。</p>
  <h3 id="k-の範囲"><span class="math inline">\(K\)</span> の範囲</h3>
  <p><span class="math inline">\(A_1 = 0,\ A_2 = 0\)</span> のとき、式 (1) より <span class="math inline">\(K = 1\)</span> です。このとき三角波に近い波形になります。 <span class="math inline">\(K &lt; 1\)</span> のときは三角波が途中でハードシンクされたような滑らかでない波形になります。</p>
  <p><span class="math inline">\(A_1 = 0,\ A_2 = 1\)</span> のとき、式 (1) より <span class="math inline">\(K = \infty\)</span> となります。ただし、実際に <span class="math inline">\(K = \infty\)</span> とすると PTR の遷移領域を飛び越えてしまうので波形が不連続になってしまいます。そこで、実装では <span class="math inline">\(A_1 = 0,\ A_2 = 1 - 4 N T\)</span> を式 (1) に代入して得られる <span class="math inline">\(K = \dfrac{1}{4 N T}\)</span> を <span class="math inline">\(K\)</span> の最大値としています。 <span class="math inline">\(4 N T\)</span> は 4 つの PTR ランプ関数の遷移領域の長さです。</p>
  <h3 id="直流補正">直流補正</h3>
  <p>図では <span class="math inline">\(h\)</span> を引いて直流成分を補正しています。 <span class="math inline">\(A_1, B_1\)</span> からなる台形 1 と、 <span class="math inline">\(A_2, B_2\)</span> からなる台形 2 の面積が等しいときに直流が 0 になります。 <span class="math inline">\(h\)</span> を求める方程式を立てます。</p>
  <p><span class="math display">\[
  \begin{aligned}
  B_1 &amp;= A_1 + \frac{2(y - h)}{K}\\
  B_2 &amp;= A_2 + \frac{2h}{K}\\
  \frac{(A_1 + B_1) (y - h)}{2} &amp;= \frac{(A_2 + B_2) h}{2}\\
  \end{aligned}
  \]</span></p>
  <p>Maxima で解きます。</p>
  <div class="sourceCode" id="cb1"><pre class="sourceCode maxima"><code class="sourceCode maxima"><a class="sourceLine" id="cb1-1" title="1"><span class="cn">A2</span>: <span class="dv">1</span> - <span class="cn">A1</span> - <span class="dv">1</span> / <span class="cn">K</span>;</a>
  <a class="sourceLine" id="cb1-2" title="2"><span class="cn">B1</span>: <span class="cn">A1</span> + <span class="dv">2</span> * (<span class="cn">y</span> - <span class="cn">h</span>) / <span class="cn">K</span>;</a>
  <a class="sourceLine" id="cb1-3" title="3"><span class="cn">B2</span>: <span class="cn">A2</span> + <span class="dv">2</span> * <span class="cn">h</span> / <span class="cn">K</span>;</a>
  <a class="sourceLine" id="cb1-4" title="4"><span class="cn">eq</span>: (<span class="cn">A1</span> + <span class="cn">B1</span>) * (<span class="cn">y</span> - <span class="cn">h</span>) / <span class="dv">2</span> = (<span class="cn">A2</span> + <span class="cn">B2</span>) * <span class="cn">h</span> / <span class="dv">2</span>;</a>
  <a class="sourceLine" id="cb1-5" title="5"><span class="fu">expand</span>(<span class="fu">solve</span>(<span class="cn">eq</span>, <span class="cn">h</span>));</a></code></pre></div>
  <p>出力です。</p>
  <p><span class="math display">\[
  h=\frac{y^2 + A_1 K y}{2 y+K-1}
  \]</span></p>
  <p>これで直流成分の大きさ <span class="math inline">\(h\)</span> が分かりました。</p>
  <h2 id="音程が高いときのノイズの低減">音程が高いときのノイズの低減</h2>
  <p>記号の定義です。</p>
  <ul>
  <li><span class="math inline">\(f\)</span> : オシレータの周波数</li>
  <li><span class="math inline">\(f_s\)</span> : サンプリング周波数</li>
  <li><span class="math inline">\(N\)</span> : PTR の次数</li>
  </ul>
  <p>PTR 台形オシレータの次数 <span class="math inline">\(N\)</span> を大きくするほどエイリアシングノイズが低減されますが、周波数が <span class="math inline">\(\dfrac{f_s}{4 N}\)</span> を超えるとノイズが増えてしまうというトレードオフがあります。ノイズが乗るのは 4 つのランプ関数のすべての遷移領域を通過する前に波形の 1 周期が終わってしまうからです。</p>
  <p><span class="math inline">\(f_s = 44100\)</span> として <span class="math inline">\(N\)</span> を変えたときのノイズが乗らない周波数の上限は次のようになります。</p>
  <ul>
  <li><span class="math inline">\(N = 2 \to 5512.5\,\mathrm{Hz}\)</span></li>
  <li><span class="math inline">\(N = 3 \to 3675\,\mathrm{Hz}\)</span></li>
  <li><span class="math inline">\(N = 4 \to 2756.25\,\mathrm{Hz}\)</span></li>
  <li><span class="math inline">\(N = 5 \to 2205\,\mathrm{Hz}\)</span></li>
  </ul>
  <p><span class="math inline">\(f_s \geq 44100\)</span> のときは <span class="math inline">\(N = 4\)</span> にして 8 倍のオーバーサンプリングをかけると、ノイズが乗らない周波数の上限が 22050 Hz になるので十分な音域が使えるようになります。ただし、オーバーサンプリングを使わずにエイリアシングノイズを効率よく低減できるという PTR の利点を無視することになります。</p>
  <p>オーバーサンプリングを極力避けるためには次の式のように PTR の次数を切り替えることが考えられます。例として <span class="math inline">\(N\)</span> が 2 から 5 の間で切り替わっています。</p>
  <p><span class="math display">\[
  \begin{aligned}
  N_{\mathtt{TrapezoidSynth}}(f) &amp;= \begin{cases}
  5, &amp; \text{if} \enspace f &lt; f_u(5)\\
  4, &amp; \text{if} \enspace f_u(5) \leq f &lt; f_u(4)\\
  3, &amp; \text{if} \enspace f_u(4) \leq f &lt; f_u(3)\\
  2, &amp; \text{if} \enspace f_u(3) \leq f\\
  \end{cases}\\
  \text{where}\enspace
  f_u(N) &amp;= \frac{f_s}{4 N}
  \end{aligned}
  \]</span></p>
  <p>分岐処理がオーバーサンプリングよりも速いかどうかはベンチマークを取ってみないとわかりません。また <span class="math inline">\(N\)</span> の切り替えのタイミングで不連続になるので、ピッチベンドなどで周波数が動くとノイズが乗ります。</p>
  <p>TrapezoidSynth では何を思ったのか <span class="math inline">\(N\)</span> の切り替えと 8 倍のオーバーサンプリングの両方が実装されています。</p>
  <h2 id="実装">実装</h2>
  <p>C++ です。</p>
  <p>定数をキャストしているのはテンプレートで <code>float</code> と <code>double</code> を切り替えることを想定していたからです。結局オーバーサンプリングしてごまかしたのでテンプレート化は見送りました。</p>
  <div class="sourceCode" id="cb2"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb2-1" title="1"><span class="pp">#include </span><span class="im">&lt;algorithm&gt;</span></a>
  <a class="sourceLine" id="cb2-2" title="2"></a>
  <a class="sourceLine" id="cb2-3" title="3"><span class="kw">class</span> PTRTrapezoidOsc {</a>
  <a class="sourceLine" id="cb2-4" title="4"><span class="kw">public</span>:</a>
  <a class="sourceLine" id="cb2-5" title="5">  PTRTrapezoidOsc(<span class="dt">float</span> sampleRate, <span class="dt">float</span> frequencyHz) : sampleRate(sampleRate)</a>
  <a class="sourceLine" id="cb2-6" title="6">  {</a>
  <a class="sourceLine" id="cb2-7" title="7">    setFreq(frequencyHz);</a>
  <a class="sourceLine" id="cb2-8" title="8">  }</a>
  <a class="sourceLine" id="cb2-9" title="9"></a>
  <a class="sourceLine" id="cb2-10" title="10">  <span class="dt">void</span> setFreq(<span class="dt">float</span> hz)</a>
  <a class="sourceLine" id="cb2-11" title="11">  {</a>
  <a class="sourceLine" id="cb2-12" title="12">    <span class="cf">if</span> (hz &gt;= <span class="dv">0</span>) tick = hz / sampleRate;</a>
  <a class="sourceLine" id="cb2-13" title="13">  }</a>
  <a class="sourceLine" id="cb2-14" title="14"></a>
  <a class="sourceLine" id="cb2-15" title="15">  <span class="dt">void</span> setPhase(<span class="dt">float</span> phase) { <span class="kw">this</span>-&gt;phase = phase; }</a>
  <a class="sourceLine" id="cb2-16" title="16">  <span class="dt">void</span> addPhase(<span class="dt">float</span> phase) { <span class="kw">this</span>-&gt;phase += phase; }</a>
  <a class="sourceLine" id="cb2-17" title="17">  <span class="dt">void</span> setSlope(<span class="dt">float</span> slope) { <span class="kw">this</span>-&gt;slope = slope; }</a>
  <a class="sourceLine" id="cb2-18" title="18">  <span class="dt">void</span> setPulseWidth(<span class="dt">float</span> pw) { <span class="kw">this</span>-&gt;pw = pw; }</a>
  <a class="sourceLine" id="cb2-19" title="19">  <span class="dt">void</span> reset() { phase = <span class="dv">0</span>; }</a>
  <a class="sourceLine" id="cb2-20" title="20"></a>
  <a class="sourceLine" id="cb2-21" title="21">  <span class="dt">float</span> process()</a>
  <a class="sourceLine" id="cb2-22" title="22">  {</a>
  <a class="sourceLine" id="cb2-23" title="23">    <span class="cf">if</span> (tick &lt;= <span class="dv">0</span>) <span class="cf">return</span> <span class="dv">0</span>;</a>
  <a class="sourceLine" id="cb2-24" title="24">    phase += tick;</a>
  <a class="sourceLine" id="cb2-25" title="25">    phase -= somefloor&lt;<span class="dt">float</span>&gt;(phase);</a>
  <a class="sourceLine" id="cb2-26" title="26">    <span class="cf">return</span> ptrTpz5(phase, tick, slope, pw);</a>
  <a class="sourceLine" id="cb2-27" title="27">  }</a>
  <a class="sourceLine" id="cb2-28" title="28"></a>
  <a class="sourceLine" id="cb2-29" title="29">  <span class="dt">float</span> sampleRate;</a>
  <a class="sourceLine" id="cb2-30" title="30">  <span class="dt">float</span> phase = <span class="dv">0</span>;</a>
  <a class="sourceLine" id="cb2-31" title="31">  <span class="dt">float</span> tick = <span class="dv">0</span>;</a>
  <a class="sourceLine" id="cb2-32" title="32">  <span class="dt">float</span> slope = <span class="dv">8</span>;       <span class="co">// 台形の斜辺の傾き。この文章の K に相当。</span></a>
  <a class="sourceLine" id="cb2-33" title="33">  <span class="dt">float</span> pw = <span class="dt">float</span>(<span class="fl">0.5</span>); <span class="co">// Pulse width. A1 に相当。</span></a>
  <a class="sourceLine" id="cb2-34" title="34"></a>
  <a class="sourceLine" id="cb2-35" title="35"><span class="kw">protected</span>:</a>
  <a class="sourceLine" id="cb2-36" title="36">  <span class="co">// tick must be greater than 0.</span></a>
  <a class="sourceLine" id="cb2-37" title="37">  <span class="at">static</span> <span class="dt">float</span> ptrTpz5(<span class="dt">float</span> phase, <span class="dt">float</span> tick, <span class="dt">float</span> slope, <span class="dt">float</span> pw)</a>
  <a class="sourceLine" id="cb2-38" title="38">  {</a>
  <a class="sourceLine" id="cb2-39" title="39">    <span class="dt">uint32_t</span> order = <span class="dv">5</span>; <span class="co">// PTR の次数。 N に相当。</span></a>
  <a class="sourceLine" id="cb2-40" title="40">    <span class="cf">if</span> (order &gt; <span class="dt">float</span>(<span class="fl">0.25</span>) / tick) order = <span class="dt">int</span>(<span class="dt">float</span>(<span class="fl">0.25</span>) / tick);</a>
  <a class="sourceLine" id="cb2-41" title="41"></a>
  <a class="sourceLine" id="cb2-42" title="42">    <span class="at">const</span> <span class="dt">float</span> ptrLen = order * tick; <span class="co">// NT に相当。</span></a>
  <a class="sourceLine" id="cb2-43" title="43"></a>
  <a class="sourceLine" id="cb2-44" title="44">    <span class="co">// A1 の範囲を制限。</span></a>
  <a class="sourceLine" id="cb2-45" title="45">    <span class="at">const</span> <span class="dt">float</span> maxSlope = <span class="dt">float</span>(<span class="fl">0.25</span>) / ptrLen;</a>
  <a class="sourceLine" id="cb2-46" title="46">    <span class="cf">if</span> (slope &gt; maxSlope) {</a>
  <a class="sourceLine" id="cb2-47" title="47">      slope = maxSlope;</a>
  <a class="sourceLine" id="cb2-48" title="48">    } <span class="cf">else</span> {</a>
  <a class="sourceLine" id="cb2-49" title="49">      <span class="at">const</span> <span class="dt">float</span> minSlope = <span class="dt">float</span>(<span class="dv">1</span>);</a>
  <a class="sourceLine" id="cb2-50" title="50">      <span class="cf">if</span> (slope &lt; minSlope) slope = minSlope;</a>
  <a class="sourceLine" id="cb2-51" title="51">    }</a>
  <a class="sourceLine" id="cb2-52" title="52"></a>
  <a class="sourceLine" id="cb2-53" title="53">    <span class="co">// K の範囲を制限。</span></a>
  <a class="sourceLine" id="cb2-54" title="54">    <span class="at">const</span> <span class="dt">float</span> maxPw = <span class="dt">float</span>(<span class="dv">1</span>) - <span class="dt">float</span>(<span class="dv">1</span>) / slope;</a>
  <a class="sourceLine" id="cb2-55" title="55">    <span class="cf">if</span> (pw &gt; maxPw) pw = <span class="bu">std::</span>max&lt;<span class="dt">float</span>&gt;(<span class="dt">float</span>(<span class="dv">0</span>), maxPw);</a>
  <a class="sourceLine" id="cb2-56" title="56"></a>
  <a class="sourceLine" id="cb2-57" title="57">    <span class="co">// 直流の計算。 y は適当に見つけた上手く動く値。</span></a>
  <a class="sourceLine" id="cb2-58" title="58">    <span class="at">const</span> <span class="dt">float</span> y = <span class="dt">float</span>(<span class="dv">1</span>) - <span class="dt">float</span>(<span class="dv">2</span>) * slope * ptrLen;</a>
  <a class="sourceLine" id="cb2-59" title="59">    <span class="at">const</span> <span class="dt">float</span> dc = (y * y + pw * slope * y) / (<span class="dt">float</span>(<span class="dv">2</span>) * y + slope - <span class="dt">float</span>(<span class="dv">1</span>));</a>
  <a class="sourceLine" id="cb2-60" title="60"></a>
  <a class="sourceLine" id="cb2-61" title="61">    <span class="co">// N による分岐。</span></a>
  <a class="sourceLine" id="cb2-62" title="62">    <span class="cf">if</span> (order == <span class="dv">5</span>)</a>
  <a class="sourceLine" id="cb2-63" title="63">      <span class="cf">return</span> branch&lt;PTRTrapezoidOsc::ptrRamp5&gt;(slope, pw, y, phase, tick) - dc;</a>
  <a class="sourceLine" id="cb2-64" title="64">    <span class="cf">else</span> <span class="cf">if</span> (order == <span class="dv">4</span>)</a>
  <a class="sourceLine" id="cb2-65" title="65">      <span class="cf">return</span> branch&lt;PTRTrapezoidOsc::ptrRamp4&gt;(slope, pw, y, phase, tick) - dc;</a>
  <a class="sourceLine" id="cb2-66" title="66">    <span class="cf">else</span> <span class="cf">if</span> (order == <span class="dv">3</span>)</a>
  <a class="sourceLine" id="cb2-67" title="67">      <span class="cf">return</span> branch&lt;PTRTrapezoidOsc::ptrRamp3&gt;(slope, pw, y, phase, tick) - dc;</a>
  <a class="sourceLine" id="cb2-68" title="68">    <span class="cf">return</span> branch&lt;PTRTrapezoidOsc::ptrRamp2&gt;(slope, pw, y, phase, tick) - dc;</a>
  <a class="sourceLine" id="cb2-69" title="69">  }</a>
  <a class="sourceLine" id="cb2-70" title="70"></a>
  <a class="sourceLine" id="cb2-71" title="71">  <span class="kw">template</span>&lt;<span class="dt">float</span> (*ptrfunc)(<span class="dt">float</span>, <span class="dt">float</span>)&gt;</a>
  <a class="sourceLine" id="cb2-72" title="72">  <span class="at">static</span> <span class="dt">float</span> branch(<span class="dt">float</span> slope, <span class="dt">float</span> pw, <span class="dt">float</span> y, <span class="dt">float</span> phase, <span class="dt">float</span> tick)</a>
  <a class="sourceLine" id="cb2-73" title="73">  {</a>
  <a class="sourceLine" id="cb2-74" title="74">    <span class="co">// ランプ関数のつぎはぎを行う分岐。</span></a>
  <a class="sourceLine" id="cb2-75" title="75">    <span class="cf">if</span> (phase &lt;= <span class="dt">float</span>(<span class="fl">0.25</span>) / slope) <span class="co">// Ramp 1</span></a>
  <a class="sourceLine" id="cb2-76" title="76">      <span class="cf">return</span> slope * ptrfunc(phase, tick);</a>
  <a class="sourceLine" id="cb2-77" title="77">    <span class="cf">else</span> <span class="cf">if</span> (phase &lt;= <span class="dt">float</span>(<span class="fl">0.5</span>) / slope) <span class="co">// Ramp 2</span></a>
  <a class="sourceLine" id="cb2-78" title="78">      <span class="cf">return</span> y - slope * ptrfunc(<span class="dt">float</span>(<span class="fl">0.5</span>) / slope - phase, tick);</a>
  <a class="sourceLine" id="cb2-79" title="79">    <span class="cf">else</span> <span class="cf">if</span> (phase &lt;= <span class="dt">float</span>(<span class="fl">0.5</span>) / slope + pw) <span class="co">// 台形の上辺。</span></a>
  <a class="sourceLine" id="cb2-80" title="80">      <span class="cf">return</span> y;</a>
  <a class="sourceLine" id="cb2-81" title="81">    <span class="cf">else</span> <span class="cf">if</span> (phase &lt;= <span class="dt">float</span>(<span class="fl">0.75</span>) / slope + pw) <span class="co">// Ramp 3</span></a>
  <a class="sourceLine" id="cb2-82" title="82">      <span class="cf">return</span> y - slope * ptrfunc(phase - <span class="dt">float</span>(<span class="fl">0.5</span>) / slope - pw, tick);</a>
  <a class="sourceLine" id="cb2-83" title="83">    <span class="cf">else</span> <span class="cf">if</span> (phase &lt;= <span class="dt">float</span>(<span class="dv">1</span>) / slope + pw) <span class="co">// Ramp 4</span></a>
  <a class="sourceLine" id="cb2-84" title="84">      <span class="cf">return</span> slope * ptrfunc(<span class="dt">float</span>(<span class="dv">1</span>) / slope + pw + -phase, tick);</a>
  <a class="sourceLine" id="cb2-85" title="85">    <span class="cf">return</span> <span class="dt">float</span>(<span class="dv">0</span>); <span class="co">// 残りを 0 埋め。台形の各部の名前の図の A2 にあたる領域。</span></a>
  <a class="sourceLine" id="cb2-86" title="86">  }</a>
  <a class="sourceLine" id="cb2-87" title="87"></a>
  <a class="sourceLine" id="cb2-88" title="88">  <span class="co">// 以降は PTR ランプ関数。</span></a>
  <a class="sourceLine" id="cb2-89" title="89">  <span class="at">static</span> <span class="dt">float</span> ptrRamp2(<span class="dt">float</span> phi, <span class="dt">float</span> T)</a>
  <a class="sourceLine" id="cb2-90" title="90">  {</a>
  <a class="sourceLine" id="cb2-91" title="91">    <span class="dt">float</span> n = phi / T;</a>
  <a class="sourceLine" id="cb2-92" title="92">    <span class="cf">if</span> (n &gt;= <span class="dt">float</span>(<span class="dv">1</span>)) <span class="cf">return</span> <span class="dt">float</span>(<span class="dv">2</span>) * T * n - <span class="dt">float</span>(<span class="dv">2</span>) * T;</a>
  <a class="sourceLine" id="cb2-93" title="93">    <span class="cf">if</span> (n &lt; <span class="dt">float</span>(<span class="dv">1</span>)) <span class="cf">return</span> (T * n * n * n) / <span class="dt">float</span>(<span class="dv">3</span>);</a>
  <a class="sourceLine" id="cb2-94" title="94">    <span class="cf">if</span> (n &lt; <span class="dt">float</span>(<span class="dv">2</span>))</a>
  <a class="sourceLine" id="cb2-95" title="95">      <span class="cf">return</span> -(T * n * n * n) / <span class="dt">float</span>(<span class="dv">3</span>) + <span class="dt">float</span>(<span class="dv">2</span>) * T * n * n - <span class="dt">float</span>(<span class="dv">2</span>) * T * n</a>
  <a class="sourceLine" id="cb2-96" title="96">        + (<span class="dt">float</span>(<span class="dv">2</span>) * T) / <span class="dt">float</span>(<span class="dv">3</span>);</a>
  <a class="sourceLine" id="cb2-97" title="97">    <span class="cf">return</span> <span class="fl">0.0</span>; <span class="co">// Just in case.</span></a>
  <a class="sourceLine" id="cb2-98" title="98">  }</a>
  <a class="sourceLine" id="cb2-99" title="99"></a>
  <a class="sourceLine" id="cb2-100" title="100">  <span class="at">static</span> <span class="dt">float</span> ptrRamp3(<span class="dt">float</span> phi, <span class="dt">float</span> T)</a>
  <a class="sourceLine" id="cb2-101" title="101">  {</a>
  <a class="sourceLine" id="cb2-102" title="102">    <span class="dt">float</span> n = phi / T;</a>
  <a class="sourceLine" id="cb2-103" title="103">    <span class="cf">if</span> (n &gt;= <span class="dt">float</span>(<span class="dv">2</span>)) <span class="cf">return</span> <span class="dt">float</span>(<span class="dv">2</span>) * T * n - <span class="dt">float</span>(<span class="dv">3</span>) * T;</a>
  <a class="sourceLine" id="cb2-104" title="104">    <span class="cf">if</span> (n &lt; <span class="dt">float</span>(<span class="dv">1</span>)) <span class="cf">return</span> (T * n * n * n * n) / <span class="dt">float</span>(<span class="dv">12</span>);</a>
  <a class="sourceLine" id="cb2-105" title="105">    <span class="cf">if</span> (n &lt; <span class="dt">float</span>(<span class="dv">2</span>))</a>
  <a class="sourceLine" id="cb2-106" title="106">      <span class="cf">return</span> -(T * n * n * n * n) / <span class="dt">float</span>(<span class="dv">6</span>) + T * n * n * n</a>
  <a class="sourceLine" id="cb2-107" title="107">        - (<span class="dt">float</span>(<span class="dv">3</span>) * T * n * n) / <span class="dt">float</span>(<span class="dv">2</span>) + T * n - T / <span class="dt">float</span>(<span class="dv">4</span>);</a>
  <a class="sourceLine" id="cb2-108" title="108">    <span class="cf">if</span> (n &lt; <span class="dt">float</span>(<span class="dv">3</span>))</a>
  <a class="sourceLine" id="cb2-109" title="109">      <span class="cf">return</span> (T * n * n * n * n) / <span class="dt">float</span>(<span class="dv">12</span>) - T * n * n * n</a>
  <a class="sourceLine" id="cb2-110" title="110">        + (<span class="dt">float</span>(<span class="dv">9</span>) * T * n * n) / <span class="dt">float</span>(<span class="dv">2</span>) - <span class="dt">float</span>(<span class="dv">7</span>) * T * n</a>
  <a class="sourceLine" id="cb2-111" title="111">        + (<span class="dt">float</span>(<span class="dv">15</span>) * T) / <span class="dt">float</span>(<span class="dv">4</span>);</a>
  <a class="sourceLine" id="cb2-112" title="112">    <span class="cf">return</span> <span class="fl">0.0</span>; <span class="co">// Just in case.</span></a>
  <a class="sourceLine" id="cb2-113" title="113">  }</a>
  <a class="sourceLine" id="cb2-114" title="114"></a>
  <a class="sourceLine" id="cb2-115" title="115">  <span class="at">static</span> <span class="dt">float</span> ptrRamp4(<span class="dt">float</span> phi, <span class="dt">float</span> T)</a>
  <a class="sourceLine" id="cb2-116" title="116">  {</a>
  <a class="sourceLine" id="cb2-117" title="117">    <span class="dt">float</span> n = phi / T;</a>
  <a class="sourceLine" id="cb2-118" title="118">    <span class="cf">if</span> (n &gt;= <span class="dt">float</span>(<span class="dv">3</span>)) <span class="cf">return</span> <span class="dt">float</span>(<span class="dv">2</span>) * T * n - <span class="dt">float</span>(<span class="dv">4</span>) * T;</a>
  <a class="sourceLine" id="cb2-119" title="119">    <span class="cf">if</span> (n &lt; <span class="dt">float</span>(<span class="dv">1</span>)) <span class="cf">return</span> (T * n * n * n * n * n) / <span class="dt">float</span>(<span class="dv">60</span>);</a>
  <a class="sourceLine" id="cb2-120" title="120">    <span class="cf">if</span> (n &lt; <span class="dt">float</span>(<span class="dv">2</span>))</a>
  <a class="sourceLine" id="cb2-121" title="121">      <span class="cf">return</span> -(T * n * n * n * n * n) / <span class="dt">float</span>(<span class="dv">20</span>) + (T * n * n * n * n) / <span class="dt">float</span>(<span class="dv">3</span>)</a>
  <a class="sourceLine" id="cb2-122" title="122">        - (<span class="dt">float</span>(<span class="dv">2</span>) * T * n * n * n) / <span class="dt">float</span>(<span class="dv">3</span>) + (<span class="dt">float</span>(<span class="dv">2</span>) * T * n * n) / <span class="dt">float</span>(<span class="dv">3</span>)</a>
  <a class="sourceLine" id="cb2-123" title="123">        - (T * n) / <span class="dt">float</span>(<span class="dv">3</span>) + T / <span class="dt">float</span>(<span class="dv">15</span>);</a>
  <a class="sourceLine" id="cb2-124" title="124">    <span class="cf">if</span> (n &lt; <span class="dt">float</span>(<span class="dv">3</span>))</a>
  <a class="sourceLine" id="cb2-125" title="125">      <span class="cf">return</span> (T * n * n * n * n * n) / <span class="dt">float</span>(<span class="dv">20</span>)</a>
  <a class="sourceLine" id="cb2-126" title="126">        - (<span class="dt">float</span>(<span class="dv">2</span>) * T * n * n * n * n) / <span class="dt">float</span>(<span class="dv">3</span>)</a>
  <a class="sourceLine" id="cb2-127" title="127">        + (<span class="dt">float</span>(<span class="dv">10</span>) * T * n * n * n) / <span class="dt">float</span>(<span class="dv">3</span>) - (<span class="dt">float</span>(<span class="dv">22</span>) * T * n * n) / <span class="dt">float</span>(<span class="dv">3</span>)</a>
  <a class="sourceLine" id="cb2-128" title="128">        + (<span class="dt">float</span>(<span class="dv">23</span>) * T * n) / <span class="dt">float</span>(<span class="dv">3</span>) - (<span class="dt">float</span>(<span class="dv">47</span>) * T) / <span class="dt">float</span>(<span class="dv">15</span>);</a>
  <a class="sourceLine" id="cb2-129" title="129">    <span class="cf">if</span> (n &lt; <span class="dt">float</span>(<span class="dv">4</span>))</a>
  <a class="sourceLine" id="cb2-130" title="130">      <span class="cf">return</span> -(T * n * n * n * n * n) / <span class="dt">float</span>(<span class="dv">60</span>) + (T * n * n * n * n) / <span class="dt">float</span>(<span class="dv">3</span>)</a>
  <a class="sourceLine" id="cb2-131" title="131">        - (<span class="dt">float</span>(<span class="dv">8</span>) * T * n * n * n) / <span class="dt">float</span>(<span class="dv">3</span>) + (<span class="dt">float</span>(<span class="dv">32</span>) * T * n * n) / <span class="dt">float</span>(<span class="dv">3</span>)</a>
  <a class="sourceLine" id="cb2-132" title="132">        - (<span class="dt">float</span>(<span class="dv">58</span>) * T * n) / <span class="dt">float</span>(<span class="dv">3</span>) + (<span class="dt">float</span>(<span class="dv">196</span>) * T) / <span class="dt">float</span>(<span class="dv">15</span>);</a>
  <a class="sourceLine" id="cb2-133" title="133">    <span class="cf">return</span> <span class="fl">0.0</span>; <span class="co">// Just in case.</span></a>
  <a class="sourceLine" id="cb2-134" title="134">  }</a>
  <a class="sourceLine" id="cb2-135" title="135"></a>
  <a class="sourceLine" id="cb2-136" title="136">  <span class="at">static</span> <span class="dt">float</span> ptrRamp5(<span class="dt">float</span> phi, <span class="dt">float</span> T)</a>
  <a class="sourceLine" id="cb2-137" title="137">  {</a>
  <a class="sourceLine" id="cb2-138" title="138">    <span class="dt">float</span> n = phi / T;</a>
  <a class="sourceLine" id="cb2-139" title="139">    <span class="cf">if</span> (n &gt;= <span class="dt">float</span>(<span class="dv">4</span>)) <span class="cf">return</span> <span class="dt">float</span>(<span class="dv">2</span>) * T * n - <span class="dt">float</span>(<span class="dv">5</span>) * T;</a>
  <a class="sourceLine" id="cb2-140" title="140">    <span class="cf">if</span> (n &lt; <span class="dt">float</span>(<span class="dv">1</span>)) <span class="cf">return</span> (T * n * n * n * n * n * n) / <span class="dt">float</span>(<span class="dv">360</span>);</a>
  <a class="sourceLine" id="cb2-141" title="141">    <span class="cf">if</span> (n &lt; <span class="dt">float</span>(<span class="dv">2</span>))</a>
  <a class="sourceLine" id="cb2-142" title="142">      <span class="cf">return</span> -(T * n * n * n * n * n * n) / <span class="dt">float</span>(<span class="dv">90</span>)</a>
  <a class="sourceLine" id="cb2-143" title="143">        + (T * n * n * n * n * n) / <span class="dt">float</span>(<span class="dv">12</span>) - (<span class="dt">float</span>(<span class="dv">5</span>) * T * n * n * n * n) / <span class="dt">float</span>(<span class="dv">24</span>)</a>
  <a class="sourceLine" id="cb2-144" title="144">        + (<span class="dt">float</span>(<span class="dv">5</span>) * T * n * n * n) / <span class="dt">float</span>(<span class="dv">18</span>) - (<span class="dt">float</span>(<span class="dv">5</span>) * T * n * n) / <span class="dt">float</span>(<span class="dv">24</span>)</a>
  <a class="sourceLine" id="cb2-145" title="145">        + (T * n) / <span class="dt">float</span>(<span class="dv">12</span>) - T / <span class="dt">float</span>(<span class="dv">72</span>);</a>
  <a class="sourceLine" id="cb2-146" title="146">    <span class="cf">if</span> (n &lt; <span class="dt">float</span>(<span class="dv">3</span>))</a>
  <a class="sourceLine" id="cb2-147" title="147">      <span class="cf">return</span> (T * n * n * n * n * n * n) / <span class="dt">float</span>(<span class="dv">60</span>) - (T * n * n * n * n * n) / <span class="dt">float</span>(<span class="dv">4</span>)</a>
  <a class="sourceLine" id="cb2-148" title="148">        + (<span class="dt">float</span>(<span class="dv">35</span>) * T * n * n * n * n) / <span class="dt">float</span>(<span class="dv">24</span>)</a>
  <a class="sourceLine" id="cb2-149" title="149">        - (<span class="dt">float</span>(<span class="dv">25</span>) * T * n * n * n) / <span class="dt">float</span>(<span class="dv">6</span>) + (<span class="dt">float</span>(<span class="dv">155</span>) * T * n * n) / <span class="dt">float</span>(<span class="dv">24</span>)</a>
  <a class="sourceLine" id="cb2-150" title="150">        - (<span class="dt">float</span>(<span class="dv">21</span>) * T * n) / <span class="dt">float</span>(<span class="dv">4</span>) + (<span class="dt">float</span>(<span class="dv">127</span>) * T) / <span class="dt">float</span>(<span class="dv">72</span>);</a>
  <a class="sourceLine" id="cb2-151" title="151">    <span class="cf">if</span> (n &lt; <span class="dt">float</span>(<span class="dv">4</span>))</a>
  <a class="sourceLine" id="cb2-152" title="152">      <span class="cf">return</span> -(T * n * n * n * n * n * n) / <span class="dt">float</span>(<span class="dv">90</span>) + (T * n * n * n * n * n) / <span class="dt">float</span>(<span class="dv">4</span>)</a>
  <a class="sourceLine" id="cb2-153" title="153">        - (<span class="dt">float</span>(<span class="dv">55</span>) * T * n * n * n * n) / <span class="dt">float</span>(<span class="dv">24</span>)</a>
  <a class="sourceLine" id="cb2-154" title="154">        + (<span class="dt">float</span>(<span class="dv">65</span>) * T * n * n * n) / <span class="dt">float</span>(<span class="dv">6</span>) - (<span class="dt">float</span>(<span class="dv">655</span>) * T * n * n) / <span class="dt">float</span>(<span class="dv">24</span>)</a>
  <a class="sourceLine" id="cb2-155" title="155">        + (<span class="dt">float</span>(<span class="dv">141</span>) * T * n) / <span class="dt">float</span>(<span class="dv">4</span>) - (<span class="dt">float</span>(<span class="dv">1331</span>) * T) / <span class="dt">float</span>(<span class="dv">72</span>);</a>
  <a class="sourceLine" id="cb2-156" title="156">    <span class="cf">if</span> (n &lt; <span class="dt">float</span>(<span class="dv">5</span>))</a>
  <a class="sourceLine" id="cb2-157" title="157">      <span class="cf">return</span> (T * n * n * n * n * n * n) / <span class="dt">float</span>(<span class="dv">360</span>)</a>
  <a class="sourceLine" id="cb2-158" title="158">        - (T * n * n * n * n * n) / <span class="dt">float</span>(<span class="dv">12</span>)</a>
  <a class="sourceLine" id="cb2-159" title="159">        + (<span class="dt">float</span>(<span class="dv">25</span>) * T * n * n * n * n) / <span class="dt">float</span>(<span class="dv">24</span>)</a>
  <a class="sourceLine" id="cb2-160" title="160">        - (<span class="dt">float</span>(<span class="dv">125</span>) * T * n * n * n) / <span class="dt">float</span>(<span class="dv">18</span>) + (<span class="dt">float</span>(<span class="dv">625</span>) * T * n * n) / <span class="dt">float</span>(<span class="dv">24</span>)</a>
  <a class="sourceLine" id="cb2-161" title="161">        - (<span class="dt">float</span>(<span class="dv">601</span>) * T * n) / <span class="dt">float</span>(<span class="dv">12</span>) + (<span class="dt">float</span>(<span class="dv">2765</span>) * T) / <span class="dt">float</span>(<span class="dv">72</span>);</a>
  <a class="sourceLine" id="cb2-162" title="162">    <span class="cf">return</span> <span class="fl">0.0</span>; <span class="co">// Just in case.</span></a>
  <a class="sourceLine" id="cb2-163" title="163">  }</a>
  <a class="sourceLine" id="cb2-164" title="164">};</a></code></pre></div>
    <footer>
    <a href="../index.html">インデックスに戻る</a>
  </footer>
</body>

</html>
