<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="" >

<head>
<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<meta name="dcterms.date" content="2020-04-04" />
<title>3pole_lowpass</title>

<!-- highlight.js -->
<link rel="stylesheet" href="../script/highlight/idea.css">
<script src="../script/highlight/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<!-- KaTeX -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.css"
integrity="sha384-yFRtMMDnQtDRO8rLpMIKrtPCD5jdktao2TV19YiZYWMDkUR5GQZR/NOVTdquEx1j" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.js"
integrity="sha384-9Nhn55MVVN0/4OFx7EE5kpFBPsEMZxKTCnA+4fqDmg12eCTqGi6+BB2LjY8brQxJ"
crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/contrib/auto-render.min.js"
integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"
onload="renderMathInElement(document.body);"></script>

<style>
body {
max-width: 704px;
margin: auto;
padding: 32px 8px;
font-size: 14px;
}

img {
max-width: 100%;
}

video {
max-width: 100%;
}

kbd {
border-style: solid;
border-width: 1px 2px 2px 1px;
border-radius: 2px;
padding: 2px;
margin: 2px;
}

a {
text-decoration: none;
}

h1,
h2,
h3,
h4,
h5,
h6 {
border-left: solid 8px #eeeeee;
padding-left: 8px;
}

table {
border-spacing: 0px;
border-collapse: separate;
border: 1px solid #dddddd;
}

tr.header {
border: 1px solid black;
}

tr.odd {
background: #eeeeee;
}

tr.even {
background: #ffffff;
}

th {
height: 2em;
font-weight: normal;
color: #004444;
padding-left: 0.35em;
padding-right: 0.35em;
border-bottom: 3px solid #dddddd;
border-left: 1px solid #dddddd;
}

td {
height: 1.5em;
padding-left: 0.35em;
padding-right: 0.35em;
border-bottom: 1px solid #dddddd;
border-left: 1px solid #dddddd;
}

audio {
vertical-align: middle;
}

label {
vertical-align: middle;
}

code {
color: #004444;
}

pre code {
border: 4px solid #eeeeee;
}

li {
margin: 8px;
}

header {
border-bottom: 1px gray solid;
padding: 0.5em;
margin-bottom: 1em;
}

footer {
border-top: 1px gray solid;
padding: 0.5em;
margin-top: 1em;
}

summary:hover {
background-color: #eeeeee;
}

canvas {
/* image-rendering: pixelated; */
display: inline-block;
border-style: solid;
border-width: 1px;
border-color: #627f84;
}

.controlBlock {
display: inline-block;
width: 450px;
text-align: left;
vertical-align: top;
margin-left: 4px;
}

input[type="button"] {
background-color: #ffffff;
border: 2px solid #aaaaaa;
font-size: 16px;
height: 32px;
}

input[type="button"]:hover {
background-color: #ffffff;
border: 2px solid #aaccff;
}

div.numberInput {
display: block;
white-space: nowrap;
}

div.numberInput:hover {
background-color: #e0ecff;
}

.numberInputLabel {
/* max 12 letter  */
display: inline-block;
margin: 0 8px 0 8px;
text-align: left;
vertical-align: middle;
width: 100px;

font-size: 10pt;
font-family: 'Courier New', Courier, monospace;
}

.numberInputNumber {
display: inline-block;
vertical-align: middle;
width: 120px;
}

.numberInputRange {
display: inline-block;
vertical-align: middle;
width: 160px;
}

.pullDownMenu {
display: inline-block;
text-align: center;
}

.pullDownMenu:hover {
background-color: #e0ecff;
}

select {
background-color: #ffffff;
border: 2px solid #aaaaaa;
height: 24px;
vertical-align: middle;
font-size: 12px;
}

select:hover {
background-color: #ffffff;
border: 2px solid #aaccff;
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS_CHTML-full" type="text/javascript"></script>
</head>

<body>
<header>
<p>
何かあれば <a href="https://github.com/ryukau/filter_notes">GitHub のリポジトリ</a>に issue を作るか ryukau@gmail.com までお気軽にどうぞ。
</p>
<hr>
<a href="../index.html">インデックスに戻る</a>
<p>
Update: 2020-04-04
</p>
<details>
<summary translate="yes">Table of Contents</summary>
<nav id="TOC" role="doc-toc">
  <ul>
  <li><a href="#pole-ローパスフィルタ">3-pole ローパスフィルタ</a><ul>
  <li><a href="#出力の大きさ">出力の大きさ</a></li>
  <li><a href="#伝達関数">伝達関数</a></li>
  <li><a href="#ローパスのカットオフ周波数のチューニング">ローパスのカットオフ周波数のチューニング</a></li>
  <li><a href="#レゾナンスのチューニング">レゾナンスのチューニング</a></li>
  <li><a href="#ハイパスのカットオフ周波数のチューニング">ハイパスのカットオフ周波数のチューニング</a></li>
  <li><a href="#実装">実装</a></li>
  <li><a href="#音のサンプル">音のサンプル</a><ul>
  <li><a href="#指数カーブのカットオフ">指数カーブのカットオフ</a></li>
  <li><a href="#直線のカットオフ">直線のカットオフ</a></li>
  </ul></li>
  <li><a href="#その他">その他</a></li>
  </ul></li>
  </ul>
</nav>
</details>
</header>
<h1 id="pole-ローパスフィルタ">3-pole ローパスフィルタ</h1>
<p>ばねとダンパの項を含んだ加速度の式がフィルタになりそうだと思いました。</p>
<p><span class="math display">\[
\ddot{u} = c \dot{u} + k u
\]</span></p>
<p><span class="math inline">\(c\)</span> はダンピング係数、 <span class="math inline">\(k\)</span> はばね係数です。</p>
<p><span class="math inline">\(\ddot{u}\)</span> の式から試行錯誤して以下の式を見つけました。</p>
<p><span class="math display">\[
\begin{aligned}
\ddot{u} =&amp; c \dot{u} + k \ddot{u} \\
\dot{u} \mathrel{{-}{=}}&amp; \ddot{u} + V[n] \\
u \mathrel{{-}{=}}&amp; \frac{c}{1 - k} \dot{u} \\
\end{aligned}
\]</span></p>
<p><span class="math inline">\(k u\)</span> が <span class="math inline">\(k \ddot{u}\)</span> になっているのは式からコードに翻訳したときの打ち間違いなのですが、上手く動いてしまいました。この時点で <span class="math inline">\(k\)</span> はばね係数ではなくなっています。</p>
<p><span class="math inline">\(V[n]\)</span> は入力信号から計算した速度です。</p>
<p><span class="math display">\[
V[n] = x[n] - x[n-1]
\]</span></p>
<p>係数 <span class="math inline">\(c\)</span> 、 <span class="math inline">\(k\)</span> 、 <span class="math inline">\(\alpha\)</span> の範囲は全て 0 以上、 1 以下です。</p>
<p><span class="math display">\[
0 \leq c \leq 1, \quad 0 \leq k \leq 1, \quad 0 \leq \alpha \leq 1
\]</span></p>
<p>実装です。</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb1-1" title="1"><span class="im">import</span> numpy <span class="im">as</span> np</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="im">import</span> scipy.signal <span class="im">as</span> signal</a>
<a class="sourceLine" id="cb1-3" title="3"><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> pyplot</a>
<a class="sourceLine" id="cb1-4" title="4"></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="kw">class</span> Model:</a>
<a class="sourceLine" id="cb1-6" title="6">    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, damping, spring_k):</a>
<a class="sourceLine" id="cb1-7" title="7">        <span class="va">self</span>.c <span class="op">=</span> damping</a>
<a class="sourceLine" id="cb1-8" title="8">        <span class="va">self</span>.k <span class="op">=</span> spring_k</a>
<a class="sourceLine" id="cb1-9" title="9"></a>
<a class="sourceLine" id="cb1-10" title="10">        <span class="va">self</span>.acc <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb1-11" title="11">        <span class="va">self</span>.vel <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb1-12" title="12">        <span class="va">self</span>.pos <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb1-13" title="13">        <span class="va">self</span>.x1 <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb1-14" title="14"></a>
<a class="sourceLine" id="cb1-15" title="15">    <span class="kw">def</span> process(<span class="va">self</span>, x0):</a>
<a class="sourceLine" id="cb1-16" title="16">        <span class="va">self</span>.acc <span class="op">=</span> <span class="va">self</span>.c <span class="op">*</span> <span class="va">self</span>.vel <span class="op">+</span> <span class="va">self</span>.k <span class="op">*</span> <span class="va">self</span>.acc</a>
<a class="sourceLine" id="cb1-17" title="17">        <span class="va">self</span>.vel <span class="op">-=</span> <span class="va">self</span>.acc <span class="op">+</span> x0 <span class="op">-</span> <span class="va">self</span>.x1</a>
<a class="sourceLine" id="cb1-18" title="18">        <span class="va">self</span>.pos <span class="op">-=</span> <span class="va">self</span>.c <span class="op">/</span> (<span class="dv">1</span> <span class="op">-</span> <span class="va">self</span>.k) <span class="op">*</span> <span class="va">self</span>.vel</a>
<a class="sourceLine" id="cb1-19" title="19"></a>
<a class="sourceLine" id="cb1-20" title="20">        <span class="va">self</span>.x1 <span class="op">=</span> x0</a>
<a class="sourceLine" id="cb1-21" title="21">        <span class="cf">return</span> <span class="va">self</span>.pos</a>
<a class="sourceLine" id="cb1-22" title="22"></a>
<a class="sourceLine" id="cb1-23" title="23">model <span class="op">=</span> Model(<span class="fl">0.01</span>, <span class="fl">0.96</span>)</a>
<a class="sourceLine" id="cb1-24" title="24"></a>
<a class="sourceLine" id="cb1-25" title="25">samplerate <span class="op">=</span> <span class="dv">48000</span></a>
<a class="sourceLine" id="cb1-26" title="26">duration <span class="op">=</span> <span class="fl">0.1</span></a>
<a class="sourceLine" id="cb1-27" title="27">frequency <span class="op">=</span> <span class="dv">60</span></a>
<a class="sourceLine" id="cb1-28" title="28"></a>
<a class="sourceLine" id="cb1-29" title="29">phase <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">2</span> <span class="op">*</span> np.pi <span class="op">*</span> frequency <span class="op">*</span> duration, <span class="bu">int</span>(duration <span class="op">*</span> samplerate))</a>
<a class="sourceLine" id="cb1-30" title="30">sig <span class="op">=</span> signal.square(phase)</a>
<a class="sourceLine" id="cb1-31" title="31"><span class="co"># sig = np.sin(phase)</span></a>
<a class="sourceLine" id="cb1-32" title="32"></a>
<a class="sourceLine" id="cb1-33" title="33">filtered <span class="op">=</span> np.array([model.process(x) <span class="cf">for</span> x <span class="kw">in</span> sig])</a>
<a class="sourceLine" id="cb1-34" title="34"></a>
<a class="sourceLine" id="cb1-35" title="35">pyplot.plot(sig)</a>
<a class="sourceLine" id="cb1-36" title="36">pyplot.plot(filtered)</a>
<a class="sourceLine" id="cb1-37" title="37">pyplot.show()</a></code></pre></div>
<p>係数を <span class="math inline">\(c = 0.01,\ k = 0.96\)</span> として、周波数 60 Hz 、デューティ比 50% の矩形波を入力したときの出力です。</p>
<figure>
<img src="img/Square.png" alt="Image of the filter output from 60 Hz square wave input." style="padding-bottom: 12px;"/>
</figure>
<p>係数を <span class="math inline">\(c = 0.01,\ k = 0.96\)</span> として 60 Hz のサイン波を入力したときの出力です。</p>
<figure>
<img src="img/Sin.png" alt="Image of the filter output from 60 Hz sine wave input." style="padding-bottom: 12px;"/>
</figure>
<p>性質を調べて <span class="math inline">\(c\)</span> と <span class="math inline">\(k\)</span> をチューニングします。</p>
<h2 id="出力の大きさ">出力の大きさ</h2>
<p><span class="math inline">\(u\)</span> の式で出力の大きさを調整しています。</p>
<p><span class="math display">\[
u \mathrel{{-}{=}} \frac{c}{1 - k} \dot{u}
\]</span></p>
<p><span class="math inline">\(\dot{u}\)</span> の係数に <span class="math inline">\(\dfrac{c}{1 - k}\)</span> を使うとカットオフ周波数が低くなっても出力の大きさがあまり変わりません。</p>
<p><span class="math inline">\(\dot{u}\)</span> の係数に <span class="math inline">\(c\)</span> を使うとカットオフ周波数が低くなると出力も小さくなります。</p>
<p>これらの係数は試行錯誤で見つけました。</p>
<h2 id="伝達関数">伝達関数</h2>
<p>フィルタの式に時間のインデックスをつけます。</p>
<p><span class="math display">\[
\begin{aligned}
\ddot{u}[n] =&amp; c \dot{u}[n-1] + k \ddot{u}[n-1] \\
\dot{u}[n] =&amp; \dot{u}[n-1] - \ddot{u}[n] - x[n] + x[n-1] \\
u[n] =&amp; \alpha \left( u[n-1] - \frac{c}{1 - k} \dot{u}[n] \right) \\
\end{aligned}
\]</span></p>
<p><span class="math inline">\(n\)</span> はサンプル数で表された現在の時刻、 <span class="math inline">\(\alpha\)</span> は直流を除去するために追加した適当な係数です。</p>
<p><span class="math inline">\(u[n]\)</span> の式を <span class="math inline">\(\dot{u}[n]\)</span> について解きます。</p>
<p><span class="math display">\[
\dot{u}[n] = \frac{1 - k}{c} \left( u[n-1] - \frac{1}{\alpha} u[n] \right)
\]</span></p>
<p><span class="math inline">\(\dot{u}[n]\)</span> の式を <span class="math inline">\(\ddot{u}[n]\)</span> について解きます。</p>
<p><span class="math display">\[
\ddot{u}[n] = \dot{u}[n-1] - \dot{u}[n] - x[n] + x[n-1]
\]</span></p>
<p>Maxima を使って <span class="math inline">\(u[n-i]\)</span> の項だけが残るように式を変形します。</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode maxima"><code class="sourceCode maxima"><a class="sourceLine" id="cb2-1" title="1"><span class="cn">d1_u</span>(<span class="cn">n</span>) := (<span class="dv">1</span> - <span class="cn">k</span>) / <span class="cn">c</span> * (<span class="cn">u</span>(<span class="cn">n</span> - <span class="dv">1</span>) - <span class="cn">u</span>(<span class="cn">n</span>) / α);</a>
<a class="sourceLine" id="cb2-2" title="2"><span class="cn">d2_u</span>(<span class="cn">n</span>) := <span class="cn">d1_u</span>(<span class="cn">n</span> - <span class="dv">1</span>) - <span class="cn">d1_u</span>(<span class="cn">n</span>) - <span class="cn">x</span>(<span class="cn">n</span>) + <span class="cn">x</span>(<span class="cn">n</span> - <span class="dv">1</span>);</a>
<a class="sourceLine" id="cb2-3" title="3"></a>
<a class="sourceLine" id="cb2-4" title="4"><span class="cn">result</span>: <span class="cn">d2_u</span>(<span class="cn">n</span>) = <span class="cn">c</span> * <span class="cn">d1_u</span>(<span class="cn">n</span> - <span class="dv">1</span>) + <span class="cn">k</span> * <span class="cn">d2_u</span>(<span class="cn">n</span> - <span class="dv">1</span>);</a>
<a class="sourceLine" id="cb2-5" title="5"></a>
<a class="sourceLine" id="cb2-6" title="6"><span class="fu">ratvars</span>(<span class="cn">u</span>(<span class="cn">n</span>), <span class="cn">u</span>(<span class="cn">n</span><span class="dv">-1</span>), <span class="cn">u</span>(<span class="cn">n</span><span class="dv">-2</span>), <span class="cn">u</span>(<span class="cn">n</span><span class="dv">-3</span>), <span class="cn">x</span>(<span class="cn">n</span>), <span class="cn">x</span>(<span class="cn">n</span><span class="dv">-1</span>), <span class="cn">x</span>(<span class="cn">n</span><span class="dv">-2</span>), <span class="cn">x</span>(<span class="cn">n</span><span class="dv">-3</span>));</a>
<a class="sourceLine" id="cb2-7" title="7"><span class="fu">ratexpand</span>(<span class="dv">0</span> = <span class="fu">lhs</span>(<span class="cn">result</span>) - <span class="fu">rhs</span>(<span class="cn">result</span>));</a></code></pre></div>
<p>出力です。</p>
<p><span class="math display">\[
\begin{aligned}
0=&amp;
- x(n)
\\&amp;
+ k x(n-1) + x( n-1)
\\&amp;
- k x(n-2)
\\&amp;
-\frac{k u(n)}{c \alpha}+\frac{u(n)}{c \alpha }
\\&amp;
+\frac{k^2 u(n-1)}{c \alpha}
- \frac{u(n-1)}{c \alpha}
- \frac{k u(n-1)}{\alpha}
+ \frac{u(n-1)}{\alpha}
+ \frac{k u(n-1)}{c}
- \frac{u(n-1)}{c}
\\&amp;
- \frac{k^2 u(n-2)}{c \alpha}
+ \frac{k u(n-2)}{c \alpha}
- \frac{k^2 u(n-2)}{c}
+ \frac{u(n-2)}{c}
+ k u(n-2)
- u(n-2)
\\&amp;
+ \frac{k^2 u(n-3)}{c}
- \frac{k u(n-3)}{c}
\end{aligned}
\]</span></p>
<p>出力を整理した式です。</p>
<p><span class="math display">\[
\begin{aligned}
x[n] - (1 + k) x[n-1] + k x[n-2]
=&amp;
- \frac{k - 1}{c \alpha} u[n]
\\&amp;
+ \left( \frac{k^2 - 1}{c \alpha} - \frac{k - 1}{\alpha} + \frac{k - 1}{c} \right) u[n-1]
\\&amp;
+ \left( -\frac{k^2 - k}{c \alpha} - \frac{k^2 - 1}{c} + k - 1 \right) u[n-2]
\\&amp;
+ \frac{k^2 - k}{c} u[n-3]
\end{aligned}
\]</span></p>
<p>伝達関数が得られました。</p>
<p><span class="math display">\[
H(z) = \frac{
  1 - (k + 1) z^{-1} + k z^{-2}
}{
    C_0
  + C_1 z^{-1}
  + C_2 z^{-2}
  + C_3 z^{-3}
}
\qquad
\begin{aligned}
C_0 &amp;= - \frac{k - 1}{c \alpha} \\
C_1 &amp;= \frac{k^2 - 1}{c \alpha} - \frac{k - 1}{\alpha} + \frac{k - 1}{c} \\
C_2 &amp;= -\frac{k^2 - k}{c \alpha} - \frac{k^2 - 1}{c} + k - 1 \\
C_3 &amp;= \frac{k^2 - k}{c} \\
\end{aligned}
\]</span></p>
<h2 id="ローパスのカットオフ周波数のチューニング">ローパスのカットオフ周波数のチューニング</h2>
<p>伝達関数から Maxima でカットオフ周波数 <span class="math inline">\(\omega_c\)</span> を求めようとしたのですが、上手く行かなかったので周波数特性から適当なチューニング曲線を作ります。</p>
<p>係数 <span class="math inline">\(c\)</span> の値を変えるとカットオフ周波数 <span class="math inline">\(\omega_c\)</span> が変わるようなので <code>scipy.signal.freqz</code> から得られる振幅特性を使って <span class="math inline">\(c\)</span> と <span class="math inline">\(\omega_c\)</span> の関係をプロットします。 <span class="math inline">\(k\)</span> の値は 0 に固定します。</p>
<p>次のコードを Python3 のインタープリターにコピペすると動きます。 <a href="https://numpy.org/">NumPy</a> 、 <a href="https://scipy.org/">SciPy</a> 、 <a href="https://matplotlib.org/">Matplotlib</a> が必要です。</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb3-1" title="1"><span class="im">import</span> numpy <span class="im">as</span> np</a>
<a class="sourceLine" id="cb3-2" title="2"><span class="im">import</span> scipy.signal <span class="im">as</span> signal</a>
<a class="sourceLine" id="cb3-3" title="3"><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> pyplot</a>
<a class="sourceLine" id="cb3-4" title="4"></a>
<a class="sourceLine" id="cb3-5" title="5"><span class="kw">def</span> transferFunction(c, k, α<span class="op">=</span><span class="dv">1</span>):</a>
<a class="sourceLine" id="cb3-6" title="6">    <span class="cf">return</span> (</a>
<a class="sourceLine" id="cb3-7" title="7">        [<span class="dv">1</span>, <span class="op">-</span>(k <span class="op">+</span> <span class="dv">1</span>), k, <span class="dv">0</span>],</a>
<a class="sourceLine" id="cb3-8" title="8">        [</a>
<a class="sourceLine" id="cb3-9" title="9">            <span class="op">-</span>(k <span class="op">-</span> <span class="dv">1</span>) <span class="op">/</span> (c <span class="op">*</span> α),</a>
<a class="sourceLine" id="cb3-10" title="10">            (k <span class="op">*</span> k <span class="op">-</span> <span class="dv">1</span>) <span class="op">/</span> (c <span class="op">*</span> α) <span class="op">-</span> (k <span class="op">-</span> <span class="dv">1</span>) <span class="op">/</span> α <span class="op">+</span> (k <span class="op">-</span> <span class="dv">1</span>) <span class="op">/</span> c,</a>
<a class="sourceLine" id="cb3-11" title="11">            k <span class="op">*</span> (k <span class="op">-</span> <span class="dv">1</span>) <span class="op">/</span> (c <span class="op">*</span> α) <span class="op">-</span> (k <span class="op">*</span> k <span class="op">-</span> <span class="dv">1</span>) <span class="op">/</span> c <span class="op">+</span> k <span class="op">-</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb3-12" title="12">            k <span class="op">*</span> (k <span class="op">-</span> <span class="dv">1</span>) <span class="op">/</span> c,</a>
<a class="sourceLine" id="cb3-13" title="13">        ],</a>
<a class="sourceLine" id="cb3-14" title="14">    )</a>
<a class="sourceLine" id="cb3-15" title="15"></a>
<a class="sourceLine" id="cb3-16" title="16"><span class="kw">def</span> cutoffPlot():</a>
<a class="sourceLine" id="cb3-17" title="17">    cmap <span class="op">=</span> pyplot.get_cmap(<span class="st">&quot;viridis&quot;</span>)</a>
<a class="sourceLine" id="cb3-18" title="18">    nPlot <span class="op">=</span> <span class="dv">12</span></a>
<a class="sourceLine" id="cb3-19" title="19">    <span class="cf">for</span> idx, c <span class="kw">in</span> <span class="bu">enumerate</span>(np.geomspace(<span class="fl">1e-5</span>, <span class="dv">1</span>, nPlot)):</a>
<a class="sourceLine" id="cb3-20" title="20">        <span class="co">#</span></a>
<a class="sourceLine" id="cb3-21" title="21">        <span class="co"># 振幅特性をプロット。</span></a>
<a class="sourceLine" id="cb3-22" title="22">        b, a <span class="op">=</span> transferFunction(c, <span class="fl">0.0</span>)</a>
<a class="sourceLine" id="cb3-23" title="23">        ω, h <span class="op">=</span> signal.freqz(b, a, <span class="dv">2</span><span class="op">**</span><span class="dv">16</span>)</a>
<a class="sourceLine" id="cb3-24" title="24">        gain <span class="op">=</span> <span class="dv">20</span> <span class="op">*</span> np.log10(<span class="bu">abs</span>(h))</a>
<a class="sourceLine" id="cb3-25" title="25">        pyplot.plot(ω, gain, color<span class="op">=</span>cmap(idx <span class="op">/</span> nPlot), label<span class="op">=</span><span class="ss">f&quot;c=</span><span class="sc">{c:.3f}</span><span class="ss">&quot;</span>)</a>
<a class="sourceLine" id="cb3-26" title="26">        <span class="co">#</span></a>
<a class="sourceLine" id="cb3-27" title="27">        <span class="co"># -3 dB の ω_c を探す。</span></a>
<a class="sourceLine" id="cb3-28" title="28">        index <span class="op">=</span> np.argmax(gain <span class="op">&lt;=</span> <span class="dv">-3</span>)</a>
<a class="sourceLine" id="cb3-29" title="29">        <span class="cf">if</span> index <span class="op">&lt;</span> <span class="dv">2</span>:</a>
<a class="sourceLine" id="cb3-30" title="30">            <span class="cf">continue</span></a>
<a class="sourceLine" id="cb3-31" title="31">        prev <span class="op">=</span> index <span class="op">-</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb3-32" title="32">        delta_range <span class="op">=</span> gain[index] <span class="op">-</span> gain[prev]</a>
<a class="sourceLine" id="cb3-33" title="33">        ratio <span class="op">=</span> (<span class="op">-</span><span class="dv">3</span> <span class="op">-</span> gain[prev]) <span class="op">/</span> delta_range</a>
<a class="sourceLine" id="cb3-34" title="34">        x <span class="op">=</span> ω[prev] <span class="op">+</span> ratio <span class="op">*</span> (ω[index] <span class="op">-</span> ω[prev])</a>
<a class="sourceLine" id="cb3-35" title="35">        y <span class="op">=</span> gain[prev] <span class="op">+</span> ratio <span class="op">*</span> delta_range</a>
<a class="sourceLine" id="cb3-36" title="36">        pyplot.scatter(x, y, color<span class="op">=</span>cmap(idx <span class="op">/</span> nPlot))</a>
<a class="sourceLine" id="cb3-37" title="37">    pyplot.xscale(<span class="st">&quot;log&quot;</span>)</a>
<a class="sourceLine" id="cb3-38" title="38">    pyplot.show()</a>
<a class="sourceLine" id="cb3-39" title="39"></a>
<a class="sourceLine" id="cb3-40" title="40">cutoffPlot()</a></code></pre></div>
<p>出力された振幅特性のプロットです。丸い点は対応する色の振幅特性の -3 dB の位置を表しています。</p>
<figure>
<img src="img/AmplitudeResponse.png" alt="Image of amplitude responce plot." style="padding-bottom: 12px;"/>
</figure>
<p>カットオフ周波数 <span class="math inline">\(\omega_c\)</span> と対応する係数 <span class="math inline">\(c\)</span> の値をプロットします。</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">def</span> dampingCutoffPlot():</a>
<a class="sourceLine" id="cb4-2" title="2">    cmapReal <span class="op">=</span> pyplot.get_cmap(<span class="st">&quot;viridis&quot;</span>)</a>
<a class="sourceLine" id="cb4-3" title="3">    xC <span class="op">=</span> np.linspace(<span class="fl">1e-5</span>, <span class="dv">1</span>, <span class="dv">128</span>)</a>
<a class="sourceLine" id="cb4-4" title="4">    data <span class="op">=</span> []</a>
<a class="sourceLine" id="cb4-5" title="5">    <span class="cf">for</span> idx, c <span class="kw">in</span> <span class="bu">enumerate</span>(xC):</a>
<a class="sourceLine" id="cb4-6" title="6">        b, a <span class="op">=</span> transferFunction(c, <span class="fl">0.0</span>)</a>
<a class="sourceLine" id="cb4-7" title="7">        ω, h <span class="op">=</span> signal.freqz(b, a, <span class="dv">2</span><span class="op">**</span><span class="dv">16</span>)</a>
<a class="sourceLine" id="cb4-8" title="8">        gain <span class="op">=</span> <span class="dv">20</span> <span class="op">*</span> np.log10(<span class="bu">abs</span>(h))</a>
<a class="sourceLine" id="cb4-9" title="9">        index <span class="op">=</span> np.argmax(gain <span class="op">&lt;=</span> <span class="dv">-3</span>)</a>
<a class="sourceLine" id="cb4-10" title="10">        <span class="cf">if</span> index <span class="op">&lt;</span> <span class="dv">2</span>:</a>
<a class="sourceLine" id="cb4-11" title="11">            <span class="cf">continue</span></a>
<a class="sourceLine" id="cb4-12" title="12">        prev <span class="op">=</span> index <span class="op">-</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb4-13" title="13">        delta_range <span class="op">=</span> gain[index] <span class="op">-</span> gain[prev]</a>
<a class="sourceLine" id="cb4-14" title="14">        ratio <span class="op">=</span> (<span class="op">-</span><span class="dv">3</span> <span class="op">-</span> gain[prev]) <span class="op">/</span> delta_range</a>
<a class="sourceLine" id="cb4-15" title="15">        cutoff <span class="op">=</span> ω[prev] <span class="op">+</span> ratio <span class="op">*</span> (ω[index] <span class="op">-</span> ω[prev])</a>
<a class="sourceLine" id="cb4-16" title="16">        data.append((c, cutoff))</a>
<a class="sourceLine" id="cb4-17" title="17">        pyplot.scatter(cutoff, c, color<span class="op">=</span>cmapReal(idx <span class="op">/</span> <span class="bu">len</span>(xC)))</a>
<a class="sourceLine" id="cb4-18" title="18">    <span class="co">#</span></a>
<a class="sourceLine" id="cb4-19" title="19">    <span class="co"># [0, 1] に正規化された周波数から c を計算するための近似曲線を求める。</span></a>
<a class="sourceLine" id="cb4-20" title="20">    xC_fit, ω_c_fit <span class="op">=</span> <span class="bu">zip</span>(<span class="op">*</span>data)</a>
<a class="sourceLine" id="cb4-21" title="21">    ω_c_fit <span class="op">=</span> np.array(ω_c_fit) <span class="op">/</span> <span class="dv">2</span> <span class="op">/</span> np.pi</a>
<a class="sourceLine" id="cb4-22" title="22">    polyCoef <span class="op">=</span> np.polyfit(ω_c_fit, xC_fit, <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb4-23" title="23">    <span class="bu">print</span>([p <span class="cf">for</span> p <span class="kw">in</span> polyCoef])</a>
<a class="sourceLine" id="cb4-24" title="24">    polyCoef[<span class="op">-</span><span class="dv">1</span>] <span class="op">=</span> <span class="dv">0</span>  <span class="co"># ω_c = 0 のとき c = 0 となるように定数を変更。</span></a>
<a class="sourceLine" id="cb4-25" title="25">    poly <span class="op">=</span> np.poly1d(polyCoef)</a>
<a class="sourceLine" id="cb4-26" title="26">    curveX <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1024</span>)</a>
<a class="sourceLine" id="cb4-27" title="27">    curveY <span class="op">=</span> poly(curveX)</a>
<a class="sourceLine" id="cb4-28" title="28">    pyplot.plot(curveX <span class="op">*</span> <span class="dv">2</span> <span class="op">*</span> np.pi, curveY, label<span class="op">=</span><span class="st">&quot;polyfit&quot;</span>)</a>
<a class="sourceLine" id="cb4-29" title="29">    <span class="co">#</span></a>
<a class="sourceLine" id="cb4-30" title="30">    <span class="co"># プロット。</span></a>
<a class="sourceLine" id="cb4-31" title="31">    pyplot.title(<span class="st">&quot;c - ω_c Plot&quot;</span>)</a>
<a class="sourceLine" id="cb4-32" title="32">    pyplot.ylabel(<span class="st">&quot;c&quot;</span>)</a>
<a class="sourceLine" id="cb4-33" title="33">    pyplot.xlabel(<span class="st">&quot;Cutoff Frequency [rad/sample]&quot;</span>)</a>
<a class="sourceLine" id="cb4-34" title="34">    pyplot.legend()</a>
<a class="sourceLine" id="cb4-35" title="35">    pyplot.grid()</a>
<a class="sourceLine" id="cb4-36" title="36">    pyplot.show()</a>
<a class="sourceLine" id="cb4-37" title="37"></a>
<a class="sourceLine" id="cb4-38" title="38">dampingCutoffPlot()</a></code></pre></div>
<p>出力された <span class="math inline">\(c \text{--} \omega_c\)</span> プロットです。丸い点が実データ、曲線は 6 次の多項式による近似曲線です。</p>
<figure>
<img src="img/Factor_cCutoffPlot.png" alt="Image of c-ω_c plot." style="padding-bottom: 12px;"/>
</figure>
<p>カットオフ周波数 <span class="math inline">\(\omega_c\)</span> から係数 <span class="math inline">\(c\)</span> を求める近似曲線の多項式です。中点 <span class="math inline">\(\cdot\)</span> は乗算を表しています。 <span class="math inline">\(x = \dfrac{\omega_c}{\pi}\)</span> と定義しています。</p>
<p><span class="math display">\[
\begin{aligned}
c \approx &amp; 56.85341479156533 \cdot x^6 - 60.92051508862034 \cdot x^5 - 1.6515635438744682 \cdot x^4 \\
  &amp; + 31.558896956675998 \cdot x^3 - 20.61402812645397 \cdot x^2 + 6.320753515093109 \cdot x
\end{aligned}
\]</span></p>
<p>カットオフ周波数 <span class="math inline">\(\omega_c\)</span> から係数 <span class="math inline">\(c\)</span> を求める多項式の C++ の実装です。</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb5-1" title="1"><span class="dt">float</span> lowpassHzToC(<span class="dt">float</span> sampleRate, <span class="dt">float</span> cutoffHz)</a>
<a class="sourceLine" id="cb5-2" title="2">{</a>
<a class="sourceLine" id="cb5-3" title="3">  <span class="dt">float</span> x = cutoffHz / sampleRate;</a>
<a class="sourceLine" id="cb5-4" title="4">  <span class="cf">return</span> <span class="dt">float</span>(<span class="fl">56.85341479156533</span>) * x * x * x * x * x * x</a>
<a class="sourceLine" id="cb5-5" title="5">    + <span class="dt">float</span>(-<span class="fl">60.92051508862034</span>)   * x * x * x * x * x</a>
<a class="sourceLine" id="cb5-6" title="6">    + <span class="dt">float</span>(-<span class="fl">1.6515635438744682</span>)  * x * x * x * x</a>
<a class="sourceLine" id="cb5-7" title="7">    + <span class="dt">float</span>(<span class="fl">31.558896956675998</span>)   * x * x * x</a>
<a class="sourceLine" id="cb5-8" title="8">    + <span class="dt">float</span>(-<span class="fl">20.61402812645397</span>)   * x * x</a>
<a class="sourceLine" id="cb5-9" title="9">    + <span class="dt">float</span>(<span class="fl">6.320753515093109</span>)    * x;</a>
<a class="sourceLine" id="cb5-10" title="10">}</a></code></pre></div>
<p>次のような式の書き方もできますが、 <code>g++ -O3</code> で chrono を使って簡単なベンチマークを取ったところ、私の環境では計算速度は変わらなかったです。</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb6-1" title="1"><span class="dt">float</span> lowpassHzToC(<span class="dt">float</span> sampleRate, <span class="dt">float</span> cutoffHz)</a>
<a class="sourceLine" id="cb6-2" title="2">{</a>
<a class="sourceLine" id="cb6-3" title="3">  <span class="dt">float</span> x = cutoffHz / sampleRate;</a>
<a class="sourceLine" id="cb6-4" title="4">  <span class="cf">return</span> (((((<span class="dt">float</span>(<span class="fl">56.85341479156533</span>) * x + <span class="dt">float</span>(-<span class="fl">60.92051508862034</span>)</a>
<a class="sourceLine" id="cb6-5" title="5">    ) * x + <span class="dt">float</span>(-<span class="fl">1.6515635438744682</span>)</a>
<a class="sourceLine" id="cb6-6" title="6">    ) * x + <span class="dt">float</span>(<span class="fl">31.558896956675998</span>)</a>
<a class="sourceLine" id="cb6-7" title="7">    ) * x + <span class="dt">float</span>(-<span class="fl">20.61402812645397</span>)</a>
<a class="sourceLine" id="cb6-8" title="8">    ) * x + <span class="dt">float</span>(<span class="fl">6.320753515093109</span>)</a>
<a class="sourceLine" id="cb6-9" title="9">    ) * x;</a>
<a class="sourceLine" id="cb6-10" title="10">}</a></code></pre></div>
<h2 id="レゾナンスのチューニング">レゾナンスのチューニング</h2>
<p>フィルタの式の係数 <span class="math inline">\(k\)</span> を変えるとレゾナンスが変わるようです。レゾナンスを変えたときの振幅のピークが一定になるようにチューニングします。</p>
<p>まずは <span class="math inline">\(k\)</span> を変えたときに振幅特性のピークがどう変わるかを調べました。</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb7-1" title="1"><span class="kw">def</span> resonancePeakPlot():</a>
<a class="sourceLine" id="cb7-2" title="2">    cmap <span class="op">=</span> pyplot.get_cmap(<span class="st">&quot;viridis&quot;</span>)</a>
<a class="sourceLine" id="cb7-3" title="3">    nC <span class="op">=</span> <span class="dv">10</span></a>
<a class="sourceLine" id="cb7-4" title="4">    kArray <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> np.geomspace(<span class="fl">1e-5</span>, <span class="dv">1</span>, <span class="dv">128</span>)</a>
<a class="sourceLine" id="cb7-5" title="5">    <span class="cf">for</span> idx, c <span class="kw">in</span> <span class="bu">enumerate</span>(np.linspace(<span class="fl">0.1</span>, <span class="dv">1</span>, nC)):</a>
<a class="sourceLine" id="cb7-6" title="6">        dataY <span class="op">=</span> []</a>
<a class="sourceLine" id="cb7-7" title="7">        <span class="cf">for</span> k <span class="kw">in</span> kArray:</a>
<a class="sourceLine" id="cb7-8" title="8">            b, a <span class="op">=</span> transferFunction(c, k, <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb7-9" title="9">            ω, h <span class="op">=</span> signal.freqz(b, a, <span class="dv">2</span><span class="op">**</span><span class="dv">16</span>)</a>
<a class="sourceLine" id="cb7-10" title="10">            h[np.isfinite(h) <span class="op">==</span> <span class="va">False</span>] <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb7-11" title="11">            peak <span class="op">=</span> np.<span class="bu">max</span>(np.<span class="bu">abs</span>(h))</a>
<a class="sourceLine" id="cb7-12" title="12">            <span class="cf">if</span> <span class="kw">not</span> np.isfinite(peak):</a>
<a class="sourceLine" id="cb7-13" title="13">                <span class="bu">print</span>(idx, c, k, peak)</a>
<a class="sourceLine" id="cb7-14" title="14">            dataY.append(peak)</a>
<a class="sourceLine" id="cb7-15" title="15">        pyplot.plot(<span class="dv">1</span> <span class="op">-</span> kArray, dataY, color<span class="op">=</span>cmap(idx <span class="op">/</span> nC), label<span class="op">=</span><span class="ss">f&quot;c=</span><span class="sc">{c:.3f}</span><span class="ss">&quot;</span>)</a>
<a class="sourceLine" id="cb7-16" title="16">    pyplot.ylabel(<span class="st">&quot;Peak Amplitude&quot;</span>)</a>
<a class="sourceLine" id="cb7-17" title="17">    pyplot.xlabel(<span class="st">&quot;1 - k&quot;</span>)</a>
<a class="sourceLine" id="cb7-18" title="18">    pyplot.xscale(<span class="st">&quot;log&quot;</span>)</a>
<a class="sourceLine" id="cb7-19" title="19">    pyplot.yscale(<span class="st">&quot;log&quot;</span>)</a>
<a class="sourceLine" id="cb7-20" title="20">    pyplot.grid()</a>
<a class="sourceLine" id="cb7-21" title="21">    pyplot.legend()</a>
<a class="sourceLine" id="cb7-22" title="22">    pyplot.show()</a>
<a class="sourceLine" id="cb7-23" title="23"></a>
<a class="sourceLine" id="cb7-24" title="24">resonancePeakPlot()</a></code></pre></div>
<p>出力されたプロットです。</p>
<figure>
<img src="img/PeakKPlot.png" alt="Image of ." style="padding-bottom: 12px;"/>
</figure>
<p><span class="math inline">\(c\)</span> の値によらず、 <span class="math inline">\(k\)</span> が 0 に近づくと指数関数的にピークが大きくなっています。近似曲線を 1 つ作って <span class="math inline">\(c\)</span> に応じてスケーリングを変えれば良さそうです。</p>
<p>振幅特性のピーク値を <span class="math inline">\(p\)</span> とします。二分探索を使って任意の <span class="math inline">\(p\)</span> と <span class="math inline">\(c\)</span> の値から <span class="math inline">\(k\)</span> を探します。次のコードを実行すると <code>data.json</code> ファイルを作成して計算結果を書き込みます。</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb8-1" title="1"><span class="im">import</span> json</a>
<a class="sourceLine" id="cb8-2" title="2"></a>
<a class="sourceLine" id="cb8-3" title="3"><span class="kw">def</span> findUniformResonance():</a>
<a class="sourceLine" id="cb8-4" title="4">    maxIteration <span class="op">=</span> <span class="dv">256</span></a>
<a class="sourceLine" id="cb8-5" title="5">    data <span class="op">=</span> []</a>
<a class="sourceLine" id="cb8-6" title="6">    targetPeak <span class="op">=</span> np.geomspace(<span class="dv">1</span>, <span class="fl">1e5</span>, <span class="dv">16</span>)</a>
<a class="sourceLine" id="cb8-7" title="7">    nC <span class="op">=</span> <span class="dv">128</span></a>
<a class="sourceLine" id="cb8-8" title="8">    xC <span class="op">=</span> np.geomspace(<span class="fl">1e-4</span>, <span class="dv">1</span>, nC)</a>
<a class="sourceLine" id="cb8-9" title="9">    <span class="cf">for</span> target <span class="kw">in</span> targetPeak:</a>
<a class="sourceLine" id="cb8-10" title="10">        peakData <span class="op">=</span> []</a>
<a class="sourceLine" id="cb8-11" title="11">        <span class="cf">for</span> c <span class="kw">in</span> xC:</a>
<a class="sourceLine" id="cb8-12" title="12">            jdx <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb8-13" title="13">            diff <span class="op">=</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb8-14" title="14">            k <span class="op">=</span> <span class="fl">0.5</span></a>
<a class="sourceLine" id="cb8-15" title="15">            delta <span class="op">=</span> k</a>
<a class="sourceLine" id="cb8-16" title="16">            peak <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb8-17" title="17">            <span class="cf">while</span> diff <span class="op">&gt;</span> <span class="fl">1e-5</span> <span class="kw">and</span> jdx <span class="op">&lt;</span> maxIteration:</a>
<a class="sourceLine" id="cb8-18" title="18">                b, a <span class="op">=</span> transferFunction(c, k)</a>
<a class="sourceLine" id="cb8-19" title="19">                ω, h <span class="op">=</span> signal.freqz(b, a, <span class="dv">2</span><span class="op">**</span><span class="dv">16</span>)</a>
<a class="sourceLine" id="cb8-20" title="20">                h[np.isfinite(h) <span class="op">==</span> <span class="va">False</span>] <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb8-21" title="21">                peak <span class="op">=</span> np.<span class="bu">max</span>(np.<span class="bu">abs</span>(h))</a>
<a class="sourceLine" id="cb8-22" title="22">                diff <span class="op">=</span> <span class="bu">abs</span>(target <span class="op">-</span> peak)</a>
<a class="sourceLine" id="cb8-23" title="23">                delta <span class="op">*=</span> <span class="fl">0.5</span></a>
<a class="sourceLine" id="cb8-24" title="24">                <span class="cf">if</span> peak <span class="op">&lt;</span> target:</a>
<a class="sourceLine" id="cb8-25" title="25">                    k <span class="op">+=</span> delta</a>
<a class="sourceLine" id="cb8-26" title="26">                <span class="cf">else</span>:</a>
<a class="sourceLine" id="cb8-27" title="27">                    k <span class="op">-=</span> delta</a>
<a class="sourceLine" id="cb8-28" title="28">                jdx <span class="op">+=</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb8-29" title="29">            <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="sc">{</span>target<span class="sc">}</span><span class="ss">, </span><span class="sc">{c}</span><span class="ss">, </span><span class="sc">{k}</span><span class="ss">, </span><span class="sc">{</span>peak<span class="sc">}</span><span class="ss">&quot;</span>)</a>
<a class="sourceLine" id="cb8-30" title="30">            peakData.append({<span class="st">&quot;c&quot;</span>: c, <span class="st">&quot;k&quot;</span>: k, <span class="st">&quot;peak&quot;</span>: peak})</a>
<a class="sourceLine" id="cb8-31" title="31">        data.append({</a>
<a class="sourceLine" id="cb8-32" title="32">            <span class="st">&quot;targetPeak&quot;</span>: target,</a>
<a class="sourceLine" id="cb8-33" title="33">            <span class="st">&quot;c&quot;</span>: [d[<span class="st">&quot;c&quot;</span>] <span class="cf">for</span> d <span class="kw">in</span> peakData],</a>
<a class="sourceLine" id="cb8-34" title="34">            <span class="st">&quot;k&quot;</span>: [d[<span class="st">&quot;k&quot;</span>] <span class="cf">for</span> d <span class="kw">in</span> peakData],</a>
<a class="sourceLine" id="cb8-35" title="35">            <span class="st">&quot;peak&quot;</span>: [d[<span class="st">&quot;peak&quot;</span>] <span class="cf">for</span> d <span class="kw">in</span> peakData],</a>
<a class="sourceLine" id="cb8-36" title="36">        })</a>
<a class="sourceLine" id="cb8-37" title="37">    <span class="cf">with</span> <span class="bu">open</span>(<span class="st">&quot;data.json&quot;</span>, <span class="st">&quot;w&quot;</span>) <span class="im">as</span> fi:</a>
<a class="sourceLine" id="cb8-38" title="38">        json.dump(data, fi, indent<span class="op">=</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb8-39" title="39"></a>
<a class="sourceLine" id="cb8-40" title="40">findUniformResonance()</a></code></pre></div>
<p>出力された <code>data.json</code> から <span class="math inline">\(c\)</span> と <span class="math inline">\(k\)</span> についてプロットします。点線は近似曲線です。</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb9-1" title="1"><span class="kw">def</span> plotResonance(data):</a>
<a class="sourceLine" id="cb9-2" title="2">    cmapV <span class="op">=</span> pyplot.get_cmap(<span class="st">&quot;viridis&quot;</span>)</a>
<a class="sourceLine" id="cb9-3" title="3">    cmapP <span class="op">=</span> pyplot.get_cmap(<span class="st">&quot;plasma&quot;</span>)</a>
<a class="sourceLine" id="cb9-4" title="4">    <span class="cf">for</span> idx, dat <span class="kw">in</span> <span class="bu">enumerate</span>(data):</a>
<a class="sourceLine" id="cb9-5" title="5">        <span class="cf">if</span> dat[<span class="st">&quot;targetPeak&quot;</span>] <span class="op">==</span> <span class="fl">1.0</span>:</a>
<a class="sourceLine" id="cb9-6" title="6">            <span class="cf">continue</span></a>
<a class="sourceLine" id="cb9-7" title="7">        damping <span class="op">=</span> np.array(dat[<span class="st">&quot;c&quot;</span>])</a>
<a class="sourceLine" id="cb9-8" title="8">        spring <span class="op">=</span> np.array(dat[<span class="st">&quot;k&quot;</span>])</a>
<a class="sourceLine" id="cb9-9" title="9">        peak <span class="op">=</span> np.array(dat[<span class="st">&quot;peak&quot;</span>])</a>
<a class="sourceLine" id="cb9-10" title="10">        pyplot.plot(</a>
<a class="sourceLine" id="cb9-11" title="11">            damping,</a>
<a class="sourceLine" id="cb9-12" title="12">            <span class="dv">1</span> <span class="op">-</span> spring,</a>
<a class="sourceLine" id="cb9-13" title="13">            lw<span class="op">=</span><span class="dv">1</span>,</a>
<a class="sourceLine" id="cb9-14" title="14">            color<span class="op">=</span>cmapV(idx <span class="op">/</span> <span class="bu">len</span>(data)),</a>
<a class="sourceLine" id="cb9-15" title="15">            label<span class="op">=</span><span class="ss">f&quot;Peak=</span><span class="sc">{</span>dat[<span class="st">&#39;targetPeak&#39;</span>]<span class="sc">:g}</span><span class="ss">&quot;</span>)</a>
<a class="sourceLine" id="cb9-16" title="16">        kMin <span class="op">=</span> np.<span class="bu">min</span>(spring)</a>
<a class="sourceLine" id="cb9-17" title="17">        kMax <span class="op">=</span> np.<span class="bu">max</span>(spring)</a>
<a class="sourceLine" id="cb9-18" title="18">        y <span class="op">=</span> kMax <span class="op">-</span> (kMax <span class="op">-</span> kMin) <span class="op">*</span> np.arccos(<span class="dv">1</span> <span class="op">-</span> np.array(damping)) <span class="op">/</span> (np.pi <span class="op">/</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb9-19" title="19">        pyplot.plot(damping, <span class="dv">1</span> <span class="op">-</span> y, lw<span class="op">=</span><span class="dv">1</span>, ls<span class="op">=</span><span class="st">&quot;:&quot;</span>, color<span class="op">=</span>cmapP(idx <span class="op">/</span> <span class="bu">len</span>(data)))</a>
<a class="sourceLine" id="cb9-20" title="20">    pyplot.title(<span class="st">&quot;c-k Plot (dotted line is approximation)&quot;</span>)</a>
<a class="sourceLine" id="cb9-21" title="21">    pyplot.xlabel(<span class="st">&quot;c&quot;</span>)</a>
<a class="sourceLine" id="cb9-22" title="22">    pyplot.ylabel(<span class="st">&quot;1 - k&quot;</span>)</a>
<a class="sourceLine" id="cb9-23" title="23">    pyplot.yscale(<span class="st">&quot;log&quot;</span>)</a>
<a class="sourceLine" id="cb9-24" title="24">    pyplot.legend(ncol<span class="op">=</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb9-25" title="25">    pyplot.grid()</a>
<a class="sourceLine" id="cb9-26" title="26">    pyplot.tight_layout()</a>
<a class="sourceLine" id="cb9-27" title="27">    pyplot.show()</a>
<a class="sourceLine" id="cb9-28" title="28"></a>
<a class="sourceLine" id="cb9-29" title="29"><span class="cf">with</span> <span class="bu">open</span>(<span class="st">&quot;data.json&quot;</span>, <span class="st">&quot;r&quot;</span>) <span class="im">as</span> fi:</a>
<a class="sourceLine" id="cb9-30" title="30">    data <span class="op">=</span> json.load(fi)</a>
<a class="sourceLine" id="cb9-31" title="31"></a>
<a class="sourceLine" id="cb9-32" title="32">plotResonance(data)</a></code></pre></div>
<p>出力されたプロットです。実線は <code>data.json</code> からプロットした実データ、点線は近似曲線です。</p>
<figure>
<img src="img/CKPlot.png" alt="Image of ." style="padding-bottom: 12px;"/>
</figure>
<p>近似曲線は <span class="math inline">\(\arccos\)</span> を使って試行錯誤で作りました。ピークが小さくなるほど実際の特性からずれていますが、ピークが大きいときはよく近似できているのでシンセサイザで使う分には十分でした。</p>
<p>近似曲線の式です。</p>
<p><span class="math display">\[
\def{\kMin}{k_{\mathrm{Min}}}
\def{\kMax}{k_{\mathrm{Max}}}
k \approx \kMax - \frac{2}{\pi} (\kMax - \kMin) \arccos(1 - c)
\]</span></p>
<p>上の <span class="math inline">\(c \text{--} k\)</span> プロットでは <span class="math inline">\(k_{\mathrm{Min}}\)</span> と <span class="math inline">\(k_{\mathrm{Max}}\)</span> を実データから取得して近似曲線を計算しています。 DSP の計算中には実データは使えないので <span class="math inline">\(k_{\mathrm{Min}}\)</span> と <span class="math inline">\(k_{\mathrm{Max}}\)</span> の近似曲線を作ります。</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb10-1" title="1"><span class="kw">def</span> plotSpringMinMax(data):</a>
<a class="sourceLine" id="cb10-2" title="2">    kMin <span class="op">=</span> []</a>
<a class="sourceLine" id="cb10-3" title="3">    kMax <span class="op">=</span> []</a>
<a class="sourceLine" id="cb10-4" title="4">    target <span class="op">=</span> []</a>
<a class="sourceLine" id="cb10-5" title="5">    <span class="cf">for</span> idx, dat <span class="kw">in</span> <span class="bu">enumerate</span>(data):</a>
<a class="sourceLine" id="cb10-6" title="6">        damping <span class="op">=</span> dat[<span class="st">&quot;c&quot;</span>]</a>
<a class="sourceLine" id="cb10-7" title="7">        spring <span class="op">=</span> dat[<span class="st">&quot;k&quot;</span>]</a>
<a class="sourceLine" id="cb10-8" title="8">        peak <span class="op">=</span> dat[<span class="st">&quot;peak&quot;</span>]</a>
<a class="sourceLine" id="cb10-9" title="9">        target.append(dat[<span class="st">&quot;targetPeak&quot;</span>])</a>
<a class="sourceLine" id="cb10-10" title="10">        kMin.append(np.<span class="bu">min</span>(spring))</a>
<a class="sourceLine" id="cb10-11" title="11">        kMax.append(np.<span class="bu">max</span>(spring))</a>
<a class="sourceLine" id="cb10-12" title="12">    <span class="co">#</span></a>
<a class="sourceLine" id="cb10-13" title="13">    <span class="co"># kMin plot.</span></a>
<a class="sourceLine" id="cb10-14" title="14">    resonance <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1024</span>)</a>
<a class="sourceLine" id="cb10-15" title="15">    alpha <span class="op">=</span> np.log(<span class="dv">1</span> <span class="op">-</span> kMin[<span class="op">-</span><span class="dv">1</span>])</a>
<a class="sourceLine" id="cb10-16" title="16">    y <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> np.exp(alpha <span class="op">*</span> resonance)</a>
<a class="sourceLine" id="cb10-17" title="17">    <span class="bu">print</span>(alpha)</a>
<a class="sourceLine" id="cb10-18" title="18">    pyplot.plot(</a>
<a class="sourceLine" id="cb10-19" title="19">        resonance, y, zorder<span class="op">=</span><span class="dv">3</span>, alpha<span class="op">=</span><span class="fl">0.75</span>, color<span class="op">=</span><span class="st">&quot;#00ff00&quot;</span>, label<span class="op">=</span><span class="st">&quot;approx.&quot;</span>)</a>
<a class="sourceLine" id="cb10-20" title="20">    fitX <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">1</span>, <span class="bu">len</span>(kMin))</a>
<a class="sourceLine" id="cb10-21" title="21">    pyplot.plot(fitX, kMin, lw<span class="op">=</span><span class="dv">4</span>, zorder<span class="op">=</span><span class="dv">2</span>, color<span class="op">=</span><span class="st">&quot;black&quot;</span>, label<span class="op">=</span><span class="st">&quot;kMin&quot;</span>)</a>
<a class="sourceLine" id="cb10-22" title="22">    pyplot.title(<span class="st">&quot;k_Min-Resonance Plot&quot;</span>)</a>
<a class="sourceLine" id="cb10-23" title="23">    pyplot.xlabel(<span class="st">&quot;Resonance&quot;</span>)</a>
<a class="sourceLine" id="cb10-24" title="24">    pyplot.ylabel(<span class="st">&quot;k&quot;</span>)</a>
<a class="sourceLine" id="cb10-25" title="25">    pyplot.grid()</a>
<a class="sourceLine" id="cb10-26" title="26">    pyplot.legend()</a>
<a class="sourceLine" id="cb10-27" title="27">    pyplot.show()</a>
<a class="sourceLine" id="cb10-28" title="28">    <span class="co">#</span></a>
<a class="sourceLine" id="cb10-29" title="29">    <span class="co"># KMax plot.</span></a>
<a class="sourceLine" id="cb10-30" title="30">    resonance <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1024</span>)</a>
<a class="sourceLine" id="cb10-31" title="31">    offset <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> kMin[<span class="op">-</span><span class="dv">1</span>]</a>
<a class="sourceLine" id="cb10-32" title="32">    alpha <span class="op">=</span> np.log(offset)</a>
<a class="sourceLine" id="cb10-33" title="33">    y <span class="op">=</span> kMax[<span class="op">-</span><span class="dv">1</span>] <span class="op">-</span> <span class="fl">0.01</span> <span class="op">*</span> (np.exp(alpha <span class="op">*</span> resonance) <span class="op">-</span> offset)</a>
<a class="sourceLine" id="cb10-34" title="34">    pyplot.plot(</a>
<a class="sourceLine" id="cb10-35" title="35">        resonance, y, zorder<span class="op">=</span><span class="dv">3</span>, alpha<span class="op">=</span><span class="fl">0.75</span>, color<span class="op">=</span><span class="st">&quot;#00ff00&quot;</span>, label<span class="op">=</span><span class="st">&quot;approx.&quot;</span>)</a>
<a class="sourceLine" id="cb10-36" title="36">    <span class="bu">print</span>(kMax[<span class="op">-</span><span class="dv">1</span>], alpha, offset)</a>
<a class="sourceLine" id="cb10-37" title="37">    pyplot.plot(fitX, kMax, lw<span class="op">=</span><span class="dv">4</span>, zorder<span class="op">=</span><span class="dv">2</span>, color<span class="op">=</span><span class="st">&quot;black&quot;</span>, label<span class="op">=</span><span class="st">&quot;kMax&quot;</span>)</a>
<a class="sourceLine" id="cb10-38" title="38">    pyplot.title(<span class="st">&quot;k_Max-Resonance Plot&quot;</span>)</a>
<a class="sourceLine" id="cb10-39" title="39">    pyplot.xlabel(<span class="st">&quot;Resonance&quot;</span>)</a>
<a class="sourceLine" id="cb10-40" title="40">    pyplot.ylabel(<span class="st">&quot;k&quot;</span>)</a>
<a class="sourceLine" id="cb10-41" title="41">    pyplot.grid(zorder<span class="op">=</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb10-42" title="42">    pyplot.legend()</a>
<a class="sourceLine" id="cb10-43" title="43">    pyplot.tight_layout()</a>
<a class="sourceLine" id="cb10-44" title="44">    pyplot.show()</a>
<a class="sourceLine" id="cb10-45" title="45"></a>
<a class="sourceLine" id="cb10-46" title="46">plotSpringMinMax(data)</a></code></pre></div>
<p>出力されたプロットです。黒い線が実データ、緑の線 <code>approx.</code> は近似曲線です。</p>
<figure>
<img src="img/kMinResonancePlot.png" alt="Image of ." style="padding-bottom: 12px;"/>
</figure>
<figure>
<img src="img/kMaxResonancePlot.png" alt="Image of ." style="padding-bottom: 12px;"/>
</figure>
<p><span class="math inline">\(k_{\mathrm{Min}}\)</span> の近似曲線の式です。 <span class="math inline">\(\mathtt{resonance}\)</span> はユーザが指定するレゾナンスの値で、範囲は <span class="math inline">\([0, 1]\)</span> です。</p>
<p><span class="math display">\[
k_{\mathrm{Min}} = 1 - \exp(-5.6852537097945195 \cdot \mathtt{resonance})
\]</span></p>
<p><span class="math inline">\(k_{\mathrm{Max}}}\)</span> の近似曲線の式です。</p>
<p><span class="math display">\[
\begin{aligned}
k_{\mathrm{Max}} =&amp; 0.9999771732485103 \\
  &amp;- 0.01 \cdot (\exp(-5.6852537097945195 \cdot \mathtt{resonance}) - 0.0033956716251850594)
\end{aligned}
\]</span></p>
<p>これでレゾナンスのチューニングができました。 C++ で実装します。</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb11-1" title="1"><span class="pp">#include </span><span class="im">&lt;algorithm&gt;</span></a>
<a class="sourceLine" id="cb11-2" title="2"><span class="pp">#include </span><span class="im">&lt;cmath&gt;</span></a>
<a class="sourceLine" id="cb11-3" title="3"></a>
<a class="sourceLine" id="cb11-4" title="4"><span class="kw">constexpr</span> <span class="dt">double</span> halfpi = <span class="fl">1.57079632679489661923</span>;</a>
<a class="sourceLine" id="cb11-5" title="5"></a>
<a class="sourceLine" id="cb11-6" title="6"><span class="dt">float</span> resonanceToK(<span class="dt">float</span> c, <span class="dt">float</span> resonance, <span class="dt">bool</span> uniformPeak)</a>
<a class="sourceLine" id="cb11-7" title="7">{</a>
<a class="sourceLine" id="cb11-8" title="8">  <span class="dt">float</span> kExp = expf(<span class="dt">float</span>(-<span class="fl">5.6852537097945195</span>) * resonance);</a>
<a class="sourceLine" id="cb11-9" title="9">  <span class="dt">float</span> kMin = <span class="dt">float</span>(<span class="dv">1</span>) - kExp;</a>
<a class="sourceLine" id="cb11-10" title="10">  <span class="dt">float</span> kMax = <span class="dt">float</span>(<span class="fl">0.9999771732485103</span>)</a>
<a class="sourceLine" id="cb11-11" title="11">    - <span class="dt">float</span>(<span class="fl">0.01</span>) * (kExp - <span class="dt">float</span>(<span class="fl">0.0033956716251850594</span>));</a>
<a class="sourceLine" id="cb11-12" title="12">  <span class="cf">return</span> kMax - (kMax - kMin) * acosf(<span class="dt">float</span>(<span class="dv">1</span>) - c) / <span class="dt">float</span>(halfpi);</a>
<a class="sourceLine" id="cb11-13" title="13">}</a></code></pre></div>
<h2 id="ハイパスのカットオフ周波数のチューニング">ハイパスのカットオフ周波数のチューニング</h2>
<p>カットオフ周波数とレゾナンスのチューニングを終えて、プラグインにして試していると直流が乗ることに気がついたので <span class="math inline">\(\alpha\)</span> を追加しました。 <span class="math inline">\(\alpha\)</span> を変えるとハイパスフィルタのカットオフ周波数が変わるようです。</p>
<p>ローパスのカットオフ周波数とチューニングの手順は同じなので結果だけ掲載します。</p>
<p>カットオフ周波数 <span class="math inline">\(\omega_c\)</span> に対応する <span class="math inline">\(\alpha\)</span> の値のプロットです。丸い点が実データ、 曲線は指数関数を使って <a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.curve_fit.html"><code>scipy.optimize.curve_fit</code></a> で求めた近似です。</p>
<figure>
<img src="img/HighpassCutoffPlot.png" alt="Image of α-ω_c plot." style="padding-bottom: 12px;"/>
</figure>
<p><code>expfit</code> の式です。</p>
<p><span class="math display">\[
\alpha = 0.5638865655409118 + 0.43611343445908823 \cdot \exp(-6.501239408777854 x)
\]</span></p>
<p>カットオフを -3 dB から -6 dB に変えたときの式も求めました。こちらのほうが <span class="math inline">\(\alpha\)</span> の範囲を広く使えます。</p>
<p><span class="math display">\[
\alpha = 0.39299084333814804 + 0.607009156661852 \cdot \exp(-4.939791161282682 x)
\]</span></p>
<h2 id="実装">実装</h2>
<p>C++ による実装例です。</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb12-1" title="1"><span class="pp">#include </span><span class="im">&lt;algorithm&gt;</span></a>
<a class="sourceLine" id="cb12-2" title="2"><span class="pp">#include </span><span class="im">&lt;cmath&gt;</span></a>
<a class="sourceLine" id="cb12-3" title="3"></a>
<a class="sourceLine" id="cb12-4" title="4"><span class="kw">template</span>&lt;<span class="kw">typename</span> Sample&gt; <span class="kw">class</span> LP3 {</a>
<a class="sourceLine" id="cb12-5" title="5"><span class="kw">public</span>:</a>
<a class="sourceLine" id="cb12-6" title="6">  <span class="dt">void</span> reset() { acc = vel = pos = x1 = <span class="dv">0</span>; }</a>
<a class="sourceLine" id="cb12-7" title="7"></a>
<a class="sourceLine" id="cb12-8" title="8">  <span class="dt">void</span> set(</a>
<a class="sourceLine" id="cb12-9" title="9">    Sample sampleRate,</a>
<a class="sourceLine" id="cb12-10" title="10">    Sample lowpassHz,</a>
<a class="sourceLine" id="cb12-11" title="11">    Sample highpassHz,</a>
<a class="sourceLine" id="cb12-12" title="12">    Sample resonance,</a>
<a class="sourceLine" id="cb12-13" title="13">    <span class="dt">bool</span> uniformPeak,</a>
<a class="sourceLine" id="cb12-14" title="14">    <span class="dt">bool</span> uniformGain)</a>
<a class="sourceLine" id="cb12-15" title="15">  {</a>
<a class="sourceLine" id="cb12-16" title="16">    Sample x = lowpassHz / sampleRate;</a>
<a class="sourceLine" id="cb12-17" title="17">    c = Sample(<span class="fl">56.85341479156533</span>)   * x * x * x * x * x * x</a>
<a class="sourceLine" id="cb12-18" title="18">      + Sample(-<span class="fl">60.92051508862034</span>)  * x * x * x * x * x</a>
<a class="sourceLine" id="cb12-19" title="19">      + Sample(-<span class="fl">1.6515635438744682</span>) * x * x * x * x</a>
<a class="sourceLine" id="cb12-20" title="20">      + Sample(<span class="fl">31.558896956675998</span>)  * x * x * x</a>
<a class="sourceLine" id="cb12-21" title="21">      + Sample(-<span class="fl">20.61402812645397</span>)  * x * x</a>
<a class="sourceLine" id="cb12-22" title="22">      + Sample(<span class="fl">6.320753515093109</span>)   * x;</a>
<a class="sourceLine" id="cb12-23" title="23"></a>
<a class="sourceLine" id="cb12-24" title="24">    <span class="cf">if</span> (uniformPeak) {</a>
<a class="sourceLine" id="cb12-25" title="25">      Sample kExp = exp(Sample(-<span class="fl">5.6852537097945195</span>) * resonance);</a>
<a class="sourceLine" id="cb12-26" title="26">      Sample kMin = Sample(<span class="dv">1</span>) - kExp;</a>
<a class="sourceLine" id="cb12-27" title="27">      Sample kMax = Sample(<span class="fl">0.9999771732485103</span>)</a>
<a class="sourceLine" id="cb12-28" title="28">        - Sample(<span class="fl">0.01</span>) * (kExp - Sample(<span class="fl">0.0033956716251850594</span>));</a>
<a class="sourceLine" id="cb12-29" title="29">      k = kMax - (kMax - kMin) * acos(Sample(<span class="dv">1</span>) - c) / Sample(halfpi);</a>
<a class="sourceLine" id="cb12-30" title="30">    } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb12-31" title="31">      k = <span class="bu">std::</span>clamp&lt;Sample&gt;(resonance, Sample(<span class="dv">0</span>), Sample(<span class="dv">1</span> - <span class="fl">1e-5</span>));</a>
<a class="sourceLine" id="cb12-32" title="32">    }</a>
<a class="sourceLine" id="cb12-33" title="33"></a>
<a class="sourceLine" id="cb12-34" title="34">    alpha = Sample(<span class="fl">0.5638865655409118</span>)</a>
<a class="sourceLine" id="cb12-35" title="35">      + Sample(<span class="fl">0.43611343445908823</span>) * exp(Sample(-<span class="fl">6.501239408777854</span>) * x);</a>
<a class="sourceLine" id="cb12-36" title="36"></a>
<a class="sourceLine" id="cb12-37" title="37">    <span class="kw">this</span>-&gt;uniformGain = uniformGain;</a>
<a class="sourceLine" id="cb12-38" title="38">  }</a>
<a class="sourceLine" id="cb12-39" title="39"></a>
<a class="sourceLine" id="cb12-40" title="40">  Sample process(Sample x0)</a>
<a class="sourceLine" id="cb12-41" title="41">  {</a>
<a class="sourceLine" id="cb12-42" title="42">    acc = k * acc + c * vel;</a>
<a class="sourceLine" id="cb12-43" title="43">    vel -= acc + x0 - x1;</a>
<a class="sourceLine" id="cb12-44" title="44">    pos -= (uniformGain ? c / (<span class="dv">1</span> - k) : c) * vel;</a>
<a class="sourceLine" id="cb12-45" title="45"></a>
<a class="sourceLine" id="cb12-46" title="46">    pos *= Sample(alpha);</a>
<a class="sourceLine" id="cb12-47" title="47"></a>
<a class="sourceLine" id="cb12-48" title="48">    x1 = x0;</a>
<a class="sourceLine" id="cb12-49" title="49">    <span class="cf">return</span> pos;</a>
<a class="sourceLine" id="cb12-50" title="50">  }</a>
<a class="sourceLine" id="cb12-51" title="51"></a>
<a class="sourceLine" id="cb12-52" title="52"><span class="kw">private</span>:</a>
<a class="sourceLine" id="cb12-53" title="53">  Sample c = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb12-54" title="54">  Sample k = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb12-55" title="55">  Sample alpha = <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb12-56" title="56">  <span class="dt">bool</span> uniformGain = <span class="kw">true</span>;</a>
<a class="sourceLine" id="cb12-57" title="57"></a>
<a class="sourceLine" id="cb12-58" title="58">  Sample acc = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb12-59" title="59">  Sample vel = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb12-60" title="60">  Sample pos = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb12-61" title="61">  Sample x1 = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb12-62" title="62">};</a></code></pre></div>
<p>LV2 プラグインとして実装したフィルタのコードへのリンクです。</p>
<ul>
<li><a href="https://github.com/ryukau/LV2Plugins/blob/master/lv2cvport/CV_3PoleLP/dsp/lp3.hpp">LV2Plugins/lp3.hpp at master · ryukau/LV2Plugins · GitHub</a></li>
</ul>
<h2 id="音のサンプル">音のサンプル</h2>
<p>フィルタの音のサンプルです。</p>
<ul>
<li>入力は <code>scipy.signal.sawtooth</code> で生成した 45 Hz の鋸歯波。</li>
<li>ローパスのカットオフ周波数を減衰するエンベロープで変調。</li>
<li>音量は絶対値の最大値が 1 になるように正規化。</li>
<li>ハイパスのカットオフ周波数は 20 Hz 。</li>
<li><code>uniformGain</code> は False 。</li>
</ul>
<h3 id="指数カーブのカットオフ">指数カーブのカットオフ</h3>
<figure>
<figcaption>
exp, uniformPeak=False, resonance=0.0
</figcaption>
<audio controls>
<source src="snd/exp_uniformPeakFalse_resonance0.0.wav" type="audio/wav">
</audio>
</figure>
<figure>
<figcaption>
exp, uniformPeak=False, resonance=0.5
</figcaption>
<audio controls>
<source src="snd/exp_uniformPeakFalse_resonance0.5.wav" type="audio/wav">
</audio>
</figure>
<figure>
<figcaption>
exp, uniformPeak=False, resonance=0.9
</figcaption>
<audio controls>
<source src="snd/exp_uniformPeakFalse_resonance0.9.wav" type="audio/wav">
</audio>
</figure>
<figure>
<figcaption>
exp, uniformPeak=True, resonance=0.0
</figcaption>
<audio controls>
<source src="snd/exp_uniformPeakTrue_resonance0.0.wav" type="audio/wav">
</audio>
</figure>
<figure>
<figcaption>
exp, uniformPeak=True, resonance=0.5
</figcaption>
<audio controls>
<source src="snd/exp_uniformPeakTrue_resonance0.5.wav" type="audio/wav">
</audio>
</figure>
<figure>
<figcaption>
exp, uniformPeak=True, resonance=0.9
</figcaption>
<audio controls>
<source src="snd/exp_uniformPeakTrue_resonance0.9.wav" type="audio/wav">
</audio>
</figure>
<h3 id="直線のカットオフ">直線のカットオフ</h3>
<figure>
<figcaption>
lin, uniformPeak=False, resonance=0.0
</figcaption>
<audio controls>
<source src="snd/lin_uniformPeakFalse_resonance0.0.wav" type="audio/wav">
</audio>
</figure>
<figure>
<figcaption>
lin, uniformPeak=False, resonance=0.5
</figcaption>
<audio controls>
<source src="snd/lin_uniformPeakFalse_resonance0.5.wav" type="audio/wav">
</audio>
</figure>
<figure>
<figcaption>
lin, uniformPeak=False, resonance=0.9
</figcaption>
<audio controls>
<source src="snd/lin_uniformPeakFalse_resonance0.9.wav" type="audio/wav">
</audio>
</figure>
<figure>
<figcaption>
lin, uniformPeak=True, resonance=0.0
</figcaption>
<audio controls>
<source src="snd/lin_uniformPeakTrue_resonance0.0.wav" type="audio/wav">
</audio>
</figure>
<figure>
<figcaption>
lin, uniformPeak=True, resonance=0.5
</figcaption>
<audio controls>
<source src="snd/lin_uniformPeakTrue_resonance0.5.wav" type="audio/wav">
</audio>
</figure>
<figure>
<figcaption>
lin, uniformPeak=True, resonance=0.9
</figcaption>
<audio controls>
<source src="snd/lin_uniformPeakTrue_resonance0.9.wav" type="audio/wav">
</audio>
</figure>
<h2 id="その他">その他</h2>
<p><span class="math inline">\(\arccos\)</span> を使った近似曲線は <span class="math inline">\(\dfrac{b_0 + b_1 x + b_2 x^2 \dots}{a_0 + a_1 x + a_2 x^2 \dots}\)</span> という形の分数でも近似できそうです。</p>
<p>レゾナンスのチューニングは計算が重たいので、効率を重視するなら省略できます。</p>
<p>ポリフォニックシンセでノートオンごとにフィルタの状態をリセットするとき、ローパスしか使わないなら <span class="math inline">\(\alpha\)</span> を 1 に固定して処理を減らせます。</p>
<p>FL Studio で使える Fast LP と似たような音が出ます。</p>
<footer>
<a href="../index.html">インデックスに戻る</a>
</footer>
</body>

</html>
